!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(require("@firebase/app-compat"),require("@firebase/app")):"function"==typeof define&&define.amd?define(["@firebase/app-compat","@firebase/app"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).firebase,e.firebase.INTERNAL.modularAPIs)}(this,(function(e,t){"use strict";try{(function(){var n,r,i=(r=e)&&"object"==typeof r&&"default"in r?r:{default:r};function s(e){const t=[];let n=0;for(let r=0;r<e.length;r++){let i=e.charCodeAt(r);i<128?t[n++]=i:(i<2048?t[n++]=i>>6|192:(55296==(64512&i)&&r+1<e.length&&56320==(64512&e.charCodeAt(r+1))?(i=65536+((1023&i)<<10)+(1023&e.charCodeAt(++r)),t[n++]=i>>18|240,t[n++]=i>>12&63|128):t[n++]=i>>12|224,t[n++]=i>>6&63|128),t[n++]=63&i|128)}return t}const a={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray(e,t){if(!Array.isArray(e))throw Error("encodeByteArray takes an array as a parameter");this.init_();var n=t?this.byteToCharMapWebSafe_:this.byteToCharMap_;const r=[];for(let t=0;t<e.length;t+=3){var i=e[t],s=t+1<e.length,a=s?e[t+1]:0,o=t+2<e.length,u=o?e[t+2]:0;let c=(15&a)<<2|u>>6,h=63&u;o||(h=64,s||(c=64)),r.push(n[i>>2],n[(3&i)<<4|a>>4],n[c],n[h])}return r.join("")},encodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(e):this.encodeByteArray(s(e),t)},decodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?atob(e):function(e){const t=[];let n=0,r=0;for(;n<e.length;){var i,s,a=e[n++];a<128?t[r++]=String.fromCharCode(a):191<a&&a<224?(i=e[n++],t[r++]=String.fromCharCode((31&a)<<6|63&i)):239<a&&a<365?(s=((7&a)<<18|(63&e[n++])<<12|(63&e[n++])<<6|63&e[n++])-65536,t[r++]=String.fromCharCode(55296+(s>>10)),t[r++]=String.fromCharCode(56320+(1023&s))):(i=e[n++],s=e[n++],t[r++]=String.fromCharCode((15&a)<<12|(63&i)<<6|63&s))}return t.join("")}(this.decodeStringToByteArray(e,t))},decodeStringToByteArray(e,t){this.init_();var n=t?this.charToByteMapWebSafe_:this.charToByteMap_;const r=[];for(let t=0;t<e.length;){var i=n[e.charAt(t++)],s=t<e.length?n[e.charAt(t)]:0;++t;var a=t<e.length?n[e.charAt(t)]:64;++t;var u=t<e.length?n[e.charAt(t)]:64;if(++t,null==i||null==s||null==a||null==u)throw new o;r.push(i<<2|s>>4),64!==a&&(r.push(s<<4&240|a>>2),64!==u&&r.push(a<<6&192|u))}return r},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let e=0;e<this.ENCODED_VALS.length;e++)this.byteToCharMap_[e]=this.ENCODED_VALS.charAt(e),this.charToByteMap_[this.byteToCharMap_[e]]=e,this.byteToCharMapWebSafe_[e]=this.ENCODED_VALS_WEBSAFE.charAt(e),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[e]]=e,e>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(e)]=e,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(e)]=e)}}};class o extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}}const u=function(e){return t=s(e),a.encodeByteArray(t,!0).replace(/\./g,"");var t};function c(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""}function h(){return!function(){var e=null===(e=(()=>{try{return function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("Unable to locate global object.")}().__FIREBASE_DEFAULTS__||(()=>{if("undefined"!=typeof process&&void 0!==process.env){var e=process.env.__FIREBASE_DEFAULTS__;return e?JSON.parse(e):void 0}})()||(()=>{if("undefined"!=typeof document){let t;try{t=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch(e){return}var e=t&&function(e){try{return a.decodeString(e,!0)}catch(e){console.error("base64Decode failed: ",e)}return null}(t[1]);return e&&JSON.parse(e)}})()}catch(e){return void console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${e}`)}})())||void 0===e?void 0:e.forceEnvironment;if("node"===e)return 1;if("browser"!==e)try{return"[object process]"===Object.prototype.toString.call(global.process)}catch(e){return}}()&&navigator.userAgent&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")}class l extends Error{constructor(e,t,n){super(t),this.code=e,this.customData=n,this.name="FirebaseError",Object.setPrototypeOf(this,l.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,d.prototype.create)}}class d{constructor(e,t,n){this.service=e,this.serviceName=t,this.errors=n}create(e,...t){var n,r=t[0]||{},i=`${this.service}/${e}`,s=(s=this.errors[e])?(n=r,s.replace(f,((e,t)=>{var r=n[t];return null!=r?String(r):`<${t}?>`}))):"Error";return s=`${this.serviceName}: ${s} (${i}).`,new l(i,s,r)}}const f=/\{\$([^}]+)}/g;function g(e,t){if(e===t)return!0;const n=Object.keys(e),r=Object.keys(t);for(const a of n){if(!r.includes(a))return!1;var i=e[a],s=t[a];if(m(i)&&m(s)){if(!g(i,s))return!1}else if(i!==s)return!1}for(const e of r)if(!n.includes(e))return!1;return!0}function m(e){return null!==e&&"object"==typeof e}function p(e){return e&&e._delegate?e._delegate:e}class y{constructor(e,t,n){this.name=e,this.instanceFactory=t,this.type=n,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(e){return this.instantiationMode=e,this}setMultipleInstances(e){return this.multipleInstances=e,this}setServiceProps(e){return this.serviceProps=e,this}setInstanceCreatedCallback(e){return this.onInstanceCreated=e,this}}(Xu=n=n||{})[Xu.DEBUG=0]="DEBUG",Xu[Xu.VERBOSE=1]="VERBOSE",Xu[Xu.INFO=2]="INFO",Xu[Xu.WARN=3]="WARN",Xu[Xu.ERROR=4]="ERROR",Xu[Xu.SILENT=5]="SILENT";const v={debug:n.DEBUG,verbose:n.VERBOSE,info:n.INFO,warn:n.WARN,error:n.ERROR,silent:n.SILENT},w=n.INFO,_={[n.DEBUG]:"log",[n.VERBOSE]:"log",[n.INFO]:"info",[n.WARN]:"warn",[n.ERROR]:"error"},b=(e,t,...n)=>{if(!(t<e.logLevel)){var r=(new Date).toISOString(),i=_[t];if(!i)throw new Error(`Attempted to log a message with an invalid logType (value: ${t})`);console[i](`[${r}]  ${e.name}:`,...n)}};var I,E,T="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};(function(){var e,t,n;function r(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.B=Array(this.blockSize),this.o=this.h=0,this.s()}function i(){}function s(e,t,n){n=n||0;var r=Array(16);if("string"==typeof t)for(var i=0;i<16;++i)r[i]=t.charCodeAt(n++)|t.charCodeAt(n++)<<8|t.charCodeAt(n++)<<16|t.charCodeAt(n++)<<24;else for(i=0;i<16;++i)r[i]=t[n++]|t[n++]<<8|t[n++]<<16|t[n++]<<24;t=e.g[0],n=e.g[1],i=e.g[2];var s=e.g[3],a=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=n+((a=t+(s^n&(i^s))+r[0]+3614090360&4294967295)<<7&4294967295|a>>>25))+((a=s+(i^t&(n^i))+r[1]+3905402710&4294967295)<<12&4294967295|a>>>20))+((a=i+(n^s&(t^n))+r[2]+606105819&4294967295)<<17&4294967295|a>>>15))+((a=n+(t^i&(s^t))+r[3]+3250441966&4294967295)<<22&4294967295|a>>>10))+((a=t+(s^n&(i^s))+r[4]+4118548399&4294967295)<<7&4294967295|a>>>25))+((a=s+(i^t&(n^i))+r[5]+1200080426&4294967295)<<12&4294967295|a>>>20))+((a=i+(n^s&(t^n))+r[6]+2821735955&4294967295)<<17&4294967295|a>>>15))+((a=n+(t^i&(s^t))+r[7]+4249261313&4294967295)<<22&4294967295|a>>>10))+((a=t+(s^n&(i^s))+r[8]+1770035416&4294967295)<<7&4294967295|a>>>25))+((a=s+(i^t&(n^i))+r[9]+2336552879&4294967295)<<12&4294967295|a>>>20))+((a=i+(n^s&(t^n))+r[10]+4294925233&4294967295)<<17&4294967295|a>>>15))+((a=n+(t^i&(s^t))+r[11]+2304563134&4294967295)<<22&4294967295|a>>>10))+((a=t+(s^n&(i^s))+r[12]+1804603682&4294967295)<<7&4294967295|a>>>25))+((a=s+(i^t&(n^i))+r[13]+4254626195&4294967295)<<12&4294967295|a>>>20))+((a=i+(n^s&(t^n))+r[14]+2792965006&4294967295)<<17&4294967295|a>>>15))+((a=n+(t^i&(s^t))+r[15]+1236535329&4294967295)<<22&4294967295|a>>>10))+((a=t+(i^s&(n^i))+r[1]+4129170786&4294967295)<<5&4294967295|a>>>27))+((a=s+(n^i&(t^n))+r[6]+3225465664&4294967295)<<9&4294967295|a>>>23))+((a=i+(t^n&(s^t))+r[11]+643717713&4294967295)<<14&4294967295|a>>>18))+((a=n+(s^t&(i^s))+r[0]+3921069994&4294967295)<<20&4294967295|a>>>12))+((a=t+(i^s&(n^i))+r[5]+3593408605&4294967295)<<5&4294967295|a>>>27))+((a=s+(n^i&(t^n))+r[10]+38016083&4294967295)<<9&4294967295|a>>>23))+((a=i+(t^n&(s^t))+r[15]+3634488961&4294967295)<<14&4294967295|a>>>18))+((a=n+(s^t&(i^s))+r[4]+3889429448&4294967295)<<20&4294967295|a>>>12))+((a=t+(i^s&(n^i))+r[9]+568446438&4294967295)<<5&4294967295|a>>>27))+((a=s+(n^i&(t^n))+r[14]+3275163606&4294967295)<<9&4294967295|a>>>23))+((a=i+(t^n&(s^t))+r[3]+4107603335&4294967295)<<14&4294967295|a>>>18))+((a=n+(s^t&(i^s))+r[8]+1163531501&4294967295)<<20&4294967295|a>>>12))+((a=t+(i^s&(n^i))+r[13]+2850285829&4294967295)<<5&4294967295|a>>>27))+((a=s+(n^i&(t^n))+r[2]+4243563512&4294967295)<<9&4294967295|a>>>23))+((a=i+(t^n&(s^t))+r[7]+1735328473&4294967295)<<14&4294967295|a>>>18))+((a=n+(s^t&(i^s))+r[12]+2368359562&4294967295)<<20&4294967295|a>>>12))+((a=t+(n^i^s)+r[5]+4294588738&4294967295)<<4&4294967295|a>>>28))+((a=s+(t^n^i)+r[8]+2272392833&4294967295)<<11&4294967295|a>>>21))+((a=i+(s^t^n)+r[11]+1839030562&4294967295)<<16&4294967295|a>>>16))+((a=n+(i^s^t)+r[14]+4259657740&4294967295)<<23&4294967295|a>>>9))+((a=t+(n^i^s)+r[1]+2763975236&4294967295)<<4&4294967295|a>>>28))+((a=s+(t^n^i)+r[4]+1272893353&4294967295)<<11&4294967295|a>>>21))+((a=i+(s^t^n)+r[7]+4139469664&4294967295)<<16&4294967295|a>>>16))+((a=n+(i^s^t)+r[10]+3200236656&4294967295)<<23&4294967295|a>>>9))+((a=t+(n^i^s)+r[13]+681279174&4294967295)<<4&4294967295|a>>>28))+((a=s+(t^n^i)+r[0]+3936430074&4294967295)<<11&4294967295|a>>>21))+((a=i+(s^t^n)+r[3]+3572445317&4294967295)<<16&4294967295|a>>>16))+((a=n+(i^s^t)+r[6]+76029189&4294967295)<<23&4294967295|a>>>9))+((a=t+(n^i^s)+r[9]+3654602809&4294967295)<<4&4294967295|a>>>28))+((a=s+(t^n^i)+r[12]+3873151461&4294967295)<<11&4294967295|a>>>21))+((a=i+(s^t^n)+r[15]+530742520&4294967295)<<16&4294967295|a>>>16))+((a=n+(i^s^t)+r[2]+3299628645&4294967295)<<23&4294967295|a>>>9))+((a=t+(i^(n|~s))+r[0]+4096336452&4294967295)<<6&4294967295|a>>>26))+((a=s+(n^(t|~i))+r[7]+1126891415&4294967295)<<10&4294967295|a>>>22))+((a=i+(t^(s|~n))+r[14]+2878612391&4294967295)<<15&4294967295|a>>>17))+((a=n+(s^(i|~t))+r[5]+4237533241&4294967295)<<21&4294967295|a>>>11))+((a=t+(i^(n|~s))+r[12]+1700485571&4294967295)<<6&4294967295|a>>>26))+((a=s+(n^(t|~i))+r[3]+2399980690&4294967295)<<10&4294967295|a>>>22))+((a=i+(t^(s|~n))+r[10]+4293915773&4294967295)<<15&4294967295|a>>>17))+((a=n+(s^(i|~t))+r[1]+2240044497&4294967295)<<21&4294967295|a>>>11))+((a=t+(i^(n|~s))+r[8]+1873313359&4294967295)<<6&4294967295|a>>>26))+((a=s+(n^(t|~i))+r[15]+4264355552&4294967295)<<10&4294967295|a>>>22))+((a=i+(t^(s|~n))+r[6]+2734768916&4294967295)<<15&4294967295|a>>>17))+((a=n+(s^(i|~t))+r[13]+1309151649&4294967295)<<21&4294967295|a>>>11))+((s=(t=n+((a=t+(i^(n|~s))+r[4]+4149444226&4294967295)<<6&4294967295|a>>>26))+((a=s+(n^(t|~i))+r[11]+3174756917&4294967295)<<10&4294967295|a>>>22))^((i=s+((a=i+(t^(s|~n))+r[2]+718787259&4294967295)<<15&4294967295|a>>>17))|~t))+r[9]+3951481745&4294967295;e.g[0]=e.g[0]+t&4294967295,e.g[1]=e.g[1]+(i+(a<<21&4294967295|a>>>11))&4294967295,e.g[2]=e.g[2]+i&4294967295,e.g[3]=e.g[3]+s&4294967295}function a(e,t){this.h=t;for(var n=[],r=!0,i=e.length-1;0<=i;i--){var s=0|e[i];r&&s==t||(n[i]=s,r=!1)}this.g=n}t=r,i.prototype=(n=function(){this.blockSize=-1}).prototype,t.D=n.prototype,t.prototype=new i,(t.prototype.constructor=t).C=function(e,t,r){for(var i=Array(arguments.length-2),s=2;s<arguments.length;s++)i[s-2]=arguments[s];return n.prototype[t].apply(e,i)},r.prototype.s=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.o=this.h=0},r.prototype.u=function(e,t){for(var n=(t=void 0===t?e.length:t)-this.blockSize,r=this.B,i=this.h,a=0;a<t;){if(0==i)for(;a<=n;)s(this,e,a),a+=this.blockSize;if("string"==typeof e){for(;a<t;)if(r[i++]=e.charCodeAt(a++),i==this.blockSize){s(this,r),i=0;break}}else for(;a<t;)if(r[i++]=e[a++],i==this.blockSize){s(this,r),i=0;break}}this.h=i,this.o+=t},r.prototype.v=function(){var e=Array((this.h<56?this.blockSize:2*this.blockSize)-this.h);e[0]=128;for(var t=1;t<e.length-8;++t)e[t]=0;var n=8*this.o;for(t=e.length-8;t<e.length;++t)e[t]=255&n,n/=256;for(this.u(e),e=Array(16),t=n=0;t<4;++t)for(var r=0;r<32;r+=8)e[n++]=this.g[t]>>>r&255;return e};var o={};function u(e){return-128<=e&&e<128?(t=e,n=function(e){return new a([0|e],e<0?-1:0)},r=o,Object.prototype.hasOwnProperty.call(r,t)?r[t]:r[t]=n(t)):new a([0|e],e<0?-1:0);var t,n,r}function c(e){if(isNaN(e)||!isFinite(e))return h;if(e<0)return m(c(-e));for(var t=[],n=1,r=0;n<=e;r++)t[r]=e/n|0,n*=4294967296;return new a(t,0)}var h=u(0),l=u(1),d=u(16777216);function f(e){if(0==e.h){for(var t=0;t<e.g.length;t++)if(0!=e.g[t])return;return 1}}function g(e){return-1==e.h}function m(e){for(var t=e.g.length,n=[],r=0;r<t;r++)n[r]=~e.g[r];return new a(n,~e.h).add(l)}function p(e,t){return e.add(m(t))}function y(e,t){for(;(65535&e[t])!=e[t];)e[t+1]+=e[t]>>>16,e[t]&=65535,t++}function v(e,t){this.g=e,this.h=t}function w(e,t){if(f(t))throw Error("division by zero");if(f(e))return new v(h,h);if(g(e))return t=w(m(e),t),new v(m(t.g),m(t.h));if(g(t))return t=w(e,m(t)),new v(m(t.g),t.h);if(30<e.g.length){if(g(e)||g(t))throw Error("slowDivide_ only works with positive integers.");for(var n=l,r=t;r.l(e)<=0;)n=_(n),r=_(r);var i=b(n,1),s=b(r,1);for(r=b(r,2),n=b(n,2);!f(r);){var a=s.add(r);a.l(e)<=0&&(i=i.add(n),s=a),r=b(r,1),n=b(n,1)}return t=p(e,i.j(t)),new v(i,t)}for(i=h;0<=e.l(t);){for(n=Math.max(1,Math.floor(e.m()/t.m())),r=(r=Math.ceil(Math.log(n)/Math.LN2))<=48?1:Math.pow(2,r-48),a=(s=c(n)).j(t);g(a)||0<a.l(e);)a=(s=c(n-=r)).j(t);f(s)&&(s=l),i=i.add(s),e=p(e,a)}return new v(i,e)}function _(e){for(var t=e.g.length+1,n=[],r=0;r<t;r++)n[r]=e.i(r)<<1|e.i(r-1)>>>31;return new a(n,e.h)}function b(e,t){var n=t>>5;t%=32;for(var r=e.g.length-n,i=[],s=0;s<r;s++)i[s]=0<t?e.i(s+n)>>>t|e.i(s+n+1)<<32-t:e.i(s+n);return new a(i,e.h)}(e=a.prototype).m=function(){if(g(this))return-m(this).m();for(var e=0,t=1,n=0;n<this.g.length;n++){var r=this.i(n);e+=(0<=r?r:4294967296+r)*t,t*=4294967296}return e},e.toString=function(e){if((e=e||10)<2||36<e)throw Error("radix out of range: "+e);if(f(this))return"0";if(g(this))return"-"+m(this).toString(e);for(var t=c(Math.pow(e,6)),n=this,r="";;){var i=w(n,t).g,s=((0<(n=p(n,i.j(t))).g.length?n.g[0]:n.h)>>>0).toString(e);if(f(n=i))return s+r;for(;s.length<6;)s="0"+s;r=s+r}},e.i=function(e){return e<0?0:e<this.g.length?this.g[e]:this.h},e.l=function(e){return g(e=p(this,e))?-1:f(e)?0:1},e.abs=function(){return g(this)?m(this):this},e.add=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],r=0,i=0;i<=t;i++){var s=r+(65535&this.i(i))+(65535&e.i(i)),o=(s>>>16)+(this.i(i)>>>16)+(e.i(i)>>>16);r=o>>>16,s&=65535,o&=65535,n[i]=o<<16|s}return new a(n,-2147483648&n[n.length-1]?-1:0)},e.j=function(e){if(f(this)||f(e))return h;if(g(this))return g(e)?m(this).j(m(e)):m(m(this).j(e));if(g(e))return m(this.j(m(e)));if(this.l(d)<0&&e.l(d)<0)return c(this.m()*e.m());for(var t=this.g.length+e.g.length,n=[],r=0;r<2*t;r++)n[r]=0;for(r=0;r<this.g.length;r++)for(var i=0;i<e.g.length;i++){var s=this.i(r)>>>16,o=65535&this.i(r),u=e.i(i)>>>16,l=65535&e.i(i);n[2*r+2*i]+=o*l,y(n,2*r+2*i),n[2*r+2*i+1]+=s*l,y(n,2*r+2*i+1),n[2*r+2*i+1]+=o*u,y(n,2*r+2*i+1),n[2*r+2*i+2]+=s*u,y(n,2*r+2*i+2)}for(r=0;r<t;r++)n[r]=n[2*r+1]<<16|n[2*r];for(r=t;r<2*t;r++)n[r]=0;return new a(n,0)},e.A=function(e){return w(this,e).h},e.and=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],r=0;r<t;r++)n[r]=this.i(r)&e.i(r);return new a(n,this.h&e.h)},e.or=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],r=0;r<t;r++)n[r]=this.i(r)|e.i(r);return new a(n,this.h|e.h)},e.xor=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],r=0;r<t;r++)n[r]=this.i(r)^e.i(r);return new a(n,this.h^e.h)},r.prototype.digest=r.prototype.v,r.prototype.reset=r.prototype.s,r.prototype.update=r.prototype.u,E=r,a.prototype.multiply=a.prototype.j,a.prototype.modulo=a.prototype.A,a.prototype.compare=a.prototype.l,a.prototype.toNumber=a.prototype.m,a.prototype.getBits=a.prototype.i,a.fromNumber=c,a.fromString=function e(t,n){if(0==t.length)throw Error("number format error: empty string");if((n=n||10)<2||36<n)throw Error("radix out of range: "+n);if("-"==t.charAt(0))return m(e(t.substring(1),n));if(0<=t.indexOf("-"))throw Error('number format error: interior "-" character');for(var r=c(Math.pow(n,8)),i=h,s=0;s<t.length;s+=8){var a=Math.min(8,t.length-s),o=parseInt(t.substring(s,s+a),n);i=a<8?(a=c(Math.pow(n,a)),i.j(a).add(c(o))):(i=i.j(r)).add(c(o))}return i},I=a}).apply(void 0!==T?T:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{});var S,x,D,C,A,N,k,R,M,L,O,F="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};(function(){var e,t="function"==typeof Object.defineProperties?Object.defineProperty:function(e,t,n){return e==Array.prototype||e==Object.prototype||(e[t]=n.value),e},n=function(e){e=["object"==typeof globalThis&&globalThis,e,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof F&&F];for(var t=0;t<e.length;++t){var n=e[t];if(n&&n.Math==Math)return n}throw Error("Cannot find global object")}(this);!function(e,r){if(r)e:{var i=n;e=e.split(".");for(var s=0;s<e.length-1;s++){var a=e[s];if(!(a in i))break e;i=i[a]}(r=r(s=i[e=e[e.length-1]]))!=s&&null!=r&&t(i,e,{configurable:!0,writable:!0,value:r})}}("Array.prototype.values",(function(e){return e||function(){return function(e,t){e instanceof String&&(e+="");var n=0,r=!1,i={next:function(){if(!r&&n<e.length){var i=n++;return{value:t(0,e[i]),done:!1}}return{done:r=!0,value:void 0}}};return i[Symbol.iterator]=function(){return i},i}(this,(function(e,t){return t}))}}));var r=r||{},i=this||self;function s(e){var t=typeof e;return"array"==(t="object"!=t?t:e?Array.isArray(e)?"array":t:"null")||"object"==t&&"number"==typeof e.length}function a(e){var t=typeof e;return"object"==t&&null!=e||"function"==t}function o(e,t,n){return e.call.apply(e.bind,arguments)}function u(e,t,n){if(!e)throw Error();if(2<arguments.length){var r=Array.prototype.slice.call(arguments,2);return function(){var n=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(n,r),e.apply(t,n)}}return function(){return e.apply(t,arguments)}}function c(e,t,n){return(c=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?o:u).apply(null,arguments)}function h(e){var t=Array.prototype.slice.call(arguments,1);return function(){var n=t.slice();return n.push.apply(n,arguments),e.apply(this,n)}}function l(e,t){function n(){}n.prototype=t.prototype,e.aa=t.prototype,e.prototype=new n,(e.prototype.constructor=e).Qb=function(e,n,r){for(var i=Array(arguments.length-2),s=2;s<arguments.length;s++)i[s-2]=arguments[s];return t.prototype[n].apply(e,i)}}function d(e){var t=e.length;if(0<t){const n=Array(t);for(let r=0;r<t;r++)n[r]=e[r];return n}return[]}function f(e){for(let i=1;i<arguments.length;i++){var t=arguments[i];if(s(t)){var n=e.length||0,r=t.length||0;e.length=n+r;for(let i=0;i<r;i++)e[n+i]=t[i]}else e.push(t)}}function g(e){return/^[\s\xa0]*$/.test(e)}function m(){var e=i.navigator;return(e=e&&e.userAgent)?e:""}function p(e){return p[" "](e),e}p[" "]=function(){};var y=!(-1==m().indexOf("Gecko")||-1!=m().toLowerCase().indexOf("webkit")&&-1==m().indexOf("Edge")||-1!=m().indexOf("Trident")||-1!=m().indexOf("MSIE")||-1!=m().indexOf("Edge"));function v(e,t,n){for(const r in e)t.call(n,e[r],r,e)}function w(e){const t={};for(const n in e)t[n]=e[n];return t}const _="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function b(e){let t,n;for(let r=1;r<arguments.length;r++){for(t in n=arguments[r])e[t]=n[t];for(let r=0;r<_.length;r++)t=_[r],Object.prototype.hasOwnProperty.call(n,t)&&(e[t]=n[t])}}var I=new class{constructor(e,t){this.i=e,this.j=t,this.h=0,this.g=null}get(){let e;return 0<this.h?(this.h--,e=this.g,this.g=e.next,e.next=null):e=this.i(),e}}((()=>new E),(e=>e.reset()));class E{constructor(){this.next=this.g=this.h=null}set(e,t){this.h=e,this.g=t,this.next=null}reset(){this.next=this.g=this.h=null}}let T,L=!1,O=new class{constructor(){this.h=this.g=null}add(e,t){const n=I.get();n.set(e,t),this.h?this.h.next=n:this.g=n,this.h=n}},P=()=>{const e=i.Promise.resolve(void 0);T=()=>{e.then(V)}};var V=()=>{for(var e;e=function(){var e=O;let t=null;return e.g&&(t=e.g,e.g=e.g.next,e.g||(e.h=null),t.next=null),t}();){try{e.h.call(e.g)}catch(e){!function(e){i.setTimeout((()=>{throw e}),0)}(e)}var t=I;t.j(e),t.h<100&&(t.h++,e.next=t.g,t.g=e)}L=!1};function U(){this.s=this.s,this.C=this.C}function B(e,t){this.type=e,this.g=this.target=t,this.defaultPrevented=!1}U.prototype.s=!1,U.prototype.ma=function(){this.s||(this.s=!0,this.N())},U.prototype.N=function(){if(this.C)for(;this.C.length;)this.C.shift()()},B.prototype.h=function(){this.defaultPrevented=!0};var q=function(){if(!i.addEventListener||!Object.defineProperty)return!1;var e=!1,t=Object.defineProperty({},"passive",{get:function(){e=!0}});try{var n=()=>{};i.addEventListener("test",n,t),i.removeEventListener("test",n,t)}catch(e){}return e}();function j(e,t){if(B.call(this,e?e.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,e){var n=this.type=e.type,r=e.changedTouches&&e.changedTouches.length?e.changedTouches[0]:null;if(this.target=e.target||e.srcElement,this.g=t,t=e.relatedTarget){if(y){e:{try{p(t.nodeName);var i=!0;break e}catch(e){}i=!1}i||(t=null)}}else"mouseover"==n?t=e.fromElement:"mouseout"==n&&(t=e.toElement);this.relatedTarget=t,r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=void 0!==e.clientX?e.clientX:e.pageX,this.clientY=void 0!==e.clientY?e.clientY:e.pageY,this.screenX=e.screenX||0,this.screenY=e.screenY||0),this.button=e.button,this.key=e.key||"",this.ctrlKey=e.ctrlKey,this.altKey=e.altKey,this.shiftKey=e.shiftKey,this.metaKey=e.metaKey,this.pointerId=e.pointerId||0,this.pointerType="string"==typeof e.pointerType?e.pointerType:G[e.pointerType]||"",this.state=e.state,(this.i=e).defaultPrevented&&j.aa.h.call(this)}}l(j,B);var G={2:"touch",3:"pen",4:"mouse"};j.prototype.h=function(){j.aa.h.call(this);var e=this.i;e.preventDefault?e.preventDefault():e.returnValue=!1};var z="closure_listenable_"+(1e6*Math.random()|0),K=0;function $(e,t,n,r,i){this.listener=e,this.proxy=null,this.src=t,this.type=n,this.capture=!!r,this.ha=i,this.key=++K,this.da=this.fa=!1}function Q(e){e.da=!0,e.listener=null,e.proxy=null,e.src=null,e.ha=null}function H(e){this.src=e,this.g={},this.h=0}function W(e,t){var n,r,i,s=t.type;s in e.g&&(n=e.g[s],(i=0<=(r=Array.prototype.indexOf.call(n,t,void 0)))&&Array.prototype.splice.call(n,r,1),i&&(Q(t),0==e.g[s].length&&(delete e.g[s],e.h--)))}function Y(e,t,n,r){for(var i=0;i<e.length;++i){var s=e[i];if(!s.da&&s.listener==t&&s.capture==!!n&&s.ha==r)return i}return-1}H.prototype.add=function(e,t,n,r,i){var s=e.toString();(e=this.g[s])||(e=this.g[s]=[],this.h++);var a=Y(e,t,r,i);return-1<a?(t=e[a],n||(t.fa=!1)):((t=new $(t,this.src,s,!!r,i)).fa=n,e.push(t)),t};var J="closure_lm_"+(1e6*Math.random()|0),X={};function Z(e,t,n,r,i){if(r&&r.once)return function e(t,n,r,i,s){if(Array.isArray(n)){for(var o=0;o<n.length;o++)e(t,n[o],r,i,s);return null}return r=ae(r),t&&t[z]?t.L(n,r,a(i)?!!i.capture:!!i,s):ee(t,n,r,!0,i,s)}(e,t,n,r,i);if(Array.isArray(t)){for(var s=0;s<t.length;s++)Z(e,t[s],n,r,i);return null}return n=ae(n),e&&e[z]?e.K(t,n,a(r)?!!r.capture:!!r,i):ee(e,t,n,!1,r,i)}function ee(e,t,n,r,i,s){if(!t)throw Error("Invalid event type");var o=a(i)?!!i.capture:!!i,u=ie(e);if(u||(e[J]=u=new H(e)),(n=u.add(t,n,r,o,s)).proxy)return n;if(r=function(){const e=re;return function t(n){return e.call(t.src,t.listener,n)}}(),(n.proxy=r).src=e,r.listener=n,e.addEventListener)void 0===(i=q?i:o)&&(i=!1),e.addEventListener(t.toString(),r,i);else if(e.attachEvent)e.attachEvent(ne(t.toString()),r);else{if(!e.addListener||!e.removeListener)throw Error("addEventListener and attachEvent are unavailable.");e.addListener(r)}return n}function te(e){var t,n,r;"number"!=typeof e&&e&&!e.da&&((t=e.src)&&t[z]?W(t.i,e):(n=e.type,r=e.proxy,t.removeEventListener?t.removeEventListener(n,r,e.capture):t.detachEvent?t.detachEvent(ne(n),r):t.addListener&&t.removeListener&&t.removeListener(r),(n=ie(t))?(W(n,e),0==n.h&&(n.src=null,t[J]=null)):Q(e)))}function ne(e){return e in X?X[e]:X[e]="on"+e}function re(e,t){var n,r;return!!e.da||(t=new j(t,this),n=e.listener,r=e.ha||e.src,e.fa&&te(e),n.call(r,t))}function ie(e){return(e=e[J])instanceof H?e:null}var se="__closure_events_fn_"+(1e9*Math.random()>>>0);function ae(e){return"function"==typeof e?e:(e[se]||(e[se]=function(t){return e.handleEvent(t)}),e[se])}function oe(){U.call(this),this.i=new H(this),(this.M=this).F=null}function ue(e,t){var n,r=e.F;if(r)for(n=[];r;r=r.F)n.push(r);if(e=e.M,r=t.type||t,"string"==typeof t?t=new B(t,e):t instanceof B?t.target=t.target||e:(a=t,b(t=new B(r,e),a)),a=!0,n)for(var i=n.length-1;0<=i;i--)var s=t.g=n[i],a=ce(s,r,!0,t)&&a;if(a=ce(s=t.g=e,r,!0,t)&&a,a=ce(s,r,!1,t)&&a,n)for(i=0;i<n.length;i++)a=ce(s=t.g=n[i],r,!1,t)&&a}function ce(e,t,n,r){if(!(t=e.i.g[String(t)]))return!0;t=t.concat();for(var i=!0,s=0;s<t.length;++s){var a,o,u=t[s];u&&!u.da&&u.capture==n&&(a=u.listener,o=u.ha||u.src,u.fa&&W(e.i,u),i=!1!==a.call(o,r)&&i)}return i&&!r.defaultPrevented}function he(e,t,n){if("function"==typeof e)n&&(e=c(e,n));else{if(!e||"function"!=typeof e.handleEvent)throw Error("Invalid listener argument");e=c(e.handleEvent,e)}return 2147483647<Number(t)?-1:i.setTimeout(e,t||0)}l(oe,U),oe.prototype[z]=!0,oe.prototype.removeEventListener=function(e,t,n,r){!function e(t,n,r,i,s){if(Array.isArray(n))for(var o=0;o<n.length;o++)e(t,n[o],r,i,s);else i=a(i)?!!i.capture:!!i,r=ae(r),t&&t[z]?(t=t.i,(n=String(n).toString())in t.g&&-1<(r=Y(o=t.g[n],r,i,s))&&(Q(o[r]),Array.prototype.splice.call(o,r,1),0==o.length&&(delete t.g[n],t.h--))):(t=t&&ie(t))&&(n=t.g[n.toString()],(r=(t=-1)<(t=n?Y(n,r,i,s):t)?n[t]:null)&&te(r))}(this,e,t,n,r)},oe.prototype.N=function(){if(oe.aa.N.call(this),this.i){var e,t=this.i;for(e in t.g){for(var n=t.g[e],r=0;r<n.length;r++)Q(n[r]);delete t.g[e],t.h--}}this.F=null},oe.prototype.K=function(e,t,n,r){return this.i.add(String(e),t,!1,n,r)},oe.prototype.L=function(e,t,n,r){return this.i.add(String(e),t,!0,n,r)};class le extends U{constructor(e,t){super(),this.m=e,this.l=t,this.h=null,this.i=!1,this.g=null}j(e){this.h=arguments,this.g?this.i=!0:function e(t){t.g=he((()=>{t.g=null,t.i&&(t.i=!1,e(t))}),t.l);var n=t.h;t.h=null,t.m.apply(null,n)}(this)}N(){super.N(),this.g&&(i.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function de(e){U.call(this),this.h=e,this.g={}}l(de,U);var fe=[];function ge(e){v(e.g,(function(e,t){this.g.hasOwnProperty(t)&&te(e)}),e),e.g={}}de.prototype.N=function(){de.aa.N.call(this),ge(this)},de.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};var me=i.JSON.stringify,pe=i.JSON.parse,ye=class{stringify(e){return i.JSON.stringify(e,void 0)}parse(e){return i.JSON.parse(e,void 0)}};function ve(){}function we(e){return e.h||(e.h=e.i())}function _e(){}ve.prototype.h=null;var be={OPEN:"a",kb:"b",Ja:"c",wb:"d"};function Ie(){B.call(this,"d")}function Ee(){B.call(this,"c")}l(Ie,B),l(Ee,B);var Te={},Se=null;function xe(){return Se=Se||new oe}function De(e){B.call(this,Te.La,e)}function Ce(){var e=xe();ue(e,new De(e))}function Ae(e,t){B.call(this,Te.STAT_EVENT,e),this.stat=t}function Ne(e){var t=xe();ue(t,new Ae(t,e))}function ke(e,t){B.call(this,Te.Ma,e),this.size=t}function Re(e,t){if("function"!=typeof e)throw Error("Fn must not be null and must be a function");return i.setTimeout((function(){e()}),t)}function Me(){this.g=!0}function Le(e,t,n,r){e.info((function(){return"XMLHTTP TEXT ("+t+"): "+function(e,t){if(!e.g)return t;if(!t)return null;try{var n=JSON.parse(t);if(n)for(e=0;e<n.length;e++)if(Array.isArray(n[e])){var r=n[e];if(!(r.length<2)){var i=r[1];if(Array.isArray(i)&&!(i.length<1)){var s=i[0];if("noop"!=s&&"stop"!=s&&"close"!=s)for(var a=1;a<i.length;a++)i[a]=""}}}return me(n)}catch(e){return t}}(e,n)+(r?" "+r:"")}))}Te.La="serverreachability",l(De,B),Te.STAT_EVENT="statevent",l(Ae,B),Te.Ma="timingevent",l(ke,B),Me.prototype.xa=function(){this.g=!1},Me.prototype.info=function(){};var Oe={NO_ERROR:0,gb:1,tb:2,sb:3,nb:4,rb:5,ub:6,Ia:7,TIMEOUT:8,xb:9},Fe={lb:"complete",Hb:"success",Ja:"error",Ia:"abort",zb:"ready",Ab:"readystatechange",TIMEOUT:"timeout",vb:"incrementaldata",yb:"progress",ob:"downloadprogress",Pb:"uploadprogress"};function Pe(){}function Ve(e,t,n,r){this.j=e,this.i=t,this.l=n,this.R=r||1,this.U=new de(this),this.I=45e3,this.H=null,this.o=!1,this.m=this.A=this.v=this.L=this.F=this.S=this.B=null,this.D=[],this.g=null,this.C=0,this.s=this.u=null,this.X=-1,this.J=!1,this.O=0,this.M=null,this.W=this.K=this.T=this.P=!1,this.h=new Ue}function Ue(){this.i=null,this.g="",this.h=!1}l(Pe,ve),Pe.prototype.g=function(){return new XMLHttpRequest},Pe.prototype.i=function(){return{}};var Be=new Pe,qe={},je={};function Ge(e,t,n){e.L=1,e.v=gt(ct(t)),e.m=n,e.P=!0,ze(e,null)}function ze(e,t){e.F=Date.now(),$e(e),e.A=ct(e.v);var n=e.A,r=e.R;Array.isArray(r)||(r=[String(r)]),Ct(n.i,"t",r),e.C=0,n=e.j.J,e.h=new Ue,e.g=mn(e.j,n?t:null,!e.m),0<e.O&&(e.M=new le(c(e.Y,e,e.g),e.O)),t=e.U,n=e.g,r=e.ca;var i="readystatechange";Array.isArray(i)||(i&&(fe[0]=i.toString()),i=fe);for(var s,a,o,u,h,l,d=0;d<i.length;d++){var f=Z(n,i[d],r||t.handleEvent,!1,t.h||t);if(!f)break;t.g[f.key]=f}t=e.H?w(e.H):{},e.m?(e.u||(e.u="POST"),t["Content-Type"]="application/x-www-form-urlencoded",e.g.ea(e.A,e.u,e.m,t)):(e.u="GET",e.g.ea(e.A,e.u,null,t)),Ce(),s=e.i,a=e.u,o=e.A,u=e.l,h=e.R,l=e.m,s.info((function(){if(s.g)if(l)for(var e="",t=l.split("&"),n=0;n<t.length;n++){var r,i,c=t[n].split("=");1<c.length&&(r=c[0],c=c[1],e=2<=(i=r.split("_")).length&&"type"==i[1]?e+(r+"=")+c+"&":e+(r+"=redacted&"))}else e=null;else e=l;return"XMLHTTP REQ ("+u+") [attempt "+h+"]: "+a+"\n"+o+"\n"+e}))}function Ke(e){return e.g&&"GET"==e.u&&2!=e.L&&e.j.Ca}function $e(e){e.S=Date.now()+e.I,Qe(e,e.I)}function Qe(e,t){if(null!=e.B)throw Error("WatchDog timer not null");e.B=Re(c(e.ba,e),t)}function He(e){e.B&&(i.clearTimeout(e.B),e.B=null)}function We(e){0==e.j.G||e.J||hn(e.j,e)}function Ye(e){He(e);var t=e.M;t&&"function"==typeof t.ma&&t.ma(),e.M=null,ge(e.U),e.g&&(t=e.g,e.g=null,t.abort(),t.ma())}function Je(e,t){try{var n=e.j;if(0!=n.G&&(n.g==e||nt(n.h,e)))if(!e.K&&nt(n.h,e)&&3==n.G){try{var r=n.Da.g.parse(t)}catch(e){r=null}if(Array.isArray(r)&&3==r.length){var i=r;if(0==i[0]){e:if(!n.u){if(n.g){if(!(n.g.F+3e3<e.F))break e;cn(n),Xt(n)}an(n),Ne(18)}}else n.za=i[1],0<n.za-n.T&&i[2]<37500&&n.F&&0==n.v&&!n.C&&(n.C=Re(c(n.Za,n),6e3));if(tt(n.h)<=1&&n.ca){try{n.ca()}catch(e){}n.ca=void 0}}else dn(n,11)}else if(!e.K&&n.g!=e||cn(n),!g(t))for(i=n.Da.g.parse(t),t=0;t<i.length;t++){var s=i[t];if(n.T=s[0],s=s[1],2==n.G)if("c"==s[0]){n.K=s[1],n.ia=s[2];var a=s[3];null!=a&&(n.la=a,n.j.info("VER="+n.la));var o=s[4];null!=o&&(n.Aa=o,n.j.info("SVER="+n.Aa));var u,h,l=s[5];null!=l&&"number"==typeof l&&0<l&&(r=1.5*l,n.L=r,n.j.info("backChannelRequestTimeoutMs_="+r)),r=n;const t=e.g;if(t){const e=t.g?t.g.getResponseHeader("X-Client-Wire-Protocol"):null;e&&((u=r.h).g||-1==e.indexOf("spdy")&&-1==e.indexOf("quic")&&-1==e.indexOf("h2")||(u.j=u.l,u.g=new Set,u.h&&(rt(u,u.h),u.h=null))),!r.D||(h=t.g?t.g.getResponseHeader("X-HTTP-Session-Id"):null)&&(r.ya=h,ft(r.I,r.D,h))}n.G=3,n.l&&n.l.ua(),n.ba&&(n.R=Date.now()-e.F,n.j.info("Handshake RTT: "+n.R+"ms"));var d,f,m=e;(r=n).qa=gn(r,r.J?r.ia:null,r.W),m.K?(it(r.h,m),d=m,(f=r.L)&&(d.I=f),d.B&&(He(d),$e(d)),r.g=m):sn(r),0<n.i.length&&en(n)}else"stop"!=s[0]&&"close"!=s[0]||dn(n,7);else 3==n.G&&("stop"==s[0]||"close"==s[0]?"stop"==s[0]?dn(n,7):Jt(n):"noop"!=s[0]&&n.l&&n.l.ta(s),n.v=0)}Ce()}catch(e){}}Ve.prototype.ca=function(e){e=e.target;const t=this.M;t&&3==Qt(e)?t.j():this.Y(e)},Ve.prototype.Y=function(e){try{if(e==this.g)e:{var t=Qt(this.g),n=this.g.Ba();if(this.g.Z(),!(t<3)&&(3!=t||this.g&&(this.h.h||this.g.oa()||Ht(this.g)))){this.J||4!=t||7==n||Ce(),He(this);var r=this.g.Z();this.X=r;t:if(Ke(this)){var s=Ht(this.g);e="";var a=s.length,o=4==Qt(this.g);if(!this.h.i){if("undefined"==typeof TextDecoder){Ye(this),We(this);var u="";break t}this.h.i=new i.TextDecoder}for(n=0;n<a;n++)this.h.h=!0,e+=this.h.i.decode(s[n],{stream:!(o&&n==a-1)});s.length=0,this.h.g+=e,this.C=0,u=this.h.g}else u=this.g.oa();if(this.o=200==r,v=this.i,w=this.u,_=this.A,b=this.l,I=this.R,E=t,T=r,v.info((function(){return"XMLHTTP RESP ("+b+") [ attempt "+I+"]: "+w+"\n"+_+"\n"+E+" "+T})),this.o){if(this.T&&!this.K){t:{if(this.g){var c,h=this.g;if((c=h.g?h.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!g(c)){var l=c;break t}}l=null}if(!(r=l)){this.o=!1,this.s=3,Ne(12),Ye(this),We(this);break e}Le(this.i,this.l,r,"Initial handshake response via X-HTTP-Initial-Response"),this.K=!0,Je(this,r)}if(this.P){var d,f;for(r=!0;!this.J&&this.C<u.length;){if(m=u,y=p=void 0,p=this.C,(d=-1==(y=m.indexOf("\n",p))?je:(p=Number(m.substring(p,y)),isNaN(p)?qe:(y+=1)+p>m.length?je:(m=m.slice(y,y+p),this.C=y+p,m)))==je){4==t&&(this.s=4,Ne(14),r=!1),Le(this.i,this.l,null,"[Incomplete Response]");break}if(d==qe){this.s=4,Ne(15),Le(this.i,this.l,u,"[Invalid Chunk]"),r=!1;break}Le(this.i,this.l,d,null),Je(this,d)}Ke(this)&&0!=this.C&&(this.h.g=this.h.g.slice(this.C),this.C=0),4!=t||0!=u.length||this.h.h||(this.s=1,Ne(16),r=!1),this.o=this.o&&r,r?0<u.length&&!this.W&&(this.W=!0,(f=this.j).g==this&&f.ba&&!f.M&&(f.j.info("Great, no buffering proxy detected. Bytes received: "+u.length),on(f),f.M=!0,Ne(11))):(Le(this.i,this.l,u,"[Invalid Chunked Response]"),Ye(this),We(this))}else Le(this.i,this.l,u,null),Je(this,u);4==t&&Ye(this),this.o&&!this.J&&(4==t?hn(this.j,this):(this.o=!1,$e(this)))}else(function(e){const t={};e=(e.g&&2<=Qt(e)&&e.g.getAllResponseHeaders()||"").split("\r\n");for(let i=0;i<e.length;i++)if(!g(e[i])){var n=function(e){var t=1;e=e.split(":");const n=[];for(;0<t&&e.length;)n.push(e.shift()),t--;return e.length&&n.push(e.join(":")),n}(e[i]),r=n[0];if("string"==typeof(n=n[1])){n=n.trim();const e=t[r]||[];t[r]=e,e.push(n)}}!function(e,t){for(const n in e)t.call(void 0,e[n],n,e)}(t,(function(e){return e.join(", ")}))})(this.g),400==r&&0<u.indexOf("Unknown SID")?(this.s=3,Ne(12)):(this.s=0,Ne(13)),Ye(this),We(this)}}}catch(e){}var m,p,y,v,w,_,b,I,E,T},Ve.prototype.cancel=function(){this.J=!0,Ye(this)},Ve.prototype.ba=function(){this.B=null;var e,t,n=Date.now();0<=n-this.S?(e=this.i,t=this.A,e.info((function(){return"TIMEOUT: "+t})),2!=this.L&&(Ce(),Ne(17)),Ye(this),this.s=2,We(this)):Qe(this,this.S-n)};var Xe=class{constructor(e,t){this.g=e,this.map=t}};function Ze(e){this.l=e||10,e=i.PerformanceNavigationTiming?0<(e=i.performance.getEntriesByType("navigation")).length&&("hq"==e[0].nextHopProtocol||"h2"==e[0].nextHopProtocol):!!(i.chrome&&i.chrome.loadTimes&&i.chrome.loadTimes()&&i.chrome.loadTimes().wasFetchedViaSpdy),this.j=e?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}function et(e){return e.h||e.g&&e.g.size>=e.j}function tt(e){return e.h?1:e.g?e.g.size:0}function nt(e,t){return e.h?e.h==t:e.g&&e.g.has(t)}function rt(e,t){e.g?e.g.add(t):e.h=t}function it(e,t){e.h&&e.h==t?e.h=null:e.g&&e.g.has(t)&&e.g.delete(t)}function st(e){if(null!=e.h)return e.i.concat(e.h.D);if(null==e.g||0===e.g.size)return d(e.i);{let t=e.i;for(const n of e.g.values())t=t.concat(n.D);return t}}function at(e,t){if(e.forEach&&"function"==typeof e.forEach)e.forEach(t,void 0);else if(s(e)||"string"==typeof e)Array.prototype.forEach.call(e,t,void 0);else for(var n=function(e){if(e.na&&"function"==typeof e.na)return e.na();if(!e.V||"function"!=typeof e.V){if("undefined"!=typeof Map&&e instanceof Map)return Array.from(e.keys());if(!("undefined"!=typeof Set&&e instanceof Set)){if(s(e)||"string"==typeof e){var t=[];e=e.length;for(var n=0;n<e;n++)t.push(n);return t}t=[],n=0;for(const r in e)t[n++]=r;return t}}}(e),r=function(e){if(e.V&&"function"==typeof e.V)return e.V();if("undefined"!=typeof Map&&e instanceof Map||"undefined"!=typeof Set&&e instanceof Set)return Array.from(e.values());if("string"==typeof e)return e.split("");if(s(e)){for(var t=[],n=e.length,r=0;r<n;r++)t.push(e[r]);return t}for(r in t=[],n=0,e)t[n++]=e[r];return t}(e),i=r.length,a=0;a<i;a++)t.call(void 0,r[a],n&&n[a],e)}Ze.prototype.cancel=function(){if(this.i=st(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const e of this.g.values())e.cancel();this.g.clear()}};var ot=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function ut(e){var t,n;this.g=this.o=this.j="",this.s=null,this.m=this.l="",this.h=!1,e instanceof ut?(this.h=e.h,ht(this,e.j),this.o=e.o,this.g=e.g,lt(this,e.s),this.l=e.l,t=e.i,(n=new Tt).i=t.i,t.g&&(n.g=new Map(t.g),n.h=t.h),dt(this,n),this.m=e.m):e&&(t=String(e).match(ot))?(this.h=!1,ht(this,t[1]||"",!0),this.o=mt(t[2]||""),this.g=mt(t[3]||"",!0),lt(this,t[4]),this.l=mt(t[5]||"",!0),dt(this,t[6]||"",!0),this.m=mt(t[7]||"")):(this.h=!1,this.i=new Tt(null,this.h))}function ct(e){return new ut(e)}function ht(e,t,n){e.j=n?mt(t,!0):t,e.j&&(e.j=e.j.replace(/:$/,""))}function lt(e,t){if(t){if(t=Number(t),isNaN(t)||t<0)throw Error("Bad port number "+t);e.s=t}else e.s=null}function dt(e,t,n){var r,i;t instanceof Tt?(e.i=t,r=e.i,(i=e.h)&&!r.j&&(St(r),r.i=null,r.g.forEach((function(e,t){var n=t.toLowerCase();t!=n&&(xt(this,t),Ct(this,n,e))}),r)),r.j=i):(n||(t=pt(t,It)),e.i=new Tt(t,e.h))}function ft(e,t,n){e.i.set(t,n)}function gt(e){return ft(e,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),e}function mt(e,t){return e?t?decodeURI(e.replace(/%25/g,"%2525")):decodeURIComponent(e):""}function pt(e,t,n){return"string"==typeof e?(e=encodeURI(e).replace(t,yt),e=n?e.replace(/%25([0-9a-fA-F]{2})/g,"%$1"):e):null}function yt(e){return"%"+((e=e.charCodeAt(0))>>4&15).toString(16)+(15&e).toString(16)}ut.prototype.toString=function(){var e=[],t=this.j;t&&e.push(pt(t,wt,!0),":");var n=this.g;return!n&&"file"!=t||(e.push("//"),(t=this.o)&&e.push(pt(t,wt,!0),"@"),e.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.s)&&e.push(":",String(n))),(n=this.l)&&(this.g&&"/"!=n.charAt(0)&&e.push("/"),e.push(pt(n,"/"==n.charAt(0)?bt:_t,!0))),(n=this.i.toString())&&e.push("?",n),(n=this.m)&&e.push("#",pt(n,Et)),e.join("")};var vt,wt=/[#\/\?@]/g,_t=/[#\?:]/g,bt=/[#\?]/g,It=/[#\?@]/g,Et=/#/g;function Tt(e,t){this.h=this.g=null,this.i=e||null,this.j=!!t}function St(e){e.g||(e.g=new Map,e.h=0,e.i&&function(e,t){if(e){e=e.split("&");for(var n=0;n<e.length;n++){var r,i=e[n].indexOf("="),s=null;0<=i?(r=e[n].substring(0,i),s=e[n].substring(i+1)):r=e[n],t(r,s?decodeURIComponent(s.replace(/\+/g," ")):"")}}}(e.i,(function(t,n){e.add(decodeURIComponent(t.replace(/\+/g," ")),n)})))}function xt(e,t){St(e),t=At(e,t),e.g.has(t)&&(e.i=null,e.h-=e.g.get(t).length,e.g.delete(t))}function Dt(e,t){return St(e),t=At(e,t),e.g.has(t)}function Ct(e,t,n){xt(e,t),0<n.length&&(e.i=null,e.g.set(At(e,t),d(n)),e.h+=n.length)}function At(e,t){return t=String(t),e.j?t.toLowerCase():t}function Nt(e,t,n,r,i){try{i&&(i.onload=null,i.onerror=null,i.onabort=null,i.ontimeout=null),r(n)}catch(e){}}function kt(){this.g=new ye}function Rt(e){this.l=e.Ub||null,this.j=e.eb||!1}function Mt(e,t){oe.call(this),this.D=e,this.o=t,this.m=void 0,this.status=this.readyState=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.u=new Headers,this.h=null,this.B="GET",this.A="",this.g=!1,this.v=this.j=this.l=null}function Lt(e){e.j.read().then(e.Pa.bind(e)).catch(e.ga.bind(e))}function Ot(e){e.readyState=4,e.l=null,e.j=null,e.v=null,Ft(e)}function Ft(e){e.onreadystatechange&&e.onreadystatechange.call(e)}function Pt(e){let t="";return v(e,(function(e,n){t+=n,t+=":",t+=e,t+="\r\n"})),t}function Vt(e,t,n){e:{for(r in n){var r=!1;break e}r=!0}r||(n=Pt(n),"string"==typeof e?null!=n&&encodeURIComponent(String(n)):ft(e,t,n))}function Ut(e){oe.call(this),this.headers=new Map,this.o=e||null,this.h=!1,this.v=this.g=null,this.D="",this.m=0,this.l="",this.j=this.B=this.u=this.A=!1,this.I=null,this.H="",this.J=!1}(e=Tt.prototype).add=function(e,t){St(this),this.i=null,e=At(this,e);var n=this.g.get(e);return n||this.g.set(e,n=[]),n.push(t),this.h+=1,this},e.forEach=function(e,t){St(this),this.g.forEach((function(n,r){n.forEach((function(n){e.call(t,n,r,this)}),this)}),this)},e.na=function(){St(this);const e=Array.from(this.g.values()),t=Array.from(this.g.keys()),n=[];for(let i=0;i<t.length;i++){var r=e[i];for(let e=0;e<r.length;e++)n.push(t[i])}return n},e.V=function(e){St(this);let t=[];if("string"==typeof e)Dt(this,e)&&(t=t.concat(this.g.get(At(this,e))));else{e=Array.from(this.g.values());for(let n=0;n<e.length;n++)t=t.concat(e[n])}return t},e.set=function(e,t){return St(this),this.i=null,Dt(this,e=At(this,e))&&(this.h-=this.g.get(e).length),this.g.set(e,[t]),this.h+=1,this},e.get=function(e,t){return e&&0<(e=this.V(e)).length?String(e[0]):t},e.toString=function(){if(this.i)return this.i;if(!this.g)return"";const e=[],t=Array.from(this.g.keys());for(var n=0;n<t.length;n++){var r=t[n],i=encodeURIComponent(String(r)),s=this.V(r);for(r=0;r<s.length;r++){var a=i;""!==s[r]&&(a+="="+encodeURIComponent(String(s[r]))),e.push(a)}}return this.i=e.join("&")},l(Rt,ve),Rt.prototype.g=function(){return new Mt(this.l,this.j)},Rt.prototype.i=(vt={},function(){return vt}),l(Mt,oe),(e=Mt.prototype).open=function(e,t){if(0!=this.readyState)throw this.abort(),Error("Error reopening a connection");this.B=e,this.A=t,this.readyState=1,Ft(this)},e.send=function(e){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;const t={headers:this.u,method:this.B,credentials:this.m,cache:void 0};e&&(t.body=e),(this.D||i).fetch(new Request(this.A,t)).then(this.Sa.bind(this),this.ga.bind(this))},e.abort=function(){this.response=this.responseText="",this.u=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch((()=>{})),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,Ot(this)),this.readyState=0},e.Sa=function(e){if(this.g&&(this.l=e,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=e.headers,this.readyState=2,Ft(this)),this.g&&(this.readyState=3,Ft(this),this.g)))if("arraybuffer"===this.responseType)e.arrayBuffer().then(this.Qa.bind(this),this.ga.bind(this));else if(void 0!==i.ReadableStream&&"body"in e){if(this.j=e.body.getReader(),this.o){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.v=new TextDecoder;Lt(this)}else e.text().then(this.Ra.bind(this),this.ga.bind(this))},e.Pa=function(e){var t;this.g&&(this.o&&e.value?this.response.push(e.value):this.o||(t=e.value||new Uint8Array(0),(t=this.v.decode(t,{stream:!e.done}))&&(this.response=this.responseText+=t)),(e.done?Ot:Ft)(this),3==this.readyState&&Lt(this))},e.Ra=function(e){this.g&&(this.response=this.responseText=e,Ot(this))},e.Qa=function(e){this.g&&(this.response=e,Ot(this))},e.ga=function(){this.g&&Ot(this)},e.setRequestHeader=function(e,t){this.u.append(e,t)},e.getResponseHeader=function(e){return this.h&&this.h.get(e.toLowerCase())||""},e.getAllResponseHeaders=function(){if(!this.h)return"";const e=[],t=this.h.entries();for(var n=t.next();!n.done;)n=n.value,e.push(n[0]+": "+n[1]),n=t.next();return e.join("\r\n")},Object.defineProperty(Mt.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(e){this.m=e?"include":"same-origin"}}),l(Ut,oe);var Bt=/^https?$/i,qt=["POST","PUT"];function jt(e,t){e.h=!1,e.g&&(e.j=!0,e.g.abort(),e.j=!1),e.l=t,e.m=5,Gt(e),Kt(e)}function Gt(e){e.A||(e.A=!0,ue(e,"complete"),ue(e,"error"))}function zt(e){if(e.h&&void 0!==r&&(!e.v[1]||4!=Qt(e)||2!=e.Z()))if(e.u&&4==Qt(e))he(e.Ea,0,e);else if(ue(e,"readystatechange"),4==Qt(e)){e.h=!1;try{var t,n,s,a=e.Z();e:switch(a){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var o=!0;break e;default:o=!1}if((t=o)||((n=0===a)&&(!(s=String(e.D).match(ot)[1]||null)&&i.self&&i.self.location&&(s=i.self.location.protocol.slice(0,-1)),n=!Bt.test(s?s.toLowerCase():"")),t=n),t)ue(e,"complete"),ue(e,"success");else{e.m=6;try{var u=2<Qt(e)?e.g.statusText:""}catch(e){u=""}e.l=u+" ["+e.Z()+"]",Gt(e)}}finally{Kt(e)}}}function Kt(e,t){if(e.g){$t(e);const n=e.g,r=e.v[0]?()=>{}:null;e.g=null,e.v=null,t||ue(e,"ready");try{n.onreadystatechange=r}catch(e){}}}function $t(e){e.I&&(i.clearTimeout(e.I),e.I=null)}function Qt(e){return e.g?e.g.readyState:0}function Ht(e){try{if(!e.g)return null;if("response"in e.g)return e.g.response;switch(e.H){case"":case"text":return e.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in e.g)return e.g.mozResponseArrayBuffer}return null}catch(e){return null}}function Wt(e,t,n){return n&&n.internalChannelParams&&n.internalChannelParams[e]||t}function Yt(e){this.Aa=0,this.i=[],this.j=new Me,this.ia=this.qa=this.I=this.W=this.g=this.ya=this.D=this.H=this.m=this.S=this.o=null,this.Ya=this.U=0,this.Va=Wt("failFast",!1,e),this.F=this.C=this.u=this.s=this.l=null,this.X=!0,this.za=this.T=-1,this.Y=this.v=this.B=0,this.Ta=Wt("baseRetryDelayMs",5e3,e),this.cb=Wt("retryDelaySeedMs",1e4,e),this.Wa=Wt("forwardChannelMaxRetries",2,e),this.wa=Wt("forwardChannelRequestTimeoutMs",2e4,e),this.pa=e&&e.xmlHttpFactory||void 0,this.Xa=e&&e.Tb||void 0,this.Ca=e&&e.useFetchStreams||!1,this.L=void 0,this.J=e&&e.supportsCrossDomainXhr||!1,this.K="",this.h=new Ze(e&&e.concurrentRequestLimit),this.Da=new kt,this.P=e&&e.fastHandshake||!1,this.O=e&&e.encodeInitMessageHeaders||!1,this.P&&this.O&&(this.O=!1),this.Ua=e&&e.Rb||!1,e&&e.xa&&this.j.xa(),e&&e.forceLongPolling&&(this.X=!1),this.ba=!this.P&&this.X&&e&&e.detectBufferingProxy||!1,this.ja=void 0,e&&e.longPollingTimeout&&0<e.longPollingTimeout&&(this.ja=e.longPollingTimeout),this.ca=void 0,this.R=0,this.M=!1,this.ka=this.A=null}function Jt(e){if(Zt(e),3==e.G){var t=e.U++,n=ct(e.I);if(ft(n,"SID",e.K),ft(n,"RID",t),ft(n,"TYPE","terminate"),nn(e,n),(t=new Ve(e,e.j,t)).L=2,t.v=gt(ct(n)),n=!1,i.navigator&&i.navigator.sendBeacon)try{n=i.navigator.sendBeacon(t.v.toString(),"")}catch(e){}!n&&i.Image&&((new Image).src=t.v,n=!0),n||(t.g=mn(t.j,null),t.g.ea(t.v)),t.F=Date.now(),$e(t)}fn(e)}function Xt(e){e.g&&(on(e),e.g.cancel(),e.g=null)}function Zt(e){Xt(e),e.u&&(i.clearTimeout(e.u),e.u=null),cn(e),e.h.cancel(),e.s&&("number"==typeof e.s&&i.clearTimeout(e.s),e.s=null)}function en(e){var t;et(e.h)||e.s||(e.s=!0,t=e.Ga,T||P(),L||(T(),L=!0),O.add(t,e),e.B=0)}function tn(e,t){var n=t?t.l:e.U++,r=ct(e.I);ft(r,"SID",e.K),ft(r,"RID",n),ft(r,"AID",e.T),nn(e,r),e.m&&e.o&&Vt(r,e.m,e.o),n=new Ve(e,e.j,n,e.B+1),null===e.m&&(n.H=e.o),t&&(e.i=t.D.concat(e.i)),t=rn(e,n,1e3),n.I=Math.round(.5*e.wa)+Math.round(.5*e.wa*Math.random()),rt(e.h,n),Ge(n,r,t)}function nn(e,t){e.H&&v(e.H,(function(e,n){ft(t,n,e)})),e.l&&at({},(function(e,n){ft(t,n,e)}))}function rn(e,t,n){n=Math.min(e.i.length,n);var r=e.l?c(e.l.Na,e.l,e):null;e:{var i=e.i;let t=-1;for(;;){const u=["count="+n];-1==t?0<n?(t=i[0].g,u.push("ofs="+t)):t=0:u.push("ofs="+t);let c=!0;for(let h=0;h<n;h++){var s=i[h].g,o=i[h].map;if((s-=t)<0)t=Math.max(0,i[h].g-100),c=!1;else try{!function(e,t,n){const r=n||"";try{at(e,(function(e,n){let i=e;a(e)&&(i=me(e)),t.push(r+n+"="+encodeURIComponent(i))}))}catch(e){throw t.push(r+"type="+encodeURIComponent("_badmap")),e}}(o,u,"req"+s+"_")}catch(e){r&&r(o)}}if(c){r=u.join("&");break e}}}return e=e.i.splice(0,n),t.D=e,r}function sn(e){var t;e.g||e.u||(e.Y=1,t=e.Fa,T||P(),L||(T(),L=!0),O.add(t,e),e.v=0)}function an(e){return!(e.g||e.u||3<=e.v)&&(e.Y++,e.u=Re(c(e.Fa,e),ln(e,e.v)),e.v++,1)}function on(e){null!=e.A&&(i.clearTimeout(e.A),e.A=null)}function un(e){e.g=new Ve(e,e.j,"rpc",e.Y),null===e.m&&(e.g.H=e.o),e.g.O=0;var t=ct(e.qa);ft(t,"RID","rpc"),ft(t,"SID",e.K),ft(t,"AID",e.T),ft(t,"CI",e.F?"0":"1"),!e.F&&e.ja&&ft(t,"TO",e.ja),ft(t,"TYPE","xmlhttp"),nn(e,t),e.m&&e.o&&Vt(t,e.m,e.o),e.L&&(e.g.I=e.L);var n=e.g;e=e.ia,n.L=1,n.v=gt(ct(t)),n.m=null,n.P=!0,ze(n,e)}function cn(e){null!=e.C&&(i.clearTimeout(e.C),e.C=null)}function hn(e,t){var n,r,i,s=null;if(e.g==t){cn(e),on(e),e.g=null;var a=2}else{if(!nt(e.h,t))return;s=t.D,it(e.h,t),a=1}if(0!=e.G)if(t.o)1==a?(s=t.m?t.m.length:0,t=Date.now()-t.F,n=e.B,ue(a=xe(),new ke(a,s)),en(e)):sn(e);else if(3==(n=t.s)||0==n&&0<t.X||(1!=a||(i=t,tt((r=e).h)>=r.h.j-(r.s?1:0)||(r.s?(r.i=i.D.concat(r.i),0):1==r.G||2==r.G||r.B>=(r.Va?0:r.Wa)||(r.s=Re(c(r.Ga,r,i),ln(r,r.B)),r.B++,0))))&&(2!=a||!an(e)))switch(s&&0<s.length&&(t=e.h,t.i=t.i.concat(s)),n){case 1:dn(e,5);break;case 4:dn(e,10);break;case 3:dn(e,6);break;default:dn(e,2)}}function ln(e,t){let n=e.Ta+Math.floor(Math.random()*e.cb);return e.isActive()||(n*=2),n*t}function dn(e,t){var n,r,s;e.j.info("Error code "+t),2==t?(n=c(e.fb,e),r=!(s=e.Xa),s=new ut(s||"//www.google.com/images/cleardot.gif"),i.location&&"http"==i.location.protocol||ht(s,"https"),gt(s),(r?function(e,t){var n=new Me;if(i.Image){const r=new Image;r.onload=h(Nt,n,"TestLoadImage: loaded",!0,t,r),r.onerror=h(Nt,n,"TestLoadImage: error",!1,t,r),r.onabort=h(Nt,n,"TestLoadImage: abort",!1,t,r),r.ontimeout=h(Nt,n,"TestLoadImage: timeout",!1,t,r),i.setTimeout((function(){r.ontimeout&&r.ontimeout()}),1e4),r.src=e}else t(!1)}:function(e,t){new Me;const n=new AbortController,r=setTimeout((()=>{n.abort(),Nt(0,0,!1,t)}),1e4);fetch(e,{signal:n.signal}).then((e=>{clearTimeout(r),e.ok?Nt(0,0,!0,t):Nt(0,0,!1,t)})).catch((()=>{clearTimeout(r),Nt(0,0,!1,t)}))})(s.toString(),n)):Ne(2),e.G=0,e.l&&e.l.sa(t),fn(e),Zt(e)}function fn(e){var t;e.G=0,e.ka=[],e.l&&(0==(t=st(e.h)).length&&0==e.i.length||(f(e.ka,t),f(e.ka,e.i),e.h.i.length=0,d(e.i),e.i.length=0),e.l.ra())}function gn(e,t,n){var r,s,a=n instanceof ut?ct(n):new ut(n);return""!=a.g?(t&&(a.g=t+"."+a.g),lt(a,a.s)):(a=(r=i.location).protocol,t=t?t+"."+r.hostname:r.hostname,r=+r.port,s=new ut(null),a&&ht(s,a),t&&(s.g=t),r&&lt(s,r),n&&(s.l=n),a=s),n=e.D,t=e.ya,n&&t&&ft(a,n,t),ft(a,"VER",e.la),nn(e,a),a}function mn(e,t,n){if(t&&!e.J)throw Error("Can't create secondary domain capable XhrIo object.");return(t=e.Ca&&!e.pa?new Ut(new Rt({eb:n})):new Ut(e.pa)).Ha(e.J),t}function pn(){}function yn(){}function vn(e,t){oe.call(this),this.g=new Yt(t),this.l=e,this.h=t&&t.messageUrlParams||null,e=t&&t.messageHeaders||null,t&&t.clientProtocolHeaderRequired&&(e?e["X-Client-Protocol"]="webchannel":e={"X-Client-Protocol":"webchannel"}),this.g.o=e,e=t&&t.initMessageHeaders||null,t&&t.messageContentType&&(e?e["X-WebChannel-Content-Type"]=t.messageContentType:e={"X-WebChannel-Content-Type":t.messageContentType}),t&&t.va&&(e?e["X-WebChannel-Client-Profile"]=t.va:e={"X-WebChannel-Client-Profile":t.va}),this.g.S=e,(e=t&&t.Sb)&&!g(e)&&(this.g.m=e),this.v=t&&t.supportsCrossDomainXhr||!1,this.u=t&&t.sendRawJson||!1,(t=t&&t.httpSessionIdParam)&&!g(t)&&(this.g.D=t,null!==(e=this.h)&&t in e&&t in(e=this.h)&&delete e[t]),this.j=new bn(this)}function wn(e){Ie.call(this),e.__headers__&&(this.headers=e.__headers__,this.statusCode=e.__status__,delete e.__headers__,delete e.__status__);var t=e.__sm__;if(t){e:{for(const n in t){e=n;break e}e=void 0}(this.i=e)&&(e=this.i,t=null!==t&&e in t?t[e]:void 0),this.data=t}else this.data=e}function _n(){Ee.call(this),this.status=1}function bn(e){this.g=e}(e=Ut.prototype).Ha=function(e){this.J=e},e.ea=function(e,t,n,r){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.D+"; newUri="+e);t=t?t.toUpperCase():"GET",this.D=e,this.l="",this.m=0,this.A=!1,this.h=!0,this.g=(this.o||Be).g(),this.v=this.o?we(this.o):we(Be),this.g.onreadystatechange=c(this.Ea,this);try{this.B=!0,this.g.open(t,String(e),!0),this.B=!1}catch(e){return void jt(this,e)}if(e=n||"",n=new Map(this.headers),r)if(Object.getPrototypeOf(r)===Object.prototype)for(var s in r)n.set(s,r[s]);else{if("function"!=typeof r.keys||"function"!=typeof r.get)throw Error("Unknown input type for opt_headers: "+String(r));for(const e of r.keys())n.set(e,r.get(e))}for(var[a,o]of(r=Array.from(n.keys()).find((e=>"content-type"==e.toLowerCase())),s=i.FormData&&e instanceof i.FormData,0<=Array.prototype.indexOf.call(qt,t,void 0)&&!r&&!s&&n.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8"),n))this.g.setRequestHeader(a,o);this.H&&(this.g.responseType=this.H),"withCredentials"in this.g&&this.g.withCredentials!==this.J&&(this.g.withCredentials=this.J);try{$t(this),this.u=!0,this.g.send(e),this.u=!1}catch(e){jt(this,e)}},e.abort=function(e){this.g&&this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1,this.m=e||7,ue(this,"complete"),ue(this,"abort"),Kt(this))},e.N=function(){this.g&&(this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1),Kt(this,!0)),Ut.aa.N.call(this)},e.Ea=function(){this.s||(this.B||this.u||this.j?zt(this):this.bb())},e.bb=function(){zt(this)},e.isActive=function(){return!!this.g},e.Z=function(){try{return 2<Qt(this)?this.g.status:-1}catch(e){return-1}},e.oa=function(){try{return this.g?this.g.responseText:""}catch(e){return""}},e.Oa=function(e){if(this.g){var t=this.g.responseText;return e&&0==t.indexOf(e)&&(t=t.substring(e.length)),pe(t)}},e.Ba=function(){return this.m},e.Ka=function(){return"string"==typeof this.l?this.l:String(this.l)},(e=Yt.prototype).la=8,e.G=1,e.connect=function(e,t,n,r){Ne(0),this.W=e,this.H=t||{},n&&void 0!==r&&(this.H.OSID=n,this.H.OAID=r),this.F=this.X,this.I=gn(this,null,this.W),en(this)},e.Ga=function(e){if(this.s)if(this.s=null,1==this.G){if(!e){this.U=Math.floor(1e5*Math.random()),e=this.U++;const i=new Ve(this,this.j,e);let s=this.o;if(this.S&&(s?(s=w(s),b(s,this.S)):s=this.S),null!==this.m||this.O||(i.H=s,s=null),this.P)e:{for(var t=0,n=0;n<this.i.length;n++){var r=this.i[n];if(void 0===(r="__data__"in r.map&&"string"==typeof(r=r.map.__data__)?r.length:void 0))break;if(4096<(t+=r)){t=n;break e}if(4096===t||n===this.i.length-1){t=n+1;break e}}t=1e3}else t=1e3;t=rn(this,i,t),ft(n=ct(this.I),"RID",e),ft(n,"CVER",22),this.D&&ft(n,"X-HTTP-Session-Id",this.D),nn(this,n),s&&(this.O?t="headers="+encodeURIComponent(String(Pt(s)))+"&"+t:this.m&&Vt(n,this.m,s)),rt(this.h,i),this.Ua&&ft(n,"TYPE","init"),this.P?(ft(n,"$req",t),ft(n,"SID","null"),i.T=!0,Ge(i,n,null)):Ge(i,n,t),this.G=2}}else 3==this.G&&(e?tn(this,e):0==this.i.length||et(this.h)||tn(this))},e.Fa=function(){var e;this.u=null,un(this),this.ba&&!(this.M||null==this.g||this.R<=0)&&(e=2*this.R,this.j.info("BP detection timer enabled: "+e),this.A=Re(c(this.ab,this),e))},e.ab=function(){this.A&&(this.A=null,this.j.info("BP detection timeout reached."),this.j.info("Buffering proxy detected and switch to long-polling!"),this.F=!1,this.M=!0,Ne(10),Xt(this),un(this))},e.Za=function(){null!=this.C&&(this.C=null,Xt(this),an(this),Ne(19))},e.fb=function(e){e?(this.j.info("Successfully pinged google.com"),Ne(2)):(this.j.info("Failed to ping google.com"),Ne(1))},e.isActive=function(){return!!this.l&&this.l.isActive(this)},(e=pn.prototype).ua=function(){},e.ta=function(){},e.sa=function(){},e.ra=function(){},e.isActive=function(){return!0},e.Na=function(){},yn.prototype.g=function(e,t){return new vn(e,t)},l(vn,oe),vn.prototype.m=function(){this.g.l=this.j,this.v&&(this.g.J=!0),this.g.connect(this.l,this.h||void 0)},vn.prototype.close=function(){Jt(this.g)},vn.prototype.o=function(e){var t,n=this.g;"string"==typeof e?((t={}).__data__=e,e=t):this.u&&((t={}).__data__=me(e),e=t),n.i.push(new Xe(n.Ya++,e)),3==n.G&&en(n)},vn.prototype.N=function(){this.g.l=null,delete this.j,Jt(this.g),delete this.g,vn.aa.N.call(this)},l(wn,Ie),l(_n,Ee),l(bn,pn),bn.prototype.ua=function(){ue(this.g,"a")},bn.prototype.ta=function(e){ue(this.g,new wn(e))},bn.prototype.sa=function(e){ue(this.g,new _n)},bn.prototype.ra=function(){ue(this.g,"b")},yn.prototype.createWebChannel=yn.prototype.g,vn.prototype.send=vn.prototype.o,vn.prototype.open=vn.prototype.m,M=function(){return new yn},R=xe,k=Te,N={mb:0,pb:1,qb:2,Jb:3,Ob:4,Lb:5,Mb:6,Kb:7,Ib:8,Nb:9,PROXY:10,NOPROXY:11,Gb:12,Cb:13,Db:14,Bb:15,Eb:16,Fb:17,ib:18,hb:19,jb:20},Oe.NO_ERROR=0,Oe.TIMEOUT=8,Oe.HTTP_ERROR=6,A=Oe,Fe.COMPLETE="complete",C=Fe,(_e.EventType=be).OPEN="a",be.CLOSE="b",be.ERROR="c",be.MESSAGE="d",oe.prototype.listen=oe.prototype.K,D=_e,x=Rt,Ut.prototype.listenOnce=Ut.prototype.L,Ut.prototype.getLastError=Ut.prototype.Ka,Ut.prototype.getLastErrorCode=Ut.prototype.Ba,Ut.prototype.getStatus=Ut.prototype.Z,Ut.prototype.getResponseJson=Ut.prototype.Oa,Ut.prototype.getResponseText=Ut.prototype.oa,Ut.prototype.send=Ut.prototype.ea,Ut.prototype.setWithCredentials=Ut.prototype.Ha,S=Ut}).apply(void 0!==F?F:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{});const P="@firebase/firestore";class V{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}V.UNAUTHENTICATED=new V(null),V.GOOGLE_CREDENTIALS=new V("google-credentials-uid"),V.FIRST_PARTY=new V("first-party-uid"),V.MOCK_USER=new V("mock-user");let U="10.12.2";const B=new class{constructor(e){this.name=e,this._logLevel=w,this._logHandler=b,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(e){if(!(e in n))throw new TypeError(`Invalid value "${e}" assigned to \`logLevel\``);this._logLevel=e}setLogLevel(e){this._logLevel="string"==typeof e?v[e]:e}get logHandler(){return this._logHandler}set logHandler(e){if("function"!=typeof e)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e}get userLogHandler(){return this._userLogHandler}set userLogHandler(e){this._userLogHandler=e}debug(...e){this._userLogHandler&&this._userLogHandler(this,n.DEBUG,...e),this._logHandler(this,n.DEBUG,...e)}log(...e){this._userLogHandler&&this._userLogHandler(this,n.VERBOSE,...e),this._logHandler(this,n.VERBOSE,...e)}info(...e){this._userLogHandler&&this._userLogHandler(this,n.INFO,...e),this._logHandler(this,n.INFO,...e)}warn(...e){this._userLogHandler&&this._userLogHandler(this,n.WARN,...e),this._logHandler(this,n.WARN,...e)}error(...e){this._userLogHandler&&this._userLogHandler(this,n.ERROR,...e),this._logHandler(this,n.ERROR,...e)}}("@firebase/firestore");function q(){return B.logLevel}function j(e,...t){var r;B.logLevel<=n.DEBUG&&(r=t.map(K),B.debug(`Firestore (${U}): ${e}`,...r))}function G(e,...t){var r;B.logLevel<=n.ERROR&&(r=t.map(K),B.error(`Firestore (${U}): ${e}`,...r))}function z(e,...t){var r;B.logLevel<=n.WARN&&(r=t.map(K),B.warn(`Firestore (${U}): ${e}`,...r))}function K(e){if("string"==typeof e)return e;try{return JSON.stringify(e)}catch(t){return e}}function $(e="Unexpected state"){var t=`FIRESTORE (${U}) INTERNAL ASSERTION FAILED: `+e;throw G(t),new Error(t)}function Q(e){e||$()}const H={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class W extends l{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class Y{constructor(){this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}}class J{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class X{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable((()=>t(V.UNAUTHENTICATED)))}shutdown(){}}class Z{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable((()=>t(this.token.user)))}shutdown(){this.changeListener=null}}class ee{constructor(e){this.t=e,this.currentUser=V.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){let n=this.i;const r=e=>this.i!==n?(n=this.i,t(e)):Promise.resolve();let i=new Y;this.o=()=>{this.i++,this.currentUser=this.u(),i.resolve(),i=new Y,e.enqueueRetryable((()=>r(this.currentUser)))};const s=()=>{const t=i;e.enqueueRetryable((async()=>{await t.promise,await r(this.currentUser)}))},a=e=>{j("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.auth.addAuthTokenListener(this.o),s()};this.t.onInit((e=>a(e))),setTimeout((()=>{var e;this.auth||((e=this.t.getImmediate({optional:!0}))?a(e):(j("FirebaseAuthCredentialsProvider","Auth not yet detected"),i.resolve(),i=new Y))}),0),s()}getToken(){const e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then((t=>this.i!==e?(j("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):t?(Q("string"==typeof t.accessToken),new J(t.accessToken,this.currentUser)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){var e=this.auth&&this.auth.getUid();return Q(null===e||"string"==typeof e),new V(e)}}class te{constructor(e,t,n){this.l=e,this.h=t,this.P=n,this.type="FirstParty",this.user=V.FIRST_PARTY,this.I=new Map}T(){return this.P?this.P():null}get headers(){this.I.set("X-Goog-AuthUser",this.l);var e=this.T();return e&&this.I.set("Authorization",e),this.h&&this.I.set("X-Goog-Iam-Authorization-Token",this.h),this.I}}class ne{constructor(e,t,n){this.l=e,this.h=t,this.P=n}getToken(){return Promise.resolve(new te(this.l,this.h,this.P))}start(e,t){e.enqueueRetryable((()=>t(V.FIRST_PARTY)))}shutdown(){}invalidateToken(){}}class re{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&0<e.length&&this.headers.set("x-firebase-appcheck",this.value)}}class ie{constructor(e){this.A=e,this.forceRefresh=!1,this.appCheck=null,this.R=null}start(e,t){const n=e=>{null!=e.error&&j("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);var n=e.token!==this.R;return this.R=e.token,j("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?t(e.token):Promise.resolve()};this.o=t=>{e.enqueueRetryable((()=>n(t)))};const r=e=>{j("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.appCheck.addTokenListener(this.o)};this.A.onInit((e=>r(e))),setTimeout((()=>{var e;this.appCheck||((e=this.A.getImmediate({optional:!0}))?r(e):j("FirebaseAppCheckTokenProvider","AppCheck not yet detected"))}),0)}getToken(){var e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then((e=>e?(Q("string"==typeof e.token),this.R=e.token,new re(e.token)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}class se{static newId(){var e=62*Math.floor(256/62);let t="";for(;t.length<20;){var n=function(e){const t="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(40);if(t&&"function"==typeof t.getRandomValues)t.getRandomValues(n);else for(let e=0;e<40;e++)n[e]=Math.floor(256*Math.random());return n}();for(let r=0;r<n.length;++r)t.length<20&&n[r]<e&&(t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(n[r]%62))}return t}}function ae(e,t){return e<t?-1:t<e?1:0}function oe(e,t,n){return e.length===t.length&&e.every(((e,r)=>n(e,t[r])))}function ue(e){return e+"\0"}class ce{constructor(e,t){if(this.seconds=e,(this.nanoseconds=t)<0)throw new W(H.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(1e9<=t)throw new W(H.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new W(H.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(253402300800<=e)throw new W(H.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return ce.fromMillis(Date.now())}static fromDate(e){return ce.fromMillis(e.getTime())}static fromMillis(e){var t=Math.floor(e/1e3),n=Math.floor(1e6*(e-1e3*t));return new ce(t,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?ae(this.nanoseconds,e.nanoseconds):ae(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){var e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class he{constructor(e){this.timestamp=e}static fromTimestamp(e){return new he(e)}static min(){return new he(new ce(0,0))}static max(){return new he(new ce(253402300799,999999999))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class le{constructor(e,t,n){void 0===t?t=0:t>e.length&&$(),void 0===n?n=e.length-t:n>e.length-t&&$(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===le.comparator(this,e)}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof le?e.forEach((e=>{t.push(e)})):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return this.construct(this.segments,this.offset+(e=void 0===e?1:e),this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){const n=Math.min(e.length,t.length);for(let r=0;r<n;r++){const n=e.get(r),i=t.get(r);if(n<i)return-1;if(n>i)return 1}return e.length<t.length?-1:e.length>t.length?1:0}}class de extends le{construct(e,t,n){return new de(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...e){const t=[];for(const n of e){if(0<=n.indexOf("//"))throw new W(H.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter((e=>0<e.length)))}return new de(t)}static emptyPath(){return new de([])}}const fe=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class ge extends le{construct(e,t,n){return new ge(e,t,n)}static isValidIdentifier(e){return fe.test(e)}canonicalString(){return this.toArray().map((e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),ge.isValidIdentifier(e)?e:"`"+e+"`"))).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new ge(["__name__"])}static fromServerFormat(e){const t=[];let n="",r=0;var i=()=>{if(0===n.length)throw new W(H.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""};let s=!1;for(;r<e.length;){const t=e[r];if("\\"===t){if(r+1===e.length)throw new W(H.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new W(H.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?s=!s:"."!==t||s?n+=t:i(),r++}if(i(),s)throw new W(H.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new ge(t)}static emptyPath(){return new ge([])}}class me{constructor(e){this.path=e}static fromPath(e){return new me(de.fromString(e))}static fromName(e){return new me(de.fromString(e).popFirst(5))}static empty(){return new me(de.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return 2<=this.path.length&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===de.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return de.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new me(new de(e.slice()))}}class pe{constructor(e,t,n,r){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=r}}function ye(e){return e.fields.find((e=>2===e.kind))}function ve(e){return e.fields.filter((e=>2!==e.kind))}pe.UNKNOWN_ID=-1;class we{constructor(e,t){this.fieldPath=e,this.kind=t}}class _e{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new _e(0,Ee.min())}}function be(e,t){var n=e.toTimestamp().seconds,r=e.toTimestamp().nanoseconds+1;return r=he.fromTimestamp(1e9===r?new ce(n+1,0):new ce(n,r)),new Ee(r,me.empty(),t)}function Ie(e){return new Ee(e.readTime,e.key,-1)}class Ee{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new Ee(he.min(),me.empty(),-1)}static max(){return new Ee(he.max(),me.empty(),-1)}}function Te(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n?n:(n=me.comparator(e.documentKey,t.documentKey),0!==n?n:ae(e.largestBatchId,t.largestBatchId))}const Se="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class xe{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach((e=>e()))}}async function De(e){if(e.code!==H.FAILED_PRECONDITION||e.message!==Se)throw e;j("LocalStore","Unexpectedly lost primary lease")}class Ce{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e((e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)}),(e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)}))}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&$(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new Ce(((n,r)=>{this.nextCallback=t=>{this.wrapSuccess(e,t).next(n,r)},this.catchCallback=e=>{this.wrapFailure(t,e).next(n,r)}}))}toPromise(){return new Promise(((e,t)=>{this.next(e,t)}))}wrapUserFunction(e){try{var t=e();return t instanceof Ce?t:Ce.resolve(t)}catch(e){return Ce.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction((()=>e(t))):Ce.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction((()=>e(t))):Ce.reject(t)}static resolve(e){return new Ce(((t,n)=>{t(e)}))}static reject(e){return new Ce(((t,n)=>{n(e)}))}static waitFor(e){return new Ce(((t,n)=>{let r=0,i=0,s=!1;e.forEach((e=>{++r,e.next((()=>{++i,s&&i===r&&t()}),(e=>n(e)))})),s=!0,i===r&&t()}))}static or(e){let t=Ce.resolve(!1);for(const n of e)t=t.next((e=>e?Ce.resolve(e):n()));return t}static forEach(e,t){const n=[];return e.forEach(((e,r)=>{n.push(t.call(this,e,r))})),this.waitFor(n)}static mapArray(e,t){return new Ce(((n,r)=>{const i=e.length,s=new Array(i);let a=0;for(let o=0;o<i;o++){const u=o;t(e[u]).next((e=>{s[u]=e,++a,a===i&&n(s)}),(e=>r(e)))}}))}static doWhile(e,t){return new Ce(((n,r)=>{const i=()=>{!0===e()?t().next((()=>{i()}),r):n()};i()}))}}class Ae{constructor(e,t){this.action=e,this.transaction=t,this.aborted=!1,this.V=new Y,this.transaction.oncomplete=()=>{this.V.resolve()},this.transaction.onabort=()=>{t.error?this.V.reject(new Me(e,t.error)):this.V.resolve()},this.transaction.onerror=t=>{var n=Ve(t.target.error);this.V.reject(new Me(e,n))}}static open(e,t,n,r){try{return new Ae(t,e.transaction(r,n))}catch(e){throw new Me(t,e)}}get m(){return this.V.promise}abort(e){e&&this.V.reject(e),this.aborted||(j("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}g(){const e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){var t=this.transaction.objectStore(e);return new Oe(t)}}class Ne{constructor(e,t,n){this.name=e,this.version=t,this.p=n,12.2===Ne.S(c())&&G("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(e){return j("SimpleDb","Removing database:",e),Fe(window.indexedDB.deleteDatabase(e)).toPromise()}static D(){if(!function(){try{return"object"==typeof indexedDB}catch(e){return}}())return!1;if(Ne.C())return!0;const e=c(),t=Ne.S(e),n=0<t&&t<10,r=ke(e),i=0<r&&r<4.5;return!(0<e.indexOf("MSIE ")||0<e.indexOf("Trident/")||0<e.indexOf("Edge/")||n||i)}static C(){var e;return"undefined"!=typeof process&&"YES"===(null===(e=process.__PRIVATE_env)||void 0===e?void 0:e.v)}static F(e,t){return e.store(t)}static S(e){const t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(n)}async M(e){return this.db||(j("SimpleDb","Opening database:",this.name),this.db=await new Promise(((t,n)=>{const r=indexedDB.open(this.name,this.version);r.onsuccess=e=>{var n=e.target.result;t(n)},r.onblocked=()=>{n(new Me(e,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=t=>{var r=t.target.error;"VersionError"===r.name?n(new W(H.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===r.name?n(new W(H.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+r)):n(new Me(e,r))},r.onupgradeneeded=e=>{j("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);var t=e.target.result;this.p.O(t,r.transaction,e.oldVersion,this.version).next((()=>{j("SimpleDb","Database upgrade to version "+this.version+" complete")}))}}))),this.N&&(this.db.onversionchange=e=>this.N(e)),this.db}L(e){this.N=e,this.db&&(this.db.onversionchange=t=>e(t))}async runTransaction(e,t,n,r){var i="readonly"===t;let s=0;for(;;){++s;try{this.db=await this.M(e);const t=Ae.open(this.db,e,i?"readonly":"readwrite",n),s=r(t).next((e=>(t.g(),e))).catch((e=>(t.abort(e),Ce.reject(e)))).toPromise();return s.catch((()=>{})),await t.m,s}catch(e){const t=e,n="FirebaseError"!==t.name&&s<3;if(j("SimpleDb","Transaction failed with error:",t.message,"Retrying:",n),this.close(),!n)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}function ke(e){const t=e.match(/Android ([\d.]+)/i),n=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(n)}class Re{constructor(e){this.B=e,this.k=!1,this.q=null}get isDone(){return this.k}get K(){return this.q}set cursor(e){this.B=e}done(){this.k=!0}$(e){this.q=e}delete(){return Fe(this.B.delete())}}class Me extends W{constructor(e,t){super(H.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function Le(e){return"IndexedDbTransactionError"===e.name}class Oe{constructor(e){this.store=e}put(e,t){let n;return n=void 0!==t?(j("SimpleDb","PUT",this.store.name,e,t),this.store.put(t,e)):(j("SimpleDb","PUT",this.store.name,"<auto-key>",e),this.store.put(e)),Fe(n)}add(e){return j("SimpleDb","ADD",this.store.name,e,e),Fe(this.store.add(e))}get(e){return Fe(this.store.get(e)).next((t=>(j("SimpleDb","GET",this.store.name,e,t=void 0===t?null:t),t)))}delete(e){return j("SimpleDb","DELETE",this.store.name,e),Fe(this.store.delete(e))}count(){return j("SimpleDb","COUNT",this.store.name),Fe(this.store.count())}U(e,t){const n=this.options(e,t),r=n.index?this.store.index(n.index):this.store;if("function"==typeof r.getAll){const e=r.getAll(n.range);return new Ce(((t,n)=>{e.onerror=e=>{n(e.target.error)},e.onsuccess=e=>{t(e.target.result)}}))}{const e=this.cursor(n),t=[];return this.W(e,((e,n)=>{t.push(n)})).next((()=>t))}}G(e,t){const n=this.store.getAll(e,null===t?void 0:t);return new Ce(((e,t)=>{n.onerror=e=>{t(e.target.error)},n.onsuccess=t=>{e(t.target.result)}}))}j(e,t){j("SimpleDb","DELETE ALL",this.store.name);const n=this.options(e,t);n.H=!1;var r=this.cursor(n);return this.W(r,((e,t,n)=>n.delete()))}J(e,t){let n;t?n=e:(n={},t=e);var r=this.cursor(n);return this.W(r,t)}Y(e){const t=this.cursor({});return new Ce(((n,r)=>{t.onerror=e=>{var t=Ve(e.target.error);r(t)},t.onsuccess=t=>{const r=t.target.result;r?e(r.primaryKey,r.value).next((e=>{e?r.continue():n()})):n()}}))}W(e,t){const n=[];return new Ce(((r,i)=>{e.onerror=e=>{i(e.target.error)},e.onsuccess=e=>{const i=e.target.result;if(i){const e=new Re(i),s=t(i.primaryKey,i.value,e);if(s instanceof Ce){const t=s.catch((t=>(e.done(),Ce.reject(t))));n.push(t)}e.isDone?r():null===e.K?i.continue():i.continue(e.K)}else r()}})).next((()=>Ce.waitFor(n)))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){const n=this.store.index(e.index);return e.H?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function Fe(e){return new Ce(((t,n)=>{e.onsuccess=e=>{var n=e.target.result;t(n)},e.onerror=e=>{var t=Ve(e.target.error);n(t)}}))}let Pe=!1;function Ve(e){const t=Ne.S(c());if(12.2<=t&&t<13){const t="An internal error was encountered in the Indexed Database server";if(0<=e.message.indexOf(t)){const e=new W("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return Pe||(Pe=!0,setTimeout((()=>{throw e}),0)),e}}return e}class Ue{constructor(e,t){this.asyncQueue=e,this.Z=t,this.task=null}start(){this.X(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}X(e){j("IndexBackfiller",`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,(async()=>{this.task=null;try{j("IndexBackfiller",`Documents written: ${await this.Z.ee()}`)}catch(e){Le(e)?j("IndexBackfiller","Ignoring IndexedDB error during index backfill: ",e):await De(e)}await this.X(6e4)}))}}class Be{constructor(e,t){this.localStore=e,this.persistence=t}async ee(e=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",(t=>this.te(t,e)))}te(e,t){const n=new Set;let r=t,i=!0;return Ce.doWhile((()=>!0===i&&0<r),(()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next((t=>null===t||n.has(t)?void(i=!1):(j("IndexBackfiller",`Processing collection: ${t}`),this.ne(e,t,r).next((e=>{r-=e,n.add(t)}))))))).next((()=>t-r))}ne(e,t,n){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(e,t).next((r=>this.localStore.localDocuments.getNextDocuments(e,t,r,n).next((n=>{const i=n.changes;return this.localStore.indexManager.updateIndexEntries(e,i).next((()=>this.re(r,n))).next((n=>(j("IndexBackfiller",`Updating offset: ${n}`),this.localStore.indexManager.updateCollectionGroup(e,t,n)))).next((()=>i.size))}))))}re(e,t){let n=e;return t.changes.forEach(((e,t)=>{var r=Ie(t);0<Te(r,n)&&(n=r)})),new Ee(n.readTime,n.documentKey,Math.max(t.batchId,e.largestBatchId))}}class qe{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.ie(e),this.se=e=>t.writeSequenceNumber(e))}ie(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){var e=++this.previousValue;return this.se&&this.se(e),e}}function je(e){return null==e}function Ge(e){return 0===e&&1/e==-1/0}function ze(e){return"number"==typeof e&&Number.isInteger(e)&&!Ge(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}function Ke(e){let t="";for(let n=0;n<e.length;n++)0<t.length&&(t=$e(t)),t=function(e,t){let n=t;const r=e.length;for(let t=0;t<r;t++){const r=e.charAt(t);switch(r){case"\0":n+="";break;case"":n+="";break;default:n+=r}}return n}(e.get(n),t);return $e(t)}function $e(e){return e+""}function Qe(e){const t=e.length;if(Q(2<=t),2===t)return Q(""===e.charAt(0)&&""===e.charAt(1)),de.emptyPath();const n=t-2,r=[];let i="";for(let a=0;a<t;){const t=e.indexOf("",a);switch((t<0||t>n)&&$(),e.charAt(t+1)){case"":var s=e.substring(a,t);let n;0===i.length?n=s:(i+=s,n=i,i=""),r.push(n);break;case"":i+=e.substring(a,t),i+="\0";break;case"":i+=e.substring(a,t+1);break;default:$()}a=t+2}return new de(r)}qe.oe=-1;const He=["userId","batchId"];function We(e,t){return[e,Ke(t)]}function Ye(e,t,n){return[e,Ke(t),n]}const Je={},Xe=["prefixPath","collectionGroup","readTime","documentId"],Ze=["prefixPath","collectionGroup","documentId"],et=["collectionGroup","readTime","prefixPath","documentId"],tt=["canonicalId","targetId"],nt=["targetId","path"],rt=["path","targetId"],it=["collectionId","parent"],st=["indexId","uid"],at=["uid","sequenceNumber"],ot=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],ut=["indexId","uid","orderedDocumentKey"],ct=["userId","collectionPath","documentId"],ht=["userId","collectionPath","largestBatchId"],lt=["userId","collectionGroup","largestBatchId"],dt=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],ft=[...dt,"documentOverlays"],gt=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],mt=gt,pt=[...mt,"indexConfiguration","indexState","indexEntries"],yt=pt;class vt extends xe{constructor(e,t){super(),this._e=e,this.currentSequenceNumber=t}}function wt(e,t){var n=e;return Ne.F(n._e,t)}function _t(e){let t=0;for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function bt(e,t){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function It(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}class Et{constructor(e,t){this.comparator=e,this.root=t||St.EMPTY}insert(e,t){return new Et(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,St.BLACK,null,null))}remove(e){return new Et(this.comparator,this.root.remove(e,this.comparator).copy(null,null,St.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){var n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:0<n&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){var r=this.comparator(e,n.key);if(0===r)return t+n.left.size;n=r<0?n.left:(t+=n.left.size+1,n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal(((t,n)=>(e(t,n),!1)))}toString(){const e=[];return this.inorderTraversal(((t,n)=>(e.push(`${t}:${n}`),!1))),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new Tt(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new Tt(this.root,e,this.comparator,!1)}getReverseIterator(){return new Tt(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new Tt(this.root,e,this.comparator,!0)}}class Tt{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let i=1;for(;!e.isEmpty();)if(i=t?n(e.key,t):1,t&&r&&(i*=-1),i<0)e=this.isReverse?e.left:e.right;else{if(0===i){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();var t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return 0<this.nodeStack.length}peek(){if(0===this.nodeStack.length)return null;var e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class St{constructor(e,t,n,r,i){this.key=e,this.value=t,this.color=null!=n?n:St.RED,this.left=null!=r?r:St.EMPTY,this.right=null!=i?i:St.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,i){return new St(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=i?i:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this;var i=n(e,r.key);return r=i<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===i?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n)),r.fixUp()}removeMin(){if(this.left.isEmpty())return St.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let n,r=this;if(t(e,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(e,t),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===t(e,r.key)){if(r.right.isEmpty())return St.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){var e=this.copy(null,null,St.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){var e=this.copy(null,null,St.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){var e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){var e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw $();if(this.right.isRed())throw $();var e=this.left.check();if(e!==this.right.check())throw $();return e+(this.isRed()?0:1)}}St.EMPTY=null,St.RED=!0,St.BLACK=!1,St.EMPTY=new class{constructor(){this.size=0}get key(){throw $()}get value(){throw $()}get color(){throw $()}get left(){throw $()}get right(){throw $()}copy(e,t,n,r,i){return this}insert(e,t,n){return new St(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class xt{constructor(e){this.comparator=e,this.data=new Et(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal(((t,n)=>(e(t),!1)))}forEachInRange(e,t){const n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){var r=n.getNext();if(0<=this.comparator(r.key,e[1]))return;t(r.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){const t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new Dt(this.data.getIterator())}getIteratorFrom(e){return new Dt(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach((e=>{t=t.add(e)})),t}isEqual(e){if(!(e instanceof xt))return!1;if(this.size!==e.size)return!1;const t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){const e=[];return this.forEach((t=>{e.push(t)})),e}toString(){const e=[];return this.forEach((t=>e.push(t))),"SortedSet("+e.toString()+")"}copy(e){const t=new xt(this.comparator);return t.data=e,t}}class Dt{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function Ct(e){return e.hasNext()?e.getNext():void 0}class At{constructor(e){(this.fields=e).sort(ge.comparator)}static empty(){return new At([])}unionWith(e){let t=new xt(ge.comparator);for(const e of this.fields)t=t.add(e);for(const n of e)t=t.add(n);return new At(t.toArray())}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return oe(this.fields,e.fields,((e,t)=>e.isEqual(t)))}}class Nt extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}class kt{constructor(e){this.binaryString=e}static fromBase64String(e){var t=function(e){try{return atob(e)}catch(e){throw"undefined"!=typeof DOMException&&e instanceof DOMException?new Nt("Invalid base64 string: "+e):e}}(e);return new kt(t)}static fromUint8Array(e){var t=function(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e);return new kt(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return e=this.binaryString,btoa(e);var e}toUint8Array(){return function(e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return ae(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}kt.EMPTY_BYTE_STRING=new kt("");const Rt=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function Mt(e){if(Q(!!e),"string"!=typeof e)return{seconds:Lt(e.seconds),nanos:Lt(e.nanos)};{let n=0;var t=Rt.exec(e);Q(!!t),t[1]&&(t=((t=t[1])+"000000000").substr(0,9),n=Number(t));const r=new Date(e);return{seconds:Math.floor(r.getTime()/1e3),nanos:n}}}function Lt(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function Ot(e){return"string"==typeof e?kt.fromBase64String(e):kt.fromUint8Array(e)}function Ft(e){var t;return"server_timestamp"===(null===(t=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{}).__type__)||void 0===t?void 0:t.stringValue)}function Pt(e){var t=e.mapValue.fields.__previous_value__;return Ft(t)?Pt(t):t}function Vt(e){var t=Mt(e.mapValue.fields.__local_write_time__.timestampValue);return new ce(t.seconds,t.nanos)}class Ut{constructor(e,t,n,r,i,s,a,o,u){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=i,this.forceLongPolling=s,this.autoDetectLongPolling=a,this.longPollingOptions=o,this.useFetchStreams=u}}class Bt{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new Bt("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(e){return e instanceof Bt&&e.projectId===this.projectId&&e.database===this.database}}const qt={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},jt={nullValue:"NULL_VALUE"};function Gt(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?Ft(e)?4:nn(e)?9007199254740991:10:$()}function zt(e,t){if(e===t)return!0;var n,r,i=Gt(e);if(i!==Gt(t))return!1;switch(i){case 0:case 9007199254740991:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return Vt(e).isEqual(Vt(t));case 3:return function(e,t){if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;var n=Mt(e.timestampValue),r=Mt(t.timestampValue);return n.seconds===r.seconds&&n.nanos===r.nanos}(e,t);case 5:return e.stringValue===t.stringValue;case 6:return r=t,Ot(e.bytesValue).isEqual(Ot(r.bytesValue));case 7:return e.referenceValue===t.referenceValue;case 8:return n=t,Lt((r=e).geoPointValue.latitude)===Lt(n.geoPointValue.latitude)&&Lt(r.geoPointValue.longitude)===Lt(n.geoPointValue.longitude);case 2:return function(e,t){if("integerValue"in e&&"integerValue"in t)return Lt(e.integerValue)===Lt(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){var n=Lt(e.doubleValue),r=Lt(t.doubleValue);return n===r?Ge(n)===Ge(r):isNaN(n)&&isNaN(r)}return!1}(e,t);case 9:return oe(e.arrayValue.values||[],t.arrayValue.values||[],zt);case 10:return function(e,t){const n=e.mapValue.fields||{},r=t.mapValue.fields||{};if(_t(n)!==_t(r))return!1;for(const e in n)if(n.hasOwnProperty(e)&&(void 0===r[e]||!zt(n[e],r[e])))return!1;return!0}(e,t);default:return $()}}function Kt(e,t){return void 0!==(e.values||[]).find((e=>zt(e,t)))}function $t(e,t){if(e===t)return 0;var n,r,i,s,a=Gt(e),o=Gt(t);if(a!==o)return ae(a,o);switch(a){case 0:case 9007199254740991:return 0;case 1:return ae(e.booleanValue,t.booleanValue);case 2:return r=t,(i=Lt((n=e).integerValue||n.doubleValue))<(s=Lt(r.integerValue||r.doubleValue))?-1:s<i?1:i===s?0:isNaN(i)?isNaN(s)?0:-1:1;case 3:return Qt(e.timestampValue,t.timestampValue);case 4:return Qt(Vt(e),Vt(t));case 5:return ae(e.stringValue,t.stringValue);case 6:return function(e,t){const n=Ot(e),r=Ot(t);return n.compareTo(r)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){var n=e.split("/"),r=t.split("/");for(let e=0;e<n.length&&e<r.length;e++){const t=ae(n[e],r[e]);if(0!==t)return t}return ae(n.length,r.length)}(e.referenceValue,t.referenceValue);case 8:return n=e.geoPointValue,r=t.geoPointValue,0!==(s=ae(Lt(n.latitude),Lt(r.latitude)))?s:ae(Lt(n.longitude),Lt(r.longitude));case 9:return function(e,t){var n=e.values||[],r=t.values||[];for(let e=0;e<n.length&&e<r.length;++e){const t=$t(n[e],r[e]);if(t)return t}return ae(n.length,r.length)}(e.arrayValue,t.arrayValue);case 10:return function(e,t){if(e===qt.mapValue&&t===qt.mapValue)return 0;if(e===qt.mapValue)return 1;if(t===qt.mapValue)return-1;const n=e.fields||{},r=Object.keys(n),i=t.fields||{},s=Object.keys(i);r.sort(),s.sort();for(let e=0;e<r.length&&e<s.length;++e){const t=ae(r[e],s[e]);if(0!==t)return t;var a=$t(n[r[e]],i[s[e]]);if(0!==a)return a}return ae(r.length,s.length)}(e.mapValue,t.mapValue);default:throw $()}}function Qt(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return ae(e,t);var n=Mt(e),r=Mt(t),i=ae(n.seconds,r.seconds);return 0!==i?i:ae(n.nanos,r.nanos)}function Ht(e){return function e(t){return"nullValue"in t?"null":"booleanValue"in t?""+t.booleanValue:"integerValue"in t?""+t.integerValue:"doubleValue"in t?""+t.doubleValue:"timestampValue"in t?function(e){const t=Mt(e);return`time(${t.seconds},${t.nanos})`}(t.timestampValue):"stringValue"in t?t.stringValue:"bytesValue"in t?function(e){return Ot(e).toBase64()}(t.bytesValue):"referenceValue"in t?function(e){return me.fromName(e).toString()}(t.referenceValue):"geoPointValue"in t?function(e){return`geo(${e.latitude},${e.longitude})`}(t.geoPointValue):"arrayValue"in t?function(t){let n="[",r=!0;for(const i of t.values||[])r?r=!1:n+=",",n+=e(i);return n+"]"}(t.arrayValue):"mapValue"in t?function(t){const n=Object.keys(t.fields||{}).sort();let r="{",i=!0;for(const s of n)i?i=!1:r+=",",r+=`${s}:${e(t.fields[s])}`;return r+"}"}(t.mapValue):$()}(e)}function Wt(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function Yt(e){return!!e&&"integerValue"in e}function Jt(e){return!!e&&"arrayValue"in e}function Xt(e){return e&&"nullValue"in e}function Zt(e){return e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function en(e){return e&&"mapValue"in e}function tn(e){if(e.geoPointValue)return{geoPointValue:Object.assign({},e.geoPointValue)};if(e.timestampValue&&"object"==typeof e.timestampValue)return{timestampValue:Object.assign({},e.timestampValue)};if(e.mapValue){const t={mapValue:{fields:{}}};return bt(e.mapValue.fields,((e,n)=>t.mapValue.fields[e]=tn(n))),t}if(e.arrayValue){const t={arrayValue:{values:[]}};for(let n=0;n<(e.arrayValue.values||[]).length;++n)t.arrayValue.values[n]=tn(e.arrayValue.values[n]);return t}return Object.assign({},e)}function nn(e){return"__max__"===(((e.mapValue||{}).fields||{}).__type__||{}).stringValue}function rn(e,t){var n=$t(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function sn(e,t){var n=$t(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}class an{constructor(e){this.value=e}static empty(){return new an({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let n=0;n<e.length-1;++n)if(t=(t.mapValue.fields||{})[e.get(n)],!en(t))return null;return t=(t.mapValue.fields||{})[e.lastSegment()],t||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=tn(t)}setAll(e){let t=ge.emptyPath(),n={},r=[];e.forEach(((e,i)=>{if(!t.isImmediateParentOf(i)){const e=this.getFieldsMap(t);this.applyChanges(e,n,r),n={},r=[],t=i.popLast()}e?n[i.lastSegment()]=tn(e):r.push(i.lastSegment())}));var i=this.getFieldsMap(t);this.applyChanges(i,n,r)}delete(e){const t=this.field(e.popLast());en(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return zt(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let n=0;n<e.length;++n){let r=t.mapValue.fields[e.get(n)];en(r)&&r.mapValue.fields||(r={mapValue:{fields:{}}},t.mapValue.fields[e.get(n)]=r),t=r}return t.mapValue.fields}applyChanges(e,t,n){bt(t,((t,n)=>e[t]=n));for(const t of n)delete e[t]}clone(){return new an(tn(this.value))}}class on{constructor(e,t,n,r,i,s,a){this.key=e,this.documentType=t,this.version=n,this.readTime=r,this.createTime=i,this.data=s,this.documentState=a}static newInvalidDocument(e){return new on(e,0,he.min(),he.min(),he.min(),an.empty(),0)}static newFoundDocument(e,t,n,r){return new on(e,1,t,he.min(),n,r,0)}static newNoDocument(e,t){return new on(e,2,t,he.min(),he.min(),an.empty(),0)}static newUnknownDocument(e,t){return new on(e,3,t,he.min(),he.min(),an.empty(),2)}convertToFoundDocument(e,t){return!this.createTime.isEqual(he.min())||2!==this.documentType&&0!==this.documentType||(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=an.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=an.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=he.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof on&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new on(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class un{constructor(e,t){this.position=e,this.inclusive=t}}function cn(e,t,n){let r=0;for(let i=0;i<e.position.length;i++){const s=t[i],a=e.position[i];if(r=s.field.isKeyField()?me.comparator(me.fromName(a.referenceValue),n.key):$t(a,n.data.field(s.field)),"desc"===s.dir&&(r*=-1),0!==r)break}return r}function hn(e,t){if(null===e)return null===t;if(null===t)return!1;if(e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++)if(!zt(e.position[n],t.position[n]))return!1;return!0}class ln{constructor(e,t="asc"){this.field=e,this.dir=t}}class dn{}class fn extends dn{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,n):new bn(e,t,n):"array-contains"===t?new Sn(e,n):"in"===t?new xn(e,n):"not-in"===t?new Dn(e,n):"array-contains-any"===t?new Cn(e,n):new fn(e,t,n)}static createKeyFieldInFilter(e,t,n){return new("in"===t?In:En)(e,n)}matches(e){var t=e.data.field(this.field);return"!="===this.op?null!==t&&this.matchesComparison($t(t,this.value)):null!==t&&Gt(this.value)===Gt(t)&&this.matchesComparison($t(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return 0<e;case">=":return 0<=e;default:return $()}}isInequality(){return 0<=["<","<=",">",">=","!=","not-in"].indexOf(this.op)}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class gn extends dn{constructor(e,t){super(),this.filters=e,this.op=t,this.ae=null}static create(e,t){return new gn(e,t)}matches(e){return mn(this)?void 0===this.filters.find((t=>!t.matches(e))):void 0!==this.filters.find((t=>t.matches(e)))}getFlattenedFilters(){return null!==this.ae||(this.ae=this.filters.reduce(((e,t)=>e.concat(t.getFlattenedFilters())),[])),this.ae}getFilters(){return Object.assign([],this.filters)}}function mn(e){return"and"===e.op}function pn(e){return"or"===e.op}function yn(e){return vn(e)&&mn(e)}function vn(e){for(const t of e.filters)if(t instanceof gn)return!1;return!0}function wn(e,t){var n=e.filters.concat(t);return gn.create(n,e.op)}function _n(e){return e instanceof fn?`${(t=e).field.canonicalString()} ${t.op} ${Ht(t.value)}`:e instanceof gn?e.op.toString()+" {"+e.getFilters().map(_n).join(" ,")+"}":"Filter";var t}class bn extends fn{constructor(e,t,n){super(e,t,n),this.key=me.fromName(n.referenceValue)}matches(e){var t=me.comparator(e.key,this.key);return this.matchesComparison(t)}}class In extends fn{constructor(e,t){super(e,"in",t),this.keys=Tn(0,t)}matches(e){return this.keys.some((t=>t.isEqual(e.key)))}}class En extends fn{constructor(e,t){super(e,"not-in",t),this.keys=Tn(0,t)}matches(e){return!this.keys.some((t=>t.isEqual(e.key)))}}function Tn(e,t){var n;return((null===(n=t.arrayValue)||void 0===n?void 0:n.values)||[]).map((e=>me.fromName(e.referenceValue)))}class Sn extends fn{constructor(e,t){super(e,"array-contains",t)}matches(e){var t=e.data.field(this.field);return Jt(t)&&Kt(t.arrayValue,this.value)}}class xn extends fn{constructor(e,t){super(e,"in",t)}matches(e){var t=e.data.field(this.field);return null!==t&&Kt(this.value.arrayValue,t)}}class Dn extends fn{constructor(e,t){super(e,"not-in",t)}matches(e){if(Kt(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;var t=e.data.field(this.field);return null!==t&&!Kt(this.value.arrayValue,t)}}class Cn extends fn{constructor(e,t){super(e,"array-contains-any",t)}matches(e){const t=e.data.field(this.field);return!(!Jt(t)||!t.arrayValue.values)&&t.arrayValue.values.some((e=>Kt(this.value.arrayValue,e)))}}class An{constructor(e,t=null,n=[],r=[],i=null,s=null,a=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=i,this.startAt=s,this.endAt=a,this.ue=null}}function Nn(e,t=null,n=[],r=[],i=null,s=null,a=null){return new An(e,t,n,r,i,s,a)}function kn(e){const t=e;if(null===t.ue){let e=t.path.canonicalString();null!==t.collectionGroup&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map((e=>function e(t){if(t instanceof fn)return t.field.canonicalString()+t.op.toString()+Ht(t.value);if(yn(t))return t.filters.map((t=>e(t))).join(",");var n=t.filters.map((t=>e(t))).join(",");return`${t.op}(${n})`}(e))).join(","),e+="|ob:",e+=t.orderBy.map((e=>function(e){return e.field.canonicalString()+e.dir}(e))).join(","),je(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map((e=>Ht(e))).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map((e=>Ht(e))).join(",")),t.ue=e}return t.ue}function Rn(e,t){if(e.limit!==t.limit)return!1;if(e.orderBy.length!==t.orderBy.length)return!1;for(let i=0;i<e.orderBy.length;i++)if(n=e.orderBy[i],r=t.orderBy[i],n.dir!==r.dir||!n.field.isEqual(r.field))return!1;var n,r;if(e.filters.length!==t.filters.length)return!1;for(let n=0;n<e.filters.length;n++)if(!function e(t,n){return t instanceof fn?(i=t,(s=n)instanceof fn&&i.op===s.op&&i.field.isEqual(s.field)&&zt(i.value,s.value)):t instanceof gn?(r=n)instanceof gn&&t.op===r.op&&t.filters.length===r.filters.length&&t.filters.reduce(((t,n,i)=>t&&e(n,r.filters[i])),!0):void $();var r,i,s}(e.filters[n],t.filters[n]))return!1;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!hn(e.startAt,t.startAt)&&hn(e.endAt,t.endAt)}function Mn(e){return me.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function Ln(e,t){return e.filters.filter((e=>e instanceof fn&&e.field.isEqual(t)))}function On(e,t,n){let r=jt,i=!0;for(const n of Ln(e,t)){let e=jt,t=!0;switch(n.op){case"<":case"<=":e="nullValue"in(s=n.value)?jt:"booleanValue"in s?{booleanValue:!1}:"integerValue"in s||"doubleValue"in s?{doubleValue:NaN}:"timestampValue"in s?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in s?{stringValue:""}:"bytesValue"in s?{bytesValue:""}:"referenceValue"in s?Wt(Bt.empty(),me.empty()):"geoPointValue"in s?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in s?{arrayValue:{}}:"mapValue"in s?{mapValue:{}}:$();break;case"==":case"in":case">=":e=n.value;break;case">":e=n.value,t=!1;break;case"!=":case"not-in":e=jt}rn({value:r,inclusive:i},{value:e,inclusive:t})<0&&(r=e,i=t)}var s;if(null!==n)for(let s=0;s<e.orderBy.length;++s)if(e.orderBy[s].field.isEqual(t)){const e=n.position[s];rn({value:r,inclusive:i},{value:e,inclusive:n.inclusive})<0&&(r=e,i=n.inclusive);break}return{value:r,inclusive:i}}function Fn(e,t,n){let r=qt,i=!0;for(const n of Ln(e,t)){let e=qt,t=!0;switch(n.op){case">=":case">":e="nullValue"in(s=n.value)?{booleanValue:!1}:"booleanValue"in s?{doubleValue:NaN}:"integerValue"in s||"doubleValue"in s?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in s?{stringValue:""}:"stringValue"in s?{bytesValue:""}:"bytesValue"in s?Wt(Bt.empty(),me.empty()):"referenceValue"in s?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in s?{arrayValue:{}}:"arrayValue"in s?{mapValue:{}}:"mapValue"in s?qt:$(),t=!1;break;case"==":case"in":case"<=":e=n.value;break;case"<":e=n.value,t=!1;break;case"!=":case"not-in":e=qt}0<sn({value:r,inclusive:i},{value:e,inclusive:t})&&(r=e,i=t)}var s;if(null!==n)for(let s=0;s<e.orderBy.length;++s)if(e.orderBy[s].field.isEqual(t)){const e=n.position[s];0<sn({value:r,inclusive:i},{value:e,inclusive:n.inclusive})&&(r=e,i=n.inclusive);break}return{value:r,inclusive:i}}class Pn{constructor(e,t=null,n=[],r=[],i=null,s="F",a=null,o=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=i,this.limitType=s,this.startAt=a,this.endAt=o,this.ce=null,this.le=null,this.he=null,this.startAt,this.endAt}}function Vn(e,t,n,r,i,s,a,o){return new Pn(e,t,n,r,i,s,a,o)}function Un(e){return new Pn(e)}function Bn(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function qn(e){return null!==e.collectionGroup}function jn(e){const t=e;if(null===t.ce){t.ce=[];const e=new Set;for(const n of t.explicitOrderBy)t.ce.push(n),e.add(n.field.canonicalString());const n=0<t.explicitOrderBy.length?t.explicitOrderBy[t.explicitOrderBy.length-1].dir:"asc",r=function(e){let t=new xt(ge.comparator);return e.filters.forEach((e=>{e.getFlattenedFilters().forEach((e=>{e.isInequality()&&(t=t.add(e.field))}))})),t}(t);r.forEach((r=>{e.has(r.canonicalString())||r.isKeyField()||t.ce.push(new ln(r,n))})),e.has(ge.keyField().canonicalString())||t.ce.push(new ln(ge.keyField(),n))}return t.ce}function Gn(e){const t=e;return t.le||(t.le=function(e,t){if("F"===e.limitType)return Nn(e.path,e.collectionGroup,t,e.filters,e.limit,e.startAt,e.endAt);t=t.map((e=>{var t="desc"===e.dir?"asc":"desc";return new ln(e.field,t)}));var n=e.endAt?new un(e.endAt.position,e.endAt.inclusive):null,r=e.startAt?new un(e.startAt.position,e.startAt.inclusive):null;return Nn(e.path,e.collectionGroup,t,e.filters,e.limit,n,r)}(t,jn(e))),t.le}function zn(e,t){var n=e.filters.concat([t]);return new Pn(e.path,e.collectionGroup,e.explicitOrderBy.slice(),n,e.limit,e.limitType,e.startAt,e.endAt)}function Kn(e,t,n){return new Pn(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function $n(e,t){return Rn(Gn(e),Gn(t))&&e.limitType===t.limitType}function Qn(e){return`${kn(Gn(e))}|lt:${e.limitType}`}function Hn(e){return`Query(target=${function(e){let t=e.path.canonicalString();return null!==e.collectionGroup&&(t+=" collectionGroup="+e.collectionGroup),0<e.filters.length&&(t+=`, filters: [${e.filters.map((e=>_n(e))).join(", ")}]`),je(e.limit)||(t+=", limit: "+e.limit),0<e.orderBy.length&&(t+=`, orderBy: [${e.orderBy.map((e=>function(e){return`${e.field.canonicalString()} (${e.dir})`}(e))).join(", ")}]`),e.startAt&&(t+=", startAt: ",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map((e=>Ht(e))).join(",")),e.endAt&&(t+=", endAt: ",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map((e=>Ht(e))).join(",")),`Target(${t})`}(Gn(e))}; limitType=${e.limitType})`}function Wn(e,t){return t.isFoundDocument()&&(i=e,a=(s=t).key.path,null!==i.collectionGroup?s.key.hasCollectionId(i.collectionGroup)&&i.path.isPrefixOf(a):me.isDocumentKey(i.path)?i.path.isEqual(a):i.path.isImmediateParentOf(a))&&function(e,t){for(const n of jn(e))if(!n.field.isKeyField()&&null===t.data.field(n.field))return;return 1}(e,t)&&function(e,t){for(const n of e.filters)if(!n.matches(t))return;return 1}(e,t)&&(i=t,!((t=e).startAt&&(n=t.startAt,e=jn(t),r=cn(n,e,i),!(n.inclusive?r<=0:r<0))||t.endAt&&(n=t.endAt,t=jn(t),r=cn(n,t,i),!(n.inclusive?0<=r:0<r))));var n,r,i,s,a}function Yn(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function Jn(e){return(t,n)=>{let r=!1;for(const i of jn(e)){const e=function(e,t,n){var r=e.field.isKeyField()?me.comparator(t.key,n.key):function(e,t,n){var r=t.data.field(e),i=n.data.field(e);return null!==r&&null!==i?$t(r,i):$()}(e.field,t,n);switch(e.dir){case"asc":return r;case"desc":return-1*r;default:return $()}}(i,t,n);if(0!==e)return e;r=r||i.field.isKeyField()}return 0}}class Xn{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n)for(const[t,r]of n)if(this.equalsFn(t,e))return r}has(e){return void 0!==this.get(e)}set(e,t){const n=this.mapKeyFn(e),r=this.inner[n];if(void 0===r)return this.inner[n]=[[e,t]],void this.innerSize++;for(let n=0;n<r.length;n++)if(this.equalsFn(r[n][0],e))return void(r[n]=[e,t]);r.push([e,t]),this.innerSize++}delete(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return 1===n.length?delete this.inner[t]:n.splice(r,1),this.innerSize--,!0;return!1}forEach(e){bt(this.inner,((t,n)=>{for(const[t,r]of n)e(t,r)}))}isEmpty(){return It(this.inner)}size(){return this.innerSize}}const Zn=new Et(me.comparator),er=new Et(me.comparator);function tr(...e){let t=er;for(const n of e)t=t.insert(n.key,n);return t}function nr(e){let t=er;return e.forEach(((e,n)=>t=t.insert(e,n.overlayedDocument))),t}function rr(){return new Xn((e=>e.toString()),((e,t)=>e.isEqual(t)))}const ir=new Et(me.comparator),sr=new xt(me.comparator);function ar(...e){let t=sr;for(const n of e)t=t.add(n);return t}const or=new xt(ae);function ur(e,t){if(e.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:Ge(t)?"-0":t}}function cr(e){return{integerValue:""+e}}function hr(e,t){return ze(t)?cr(t):ur(e,t)}class lr{constructor(){this._=void 0}}function dr(e,t){return e instanceof vr?Yt(e=t)||e&&"doubleValue"in e?t:{integerValue:0}:null}class fr extends lr{}class gr extends lr{constructor(e){super(),this.elements=e}}function mr(e,t){const n=_r(t);for(const t of e.elements)n.some((e=>zt(e,t)))||n.push(t);return{arrayValue:{values:n}}}class pr extends lr{constructor(e){super(),this.elements=e}}function yr(e,t){let n=_r(t);for(const t of e.elements)n=n.filter((e=>!zt(e,t)));return{arrayValue:{values:n}}}class vr extends lr{constructor(e,t){super(),this.serializer=e,this.Pe=t}}function wr(e){return Lt(e.integerValue||e.doubleValue)}function _r(e){return Jt(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class br{constructor(e,t){this.field=e,this.transform=t}}class Ir{constructor(e,t){this.version=e,this.transformResults=t}}class Er{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new Er}static exists(e){return new Er(void 0,e)}static updateTime(e){return new Er(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function Tr(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class Sr{}function xr(e,t){if(!e.hasLocalMutations||t&&0===t.fields.length)return null;if(null===t)return e.isNoDocument()?new Or(e.key,Er.none()):new Nr(e.key,e.data,Er.none());{const r=e.data,i=an.empty();let s=new xt(ge.comparator);for(var n of t.fields)if(!s.has(n)){let e=r.field(n);null===e&&1<n.length&&(n=n.popLast(),e=r.field(n)),null===e?i.delete(n):i.set(n,e),s=s.add(n)}return new kr(e.key,i,new At(s.toArray()),Er.none())}}function Dr(e,t,n){e instanceof Nr?function(e,t,n){const r=e.value.clone(),i=Mr(e.fieldTransforms,t,n.transformResults);r.setAll(i),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(e,t,n):e instanceof kr?function(e,t,n){if(!Tr(e.precondition,t))return t.convertToUnknownDocument(n.version);const r=Mr(e.fieldTransforms,t,n.transformResults),i=t.data;i.setAll(Rr(e)),i.setAll(r),t.convertToFoundDocument(n.version,i).setHasCommittedMutations()}(e,t,n):t.convertToNoDocument(n.version).setHasCommittedMutations()}function Cr(e,t,n,r){return e instanceof Nr?function(e,t,n,r){if(!Tr(e.precondition,t))return n;const i=e.value.clone(),s=Lr(e.fieldTransforms,r,t);return i.setAll(s),t.convertToFoundDocument(t.version,i).setHasLocalMutations(),null}(e,t,n,r):e instanceof kr?function(e,t,n,r){if(!Tr(e.precondition,t))return n;const i=Lr(e.fieldTransforms,r,t),s=t.data;return s.setAll(Rr(e)),s.setAll(i),t.convertToFoundDocument(t.version,s).setHasLocalMutations(),null===n?null:n.unionWith(e.fieldMask.fields).unionWith(e.fieldTransforms.map((e=>e.field)))}(e,t,n,r):Tr(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):n}function Ar(e,t){return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&(n=e.fieldTransforms,r=t.fieldTransforms,!!(void 0===n&&void 0===r||n&&r&&oe(n,r,((e,t)=>function(e,t){return e.field.isEqual(t.field)&&(e=e.transform,t=t.transform,e instanceof gr&&t instanceof gr||e instanceof pr&&t instanceof pr?oe(e.elements,t.elements,zt):e instanceof vr&&t instanceof vr?zt(e.Pe,t.Pe):e instanceof fr&&t instanceof fr)}(e,t))))&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask)));var n,r}class Nr extends Sr{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class kr extends Sr{constructor(e,t,n,r,i=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=i,this.type=1}getFieldMask(){return this.fieldMask}}function Rr(e){const t=new Map;return e.fieldMask.fields.forEach((n=>{var r;n.isEmpty()||(r=e.data.field(n),t.set(n,r))})),t}function Mr(e,t,n){const r=new Map;Q(e.length===n.length);for(let h=0;h<n.length;h++){var i=e[h],s=i.transform,a=t.data.field(i.field);r.set(i.field,(o=s,u=a,c=n[h],o instanceof gr?mr(o,u):o instanceof pr?yr(o,u):c))}var o,u,c;return r}function Lr(e,t,n){const r=new Map;for(const u of e){const e=u.transform,c=n.data.field(u.field);r.set(u.field,(s=c,o=a=void 0,(i=e)instanceof fr?function(e,t){const n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:e.seconds,nanos:e.nanoseconds}}}};return(t=t&&Ft(t)?Pt(t):t)&&(n.fields.__previous_value__=t),{mapValue:n}}(t,s):i instanceof gr?mr(i,s):i instanceof pr?yr(i,s):(o=wr(a=dr(i,s))+wr(i.Pe),Yt(a)&&Yt(i.Pe)?cr(o):ur(i.serializer,o))))}var i,s,a,o;return r}class Or extends Sr{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class Fr extends Sr{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class Pr{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(e,t){var n=t.mutationResults;for(let t=0;t<this.mutations.length;t++){const r=this.mutations[t];r.key.isEqual(e.key)&&Dr(r,e,n[t])}}applyToLocalView(e,t){for(const n of this.baseMutations)n.key.isEqual(e.key)&&(t=Cr(n,e,t,this.localWriteTime));for(const n of this.mutations)n.key.isEqual(e.key)&&(t=Cr(n,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){const n=rr();return this.mutations.forEach((r=>{const i=e.get(r.key),s=i.overlayedDocument;let a=this.applyToLocalView(s,i.mutatedFields);a=t.has(r.key)?null:a;var o=xr(s,a);null!==o&&n.set(r.key,o),s.isValidDocument()||s.convertToNoDocument(he.min())})),n}keys(){return this.mutations.reduce(((e,t)=>e.add(t.key)),ar())}isEqual(e){return this.batchId===e.batchId&&oe(this.mutations,e.mutations,((e,t)=>Ar(e,t)))&&oe(this.baseMutations,e.baseMutations,((e,t)=>Ar(e,t)))}}class Vr{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){Q(e.mutations.length===n.length);let r=ir;var i=e.mutations;for(let e=0;e<i.length;e++)r=r.insert(i[e].key,n[e].version);return new Vr(e,t,n,r)}}class Ur{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class Br{constructor(e,t){this.count=e,this.unchangedNames=t}}function qr(e){switch(e){default:return $();case H.CANCELLED:case H.UNKNOWN:case H.DEADLINE_EXCEEDED:case H.RESOURCE_EXHAUSTED:case H.INTERNAL:case H.UNAVAILABLE:case H.UNAUTHENTICATED:return!1;case H.INVALID_ARGUMENT:case H.NOT_FOUND:case H.ALREADY_EXISTS:case H.PERMISSION_DENIED:case H.FAILED_PRECONDITION:case H.ABORTED:case H.OUT_OF_RANGE:case H.UNIMPLEMENTED:case H.DATA_LOSS:return!0}}function jr(e){if(void 0===e)return G("GRPC error has no .code"),H.UNKNOWN;switch(e){case L.OK:return H.OK;case L.CANCELLED:return H.CANCELLED;case L.UNKNOWN:return H.UNKNOWN;case L.DEADLINE_EXCEEDED:return H.DEADLINE_EXCEEDED;case L.RESOURCE_EXHAUSTED:return H.RESOURCE_EXHAUSTED;case L.INTERNAL:return H.INTERNAL;case L.UNAVAILABLE:return H.UNAVAILABLE;case L.UNAUTHENTICATED:return H.UNAUTHENTICATED;case L.INVALID_ARGUMENT:return H.INVALID_ARGUMENT;case L.NOT_FOUND:return H.NOT_FOUND;case L.ALREADY_EXISTS:return H.ALREADY_EXISTS;case L.PERMISSION_DENIED:return H.PERMISSION_DENIED;case L.FAILED_PRECONDITION:return H.FAILED_PRECONDITION;case L.ABORTED:return H.ABORTED;case L.OUT_OF_RANGE:return H.OUT_OF_RANGE;case L.UNIMPLEMENTED:return H.UNIMPLEMENTED;case L.DATA_LOSS:return H.DATA_LOSS;default:return $()}}function Gr(){return new TextEncoder}(T=L=L||{})[T.OK=0]="OK",T[T.CANCELLED=1]="CANCELLED",T[T.UNKNOWN=2]="UNKNOWN",T[T.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",T[T.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",T[T.NOT_FOUND=5]="NOT_FOUND",T[T.ALREADY_EXISTS=6]="ALREADY_EXISTS",T[T.PERMISSION_DENIED=7]="PERMISSION_DENIED",T[T.UNAUTHENTICATED=16]="UNAUTHENTICATED",T[T.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",T[T.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",T[T.ABORTED=10]="ABORTED",T[T.OUT_OF_RANGE=11]="OUT_OF_RANGE",T[T.UNIMPLEMENTED=12]="UNIMPLEMENTED",T[T.INTERNAL=13]="INTERNAL",T[T.UNAVAILABLE=14]="UNAVAILABLE",T[T.DATA_LOSS=15]="DATA_LOSS";const zr=new I([4294967295,4294967295],0);function Kr(e){const t=Gr().encode(e),n=new E;return n.update(t),new Uint8Array(n.digest())}function $r(e){const t=new DataView(e.buffer),n=t.getUint32(0,!0),r=t.getUint32(4,!0),i=t.getUint32(8,!0),s=t.getUint32(12,!0);return[new I([n,r],0),new I([i,s],0)]}class Qr{constructor(e,t,n){if(this.bitmap=e,this.padding=t,this.hashCount=n,t<0||8<=t)throw new Hr(`Invalid padding: ${t}`);if(n<0)throw new Hr(`Invalid hash count: ${n}`);if(0<e.length&&0===this.hashCount)throw new Hr(`Invalid hash count: ${n}`);if(0===e.length&&0!==t)throw new Hr(`Invalid padding when bitmap length is 0: ${t}`);this.Ie=8*e.length-t,this.Te=I.fromNumber(this.Ie)}Ee(e,t,n){let r=e.add(t.multiply(I.fromNumber(n)));return 1===r.compare(zr)&&(r=new I([r.getBits(0),r.getBits(1)],0)),r.modulo(this.Te).toNumber()}de(e){return!!(this.bitmap[Math.floor(e/8)]&1<<e%8)}mightContain(e){if(0===this.Ie)return!1;const t=Kr(e),[n,r]=$r(t);for(let e=0;e<this.hashCount;e++){const t=this.Ee(n,r,e);if(!this.de(t))return!1}return!0}static create(e,t,n){const r=e%8==0?0:8-e%8,i=new Uint8Array(Math.ceil(e/8)),s=new Qr(i,r,t);return n.forEach((e=>s.insert(e))),s}insert(e){if(0!==this.Ie){const t=Kr(e),[n,r]=$r(t);for(let e=0;e<this.hashCount;e++){const t=this.Ee(n,r,e);this.Ae(t)}}}Ae(e){var t=Math.floor(e/8);this.bitmap[t]|=1<<e%8}}class Hr extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class Wr{constructor(e,t,n,r,i){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=i}static createSynthesizedRemoteEventForCurrentChange(e,t,n){const r=new Map;return r.set(e,Yr.createSynthesizedTargetChangeForCurrentChange(e,t,n)),new Wr(he.min(),r,new Et(ae),Zn,ar())}}class Yr{constructor(e,t,n,r,i){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=i}static createSynthesizedTargetChangeForCurrentChange(e,t,n){return new Yr(n,t,ar(),ar(),ar())}}class Jr{constructor(e,t,n,r){this.Re=e,this.removedTargetIds=t,this.key=n,this.Ve=r}}class Xr{constructor(e,t){this.targetId=e,this.me=t}}class Zr{constructor(e,t,n=kt.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class ei{constructor(){this.fe=0,this.ge=ri(),this.pe=kt.EMPTY_BYTE_STRING,this.ye=!1,this.we=!0}get current(){return this.ye}get resumeToken(){return this.pe}get Se(){return 0!==this.fe}get be(){return this.we}De(e){0<e.approximateByteSize()&&(this.we=!0,this.pe=e)}Ce(){let e=ar(),t=ar(),n=ar();return this.ge.forEach(((r,i)=>{switch(i){case 0:e=e.add(r);break;case 2:t=t.add(r);break;case 1:n=n.add(r);break;default:$()}})),new Yr(this.pe,this.ye,e,t,n)}ve(){this.we=!1,this.ge=ri()}Fe(e,t){this.we=!0,this.ge=this.ge.insert(e,t)}Me(e){this.we=!0,this.ge=this.ge.remove(e)}xe(){this.fe+=1}Oe(){--this.fe,Q(0<=this.fe)}Ne(){this.we=!0,this.ye=!0}}class ti{constructor(e){this.Le=e,this.Be=new Map,this.ke=Zn,this.qe=ni(),this.Qe=new Et(ae)}Ke(e){for(const t of e.Re)e.Ve&&e.Ve.isFoundDocument()?this.$e(t,e.Ve):this.Ue(t,e.key,e.Ve);for(const t of e.removedTargetIds)this.Ue(t,e.key,e.Ve)}We(e){this.forEachTarget(e,(t=>{const n=this.Ge(t);switch(e.state){case 0:this.ze(t)&&n.De(e.resumeToken);break;case 1:n.Oe(),n.Se||n.ve(),n.De(e.resumeToken);break;case 2:n.Oe(),n.Se||this.removeTarget(t);break;case 3:this.ze(t)&&(n.Ne(),n.De(e.resumeToken));break;case 4:this.ze(t)&&(this.je(t),n.De(e.resumeToken));break;default:$()}}))}forEachTarget(e,t){0<e.targetIds.length?e.targetIds.forEach(t):this.Be.forEach(((e,n)=>{this.ze(n)&&t(n)}))}He(e){const t=e.targetId,n=e.me.count,r=this.Je(t);if(r){var i=r.target;if(Mn(i))if(0===n){const e=new me(i.path);this.Ue(t,e,on.newNoDocument(e,he.min()))}else Q(1===n);else{const r=this.Ye(t);if(r!==n){const n=this.Ze(e),i=n?this.Xe(n,e,r):1;if(0!==i){this.je(t);const e=2===i?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.Qe=this.Qe.insert(t,e)}}}}}Ze(e){var t;if(!(t=e.me.unchangedNames)||!t.bits)return null;var{bits:{bitmap:n="",padding:r=0},hashCount:t=0}=t;let i,s;try{i=Ot(n).toUint8Array()}catch(e){if(e instanceof Nt)return z("Decoding the base64 bloom filter in existence filter failed ("+e.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw e}try{s=new Qr(i,r,t)}catch(e){return z(e instanceof Hr?"BloomFilter error: ":"Applying bloom filter failed: ",e),null}return 0===s.Ie?null:s}Xe(e,t,n){return t.me.count===n-this.nt(e,t.targetId)?0:2}nt(e,t){const n=this.Le.getRemoteKeysForTarget(t);let r=0;return n.forEach((n=>{var i=`projects/${(i=this.Le.tt()).projectId}/databases/${i.database}/documents/${n.path.canonicalString()}`;e.mightContain(i)||(this.Ue(t,n,null),r++)})),r}rt(e){const t=new Map;this.Be.forEach(((n,r)=>{var i=this.Je(r);if(i){if(n.current&&Mn(i.target)){const t=new me(i.target.path);null!==this.ke.get(t)||this.it(r,t)||this.Ue(r,t,on.newNoDocument(t,e))}n.be&&(t.set(r,n.Ce()),n.ve())}}));let n=ar();this.qe.forEach(((e,t)=>{let r=!0;t.forEachWhile((e=>{var t=this.Je(e);return!t||"TargetPurposeLimboResolution"===t.purpose||(r=!1)})),r&&(n=n.add(e))})),this.ke.forEach(((t,n)=>n.setReadTime(e)));var r=new Wr(e,t,this.Qe,this.ke,n);return this.ke=Zn,this.qe=ni(),this.Qe=new Et(ae),r}$e(e,t){var n;this.ze(e)&&(n=this.it(e,t.key)?2:0,this.Ge(e).Fe(t.key,n),this.ke=this.ke.insert(t.key,t),this.qe=this.qe.insert(t.key,this.st(t.key).add(e)))}Ue(e,t,n){if(this.ze(e)){const r=this.Ge(e);this.it(e,t)?r.Fe(t,1):r.Me(t),this.qe=this.qe.insert(t,this.st(t).delete(e)),n&&(this.ke=this.ke.insert(t,n))}}removeTarget(e){this.Be.delete(e)}Ye(e){var t=this.Ge(e).Ce();return this.Le.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}xe(e){this.Ge(e).xe()}Ge(e){let t=this.Be.get(e);return t||(t=new ei,this.Be.set(e,t)),t}st(e){let t=this.qe.get(e);return t||(t=new xt(ae),this.qe=this.qe.insert(e,t)),t}ze(e){var t=null!==this.Je(e);return t||j("WatchChangeAggregator","Detected inactive target",e),t}Je(e){var t=this.Be.get(e);return t&&t.Se?null:this.Le.ot(e)}je(e){this.Be.set(e,new ei),this.Le.getRemoteKeysForTarget(e).forEach((t=>{this.Ue(e,t,null)}))}it(e,t){return this.Le.getRemoteKeysForTarget(e).has(t)}}function ni(){return new Et(me.comparator)}function ri(){return new Et(me.comparator)}const ii={asc:"ASCENDING",desc:"DESCENDING"},si={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},ai={and:"AND",or:"OR"};class oi{constructor(e,t){this.databaseId=e,this.useProto3Json=t}}function ui(e,t){return e.useProto3Json||je(t)?t:{value:t}}function ci(e,t){return e.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function hi(e,t){return e.useProto3Json?t.toBase64():t.toUint8Array()}function li(e){return Q(!!e),he.fromTimestamp((t=Mt(e),new ce(t.seconds,t.nanos)));var t}function di(e,t){return fi(e,t).canonicalString()}function fi(e,t){const n=new de(["projects",e.projectId,"databases",e.database]).child("documents");return void 0===t?n:n.child(t)}function gi(e){var t=de.fromString(e);return Q(Ri(t)),t}function mi(e,t){return di(e.databaseId,t.path)}function pi(e,t){const n=gi(t);if(n.get(1)!==e.databaseId.projectId)throw new W(H.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new W(H.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new me(_i(n))}function yi(e,t){return di(e.databaseId,t)}function vi(e){var t=gi(e);return 4===t.length?de.emptyPath():_i(t)}function wi(e){return new de(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function _i(e){return Q(4<e.length&&"documents"===e.get(4)),e.popFirst(5)}function bi(e,t,n){return{name:mi(e,t),fields:n.value.mapValue.fields}}function Ii(e,t,n){const r=pi(e,t.name),i=li(t.updateTime),s=t.createTime?li(t.createTime):he.min(),a=new an({mapValue:{fields:t.fields}}),o=on.newFoundDocument(r,i,s,a);return n&&o.setHasCommittedMutations(),n?o.setHasCommittedMutations():o}function Ei(e,t){let n;if(t instanceof Nr)n={update:bi(e,t.key,t.value)};else if(t instanceof Or)n={delete:mi(e,t.key)};else if(t instanceof kr)n={update:bi(e,t.key,t.data),updateMask:function(e){const t=[];return e.fields.forEach((e=>t.push(e.canonicalString()))),{fieldPaths:t}}(t.fieldMask)};else{if(!(t instanceof Fr))return $();n={verify:mi(e,t.key)}}return 0<t.fieldTransforms.length&&(n.updateTransforms=t.fieldTransforms.map((e=>function(e){var t=e.transform;if(t instanceof fr)return{fieldPath:e.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(t instanceof gr)return{fieldPath:e.field.canonicalString(),appendMissingElements:{values:t.elements}};if(t instanceof pr)return{fieldPath:e.field.canonicalString(),removeAllFromArray:{values:t.elements}};if(t instanceof vr)return{fieldPath:e.field.canonicalString(),increment:t.Pe};throw $()}(e)))),t.precondition.isNone||(n.currentDocument=(r=e,void 0!==(e=t.precondition).updateTime?{updateTime:(t=e.updateTime,ci(r,t.toTimestamp()))}:void 0!==e.exists?{exists:e.exists}:$())),n;var r}function Ti(e,t){const n=t.currentDocument?void 0!==(i=t.currentDocument).updateTime?Er.updateTime(li(i.updateTime)):void 0!==i.exists?Er.exists(i.exists):Er.none():Er.none(),r=t.updateTransforms?t.updateTransforms.map((t=>function(e,t){let n=null;if("setToServerValue"in t)Q("REQUEST_TIME"===t.setToServerValue),n=new fr;else if("appendMissingElements"in t){const e=t.appendMissingElements.values||[];n=new gr(e)}else if("removeAllFromArray"in t){const e=t.removeAllFromArray.values||[];n=new pr(e)}else"increment"in t?n=new vr(e,t.increment):$();var r=ge.fromServerFormat(t.fieldPath);return new br(r,n)}(e,t))):[];var i;if(t.update){t.update.name;var s=pi(e,t.update.name),a=new an({mapValue:{fields:t.update.fields}});if(t.updateMask){const e=function(e){const t=e.fieldPaths||[];return new At(t.map((e=>ge.fromServerFormat(e))))}(t.updateMask);return new kr(s,a,e,n,r)}return new Nr(s,a,n,r)}if(t.delete){const r=pi(e,t.delete);return new Or(r,n)}if(t.verify){const r=pi(e,t.verify);return new Fr(r,n)}return $()}function Si(e,t){return{documents:[yi(e,t.path)]}}function xi(e,t){const n={structuredQuery:{}},r=t.path;let i;null!==t.collectionGroup?(i=r,n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(i=r.popLast(),n.structuredQuery.from=[{collectionId:r.lastSegment()}]),n.parent=yi(e,i);var s=function(e){if(0!==e.length)return function e(t){return t instanceof fn?function(e){if("=="===e.op){if(Zt(e.value))return{unaryFilter:{field:Ni(e.field),op:"IS_NAN"}};if(Xt(e.value))return{unaryFilter:{field:Ni(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(Zt(e.value))return{unaryFilter:{field:Ni(e.field),op:"IS_NOT_NAN"}};if(Xt(e.value))return{unaryFilter:{field:Ni(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:Ni(e.field),op:Ci(e.op),value:e.value}}}(t):t instanceof gn?function(t){const n=t.getFilters().map((t=>e(t)));return 1===n.length?n[0]:{compositeFilter:{op:Ai(t.op),filters:n}}}(t):$()}(gn.create(e,"and"))}(t.filters);return s&&(n.structuredQuery.where=s),s=function(e){if(0!==e.length)return e.map((e=>function(e){return{field:Ni(e.field),direction:(e=e.dir,ii[e])}}(e)))}(t.orderBy),s&&(n.structuredQuery.orderBy=s),null!==(s=ui(e,t.limit))&&(n.structuredQuery.limit=s),t.startAt&&(n.structuredQuery.startAt={before:(e=t.startAt).inclusive,values:e.position}),t.endAt&&(n.structuredQuery.endAt={before:!(t=t.endAt).inclusive,values:t.position}),{_t:n,parent:i}}function Di(e){let t=vi(e.parent);var n,r,i,s=e.structuredQuery,a=s.from?s.from.length:0;let o=null;if(0<a){Q(1===a);const e=s.from[0];e.allDescendants?o=e.collectionId:t=t.child(e.collectionId)}let u=[];s.where&&(u=function(e){const t=function e(t){return void 0!==t.unaryFilter?function(e){switch(e.unaryFilter.op){case"IS_NAN":const t=ki(e.unaryFilter.field);return fn.create(t,"==",{doubleValue:NaN});case"IS_NULL":const n=ki(e.unaryFilter.field);return fn.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const r=ki(e.unaryFilter.field);return fn.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const i=ki(e.unaryFilter.field);return fn.create(i,"!=",{nullValue:"NULL_VALUE"});default:return $()}}(t):void 0!==t.fieldFilter?function(e){return fn.create(ki(e.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return $()}}(e.fieldFilter.op),e.fieldFilter.value)}(t):void 0!==t.compositeFilter?function(t){return gn.create(t.compositeFilter.filters.map((t=>e(t))),function(e){switch(e){case"AND":return"and";case"OR":return"or";default:return $()}}(t.compositeFilter.op))}(t):$()}(e);return t instanceof gn&&yn(t)?t.getFilters():[t]}(s.where));let c=[];s.orderBy&&(c=s.orderBy.map((e=>function(e){return new ln(ki(e.field),function(e){switch(e){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(e.direction))}(e))));let h=null;s.limit&&(h=je(n="object"==typeof(e=s.limit)?e.value:e)?null:n);let l=null;s.startAt&&(i=!!(r=s.startAt).before,n=r.values||[],l=new un(n,i));let d=null;return s.endAt&&(i=!(r=s.endAt).before,s=r.values||[],d=new un(s,i)),Vn(t,o,c,u,h,"F",l,d)}function Ci(e){return si[e]}function Ai(e){return ai[e]}function Ni(e){return{fieldPath:e.canonicalString()}}function ki(e){return ge.fromServerFormat(e.fieldPath)}function Ri(e){return 4<=e.length&&"projects"===e.get(0)&&"databases"===e.get(2)}class Mi{constructor(e,t,n,r,i=he.min(),s=he.min(),a=kt.EMPTY_BYTE_STRING,o=null){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=i,this.lastLimboFreeSnapshotVersion=s,this.resumeToken=a,this.expectedCount=o}withSequenceNumber(e){return new Mi(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new Mi(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new Mi(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new Mi(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}}class Li{constructor(e){this.ct=e}}function Oi(e,t){const n=t.key,r={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:Fi(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument())r.document={name:mi(i=e.ct,(e=t).key),fields:e.data.value.mapValue.fields,updateTime:ci(i,e.version.toTimestamp()),createTime:ci(i,e.createTime.toTimestamp())};else if(t.isNoDocument())r.noDocument={path:n.path.toArray(),readTime:Pi(t.version)};else{if(!t.isUnknownDocument())return $();r.unknownDocument={path:n.path.toArray(),version:Pi(t.version)}}var i;return r}function Fi(e){var t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function Pi(e){var t=e.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function Vi(e){var t=new ce(e.seconds,e.nanoseconds);return he.fromTimestamp(t)}function Ui(e,t){const n=(t.baseMutations||[]).map((t=>Ti(e.ct,t)));for(let e=0;e<t.mutations.length-1;++e){const n=t.mutations[e];if(e+1<t.mutations.length&&void 0!==t.mutations[e+1].transform){const r=t.mutations[e+1];n.updateTransforms=r.transform.fieldTransforms,t.mutations.splice(e+1,1),++e}}const r=t.mutations.map((t=>Ti(e.ct,t))),i=ce.fromMillis(t.localWriteTimeMs);return new Pr(t.batchId,i,n,r)}function Bi(e){var t,n=Vi(e.readTime),r=void 0!==e.lastLimboFreeSnapshotVersion?Vi(e.lastLimboFreeSnapshotVersion):he.min(),i=void 0!==e.query.documents?(Q(1===(t=e.query).documents.length),Gn(Un(vi(t.documents[0])))):Gn(Di(e.query));return new Mi(i,e.targetId,"TargetPurposeListen",e.lastListenSequenceNumber,n,r,kt.fromBase64String(e.resumeToken))}function qi(e,t){var n=Pi(t.snapshotVersion),r=Pi(t.lastLimboFreeSnapshotVersion),i=Mn(t.target)?Si(e.ct,t.target):xi(e.ct,t.target)._t,s=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:kn(t.target),readTime:n,resumeToken:s,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:r,query:i}}function ji(e){var t=Di({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?Kn(t,t.limit,"L"):t}function Gi(e,t){return new Ur(t.largestBatchId,Ti(e.ct,t.overlayMutation))}function zi(e,t){var n=t.path.lastSegment();return[e,Ke(t.path.popLast()),n]}function Ki(e,t,n,r){return{indexId:e,uid:t,sequenceNumber:n,readTime:Pi(r.readTime),documentKey:Ke(r.documentKey.path),largestBatchId:r.largestBatchId}}class $i{getBundleMetadata(e,t){return Qi(e).get(t).next((e=>{if(e)return{id:e.bundleId,createTime:Vi(e.createTime),version:e.version}}))}saveBundleMetadata(e,t){return Qi(e).put({bundleId:t.id,createTime:Pi(li(t.createTime)),version:t.version})}getNamedQuery(e,t){return Hi(e).get(t).next((e=>{if(e)return{name:e.name,query:ji(e.bundledQuery),readTime:Vi(e.readTime)}}))}saveNamedQuery(e,t){return Hi(e).put({name:t.name,readTime:Pi(li(t.readTime)),bundledQuery:t.bundledQuery})}}function Qi(e){return wt(e,"bundles")}function Hi(e){return wt(e,"namedQueries")}class Wi{constructor(e,t){this.serializer=e,this.userId=t}static lt(e,t){var n=t.uid||"";return new Wi(e,n)}getOverlay(e,t){return Yi(e).get(zi(this.userId,t)).next((e=>e?Gi(this.serializer,e):null))}getOverlays(e,t){const n=rr();return Ce.forEach(t,(t=>this.getOverlay(e,t).next((e=>{null!==e&&n.set(t,e)})))).next((()=>n))}saveOverlays(e,t,n){const r=[];return n.forEach(((n,i)=>{var s=new Ur(t,i);r.push(this.ht(e,s))})),Ce.waitFor(r)}removeOverlaysForBatchId(e,t,n){const r=new Set;t.forEach((e=>r.add(Ke(e.getCollectionPath()))));const i=[];return r.forEach((t=>{var r=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,n+1],!1,!0);i.push(Yi(e).j("collectionPathOverlayIndex",r))})),Ce.waitFor(i)}getOverlaysForCollection(e,t,n){const r=rr(),i=Ke(t),s=IDBKeyRange.bound([this.userId,i,n],[this.userId,i,Number.POSITIVE_INFINITY],!0);return Yi(e).U("collectionPathOverlayIndex",s).next((e=>{for(const t of e){const e=Gi(this.serializer,t);r.set(e.getKey(),e)}return r}))}getOverlaysForCollectionGroup(e,t,n,r){const i=rr();let s;var a=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return Yi(e).J({index:"collectionGroupOverlayIndex",range:a},((e,t,n)=>{const a=Gi(this.serializer,t);i.size()<r||a.largestBatchId===s?(i.set(a.getKey(),a),s=a.largestBatchId):n.done()})).next((()=>i))}ht(e,t){return Yi(e).put(function(e,t,n){var[,r,i]=zi(t,n.mutation.key);return{userId:t,collectionPath:r,documentId:i,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:Ei(e.ct,n.mutation)}}(this.serializer,this.userId,t))}}function Yi(e){return wt(e,"documentOverlays")}class Ji{constructor(){}Pt(e,t){this.It(e,t),t.Tt()}It(e,t){if("nullValue"in e)this.Et(t,5);else if("booleanValue"in e)this.Et(t,10),t.dt(e.booleanValue?1:0);else if("integerValue"in e)this.Et(t,15),t.dt(Lt(e.integerValue));else if("doubleValue"in e){var n=Lt(e.doubleValue);isNaN(n)?this.Et(t,13):(this.Et(t,15),Ge(n)?t.dt(0):t.dt(n))}else if("timestampValue"in e){let n=e.timestampValue;this.Et(t,20),"string"==typeof n&&(n=Mt(n)),t.At(`${n.seconds||""}`),t.dt(n.nanos||0)}else"stringValue"in e?(this.Rt(e.stringValue,t),this.Vt(t)):"bytesValue"in e?(this.Et(t,30),t.ft(Ot(e.bytesValue)),this.Vt(t)):"referenceValue"in e?this.gt(e.referenceValue,t):"geoPointValue"in e?(n=e.geoPointValue,this.Et(t,45),t.dt(n.latitude||0),t.dt(n.longitude||0)):"mapValue"in e?nn(e)?this.Et(t,Number.MAX_SAFE_INTEGER):(this.yt(e.mapValue,t),this.Vt(t)):"arrayValue"in e?(this.wt(e.arrayValue,t),this.Vt(t)):$()}Rt(e,t){this.Et(t,25),this.St(e,t)}St(e,t){t.At(e)}yt(e,t){var n=e.fields||{};this.Et(t,55);for(const e of Object.keys(n))this.Rt(e,t),this.It(n[e],t)}wt(e,t){var n=e.values||[];this.Et(t,50);for(const e of n)this.It(e,t)}gt(e,t){this.Et(t,37),me.fromName(e).path.forEach((e=>{this.Et(t,60),this.St(e,t)}))}Et(e,t){e.dt(t)}Vt(e){e.dt(2)}}function Xi(e){var t=64-function(e){let t=0;for(let r=0;r<8;++r){var n=function(e){if(0===e)return 8;let t=0;return!(e>>4)&&(t+=4,e<<=4),!(e>>6)&&(t+=2,e<<=2),!(e>>7)&&(t+=1),t}(255&e[r]);if(t+=n,8!==n)break}return t}(e);return Math.ceil(t/8)}Ji.bt=new Ji;class Zi{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Dt(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Ct(n.value),n=t.next();this.vt()}Ft(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Mt(n.value),n=t.next();this.xt()}Ot(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Ct(e);else if(e<2048)this.Ct(960|e>>>6),this.Ct(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Ct(480|e>>>12),this.Ct(128|63&e>>>6),this.Ct(128|63&e);else{const e=t.codePointAt(0);this.Ct(240|e>>>18),this.Ct(128|63&e>>>12),this.Ct(128|63&e>>>6),this.Ct(128|63&e)}}this.vt()}Nt(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Mt(e);else if(e<2048)this.Mt(960|e>>>6),this.Mt(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Mt(480|e>>>12),this.Mt(128|63&e>>>6),this.Mt(128|63&e);else{const e=t.codePointAt(0);this.Mt(240|e>>>18),this.Mt(128|63&e>>>12),this.Mt(128|63&e>>>6),this.Mt(128|63&e)}}this.xt()}Lt(e){var t=this.Bt(e),n=Xi(t);this.kt(1+n),this.buffer[this.position++]=255&n;for(let e=t.length-n;e<t.length;++e)this.buffer[this.position++]=255&t[e]}qt(e){var t=this.Bt(e),n=Xi(t);this.kt(1+n),this.buffer[this.position++]=~(255&n);for(let e=t.length-n;e<t.length;++e)this.buffer[this.position++]=~(255&t[e])}Qt(){this.Kt(255),this.Kt(255)}$t(){this.Ut(255),this.Ut(255)}reset(){this.position=0}seed(e){this.kt(e.length),this.buffer.set(e,this.position),this.position+=e.length}Wt(){return this.buffer.slice(0,this.position)}Bt(e){const t=function(e){const t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),n=!!(128&t[0]);t[0]^=n?255:128;for(let e=1;e<t.length;++e)t[e]^=n?255:0;return t}Ct(e){var t=255&e;0==t?(this.Kt(0),this.Kt(255)):255==t?(this.Kt(255),this.Kt(0)):this.Kt(t)}Mt(e){var t=255&e;0==t?(this.Ut(0),this.Ut(255)):255==t?(this.Ut(255),this.Ut(0)):this.Ut(e)}vt(){this.Kt(0),this.Kt(1)}xt(){this.Ut(0),this.Ut(1)}Kt(e){this.kt(1),this.buffer[this.position++]=e}Ut(e){this.kt(1),this.buffer[this.position++]=~e}kt(e){var t=e+this.position;if(!(t<=this.buffer.length)){let e=2*this.buffer.length;e<t&&(e=t);const n=new Uint8Array(e);n.set(this.buffer),this.buffer=n}}}class es{constructor(e){this.Gt=e}ft(e){this.Gt.Dt(e)}At(e){this.Gt.Ot(e)}dt(e){this.Gt.Lt(e)}Tt(){this.Gt.Qt()}}class ts{constructor(e){this.Gt=e}ft(e){this.Gt.Ft(e)}At(e){this.Gt.Nt(e)}dt(e){this.Gt.qt(e)}Tt(){this.Gt.$t()}}class ns{constructor(){this.Gt=new Zi,this.zt=new es(this.Gt),this.jt=new ts(this.Gt)}seed(e){this.Gt.seed(e)}Ht(e){return 0===e?this.zt:this.jt}Wt(){return this.Gt.Wt()}reset(){this.Gt.reset()}}class rs{constructor(e,t,n,r){this.indexId=e,this.documentKey=t,this.arrayValue=n,this.directionalValue=r}Jt(){const e=this.directionalValue.length,t=0===e||255===this.directionalValue[e-1]?e+1:e,n=new Uint8Array(t);return n.set(this.directionalValue,0),t!==e?n.set([0],this.directionalValue.length):++n[n.length-1],new rs(this.indexId,this.documentKey,this.arrayValue,n)}}function is(e,t){let n=e.indexId-t.indexId;return 0!==n?n:(n=ss(e.arrayValue,t.arrayValue),0!==n?n:(n=ss(e.directionalValue,t.directionalValue),0!==n?n:me.comparator(e.documentKey,t.documentKey)))}function ss(e,t){for(let r=0;r<e.length&&r<t.length;++r){var n=e[r]-t[r];if(0!=n)return n}return e.length-t.length}class as{constructor(e){this.Yt=new xt(((e,t)=>ge.comparator(e.field,t.field))),this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.Zt=e.orderBy,this.Xt=[];for(const t of e.filters){const e=t;e.isInequality()?this.Yt=this.Yt.add(e):this.Xt.push(e)}}get en(){return 1<this.Yt.size}tn(e){if(Q(e.collectionGroup===this.collectionId),this.en)return!1;const t=ye(e);if(void 0!==t&&!this.nn(t))return!1;const n=ve(e);let r=new Set,i=0,s=0;for(;i<n.length&&this.nn(n[i]);++i)r=r.add(n[i].fieldPath.canonicalString());if(i===n.length)return!0;if(0<this.Yt.size){const e=this.Yt.getIterator().getNext();if(!r.has(e.field.canonicalString())){const t=n[i];if(!this.rn(e,t)||!this.sn(this.Zt[s++],t))return!1}++i}for(;i<n.length;++i){const e=n[i];if(s>=this.Zt.length||!this.sn(this.Zt[s++],e))return!1}return!0}on(){if(this.en)return null;let e=new xt(ge.comparator);const t=[];for(const n of this.Xt)n.field.isKeyField()||("array-contains"===n.op||"array-contains-any"===n.op?t.push(new we(n.field,2)):e.has(n.field)||(e=e.add(n.field),t.push(new we(n.field,0))));for(const n of this.Zt)n.field.isKeyField()||e.has(n.field)||(e=e.add(n.field),t.push(new we(n.field,"asc"===n.dir?0:1)));return new pe(pe.UNKNOWN_ID,this.collectionId,t,_e.empty())}nn(e){for(const t of this.Xt)if(this.rn(t,e))return!0;return!1}rn(e,t){if(void 0===e||!e.field.isEqual(t.fieldPath))return!1;var n="array-contains"===e.op||"array-contains-any"===e.op;return 2===t.kind==n}sn(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}function os(e){return e instanceof fn}function us(e){return e instanceof gn&&yn(e)}function cs(e){return os(e)||us(e)||function(e){if(e instanceof gn&&pn(e)){for(const t of e.getFilters())if(!os(t)&&!us(t))return!1;return!0}return!1}(e)}function hs(e,t){var n,r;return Q(e instanceof fn||e instanceof gn),Q(t instanceof fn||t instanceof gn),ds(e instanceof fn?t instanceof fn?(n=e,r=t,gn.create([n,r],"and")):ls(e,t):t instanceof fn?ls(t,e):function(e,t){if(Q(0<e.filters.length&&0<t.filters.length),mn(e)&&mn(t))return wn(e,t.getFilters());const n=pn(e)?e:t,r=pn(e)?t:e,i=n.filters.map((e=>hs(e,r)));return gn.create(i,"or")}(e,t))}function ls(e,t){if(mn(t))return wn(t,e.getFilters());var n=t.filters.map((t=>hs(e,t)));return gn.create(n,"or")}function ds(e){if(Q(e instanceof fn||e instanceof gn),e instanceof fn)return e;const t=e.getFilters();if(1===t.length)return ds(t[0]);if(vn(e))return e;const n=t.map((e=>ds(e))),r=[];return n.forEach((t=>{t instanceof fn?r.push(t):t instanceof gn&&(t.op===e.op?r.push(...t.filters):r.push(t))})),1===r.length?r[0]:gn.create(r,e.op)}class fs{constructor(){this._n=new gs}addToCollectionParentIndex(e,t){return this._n.add(t),Ce.resolve()}getCollectionParents(e,t){return Ce.resolve(this._n.getEntries(t))}addFieldIndex(e,t){return Ce.resolve()}deleteFieldIndex(e,t){return Ce.resolve()}deleteAllFieldIndexes(e){return Ce.resolve()}createTargetIndexes(e,t){return Ce.resolve()}getDocumentsMatchingTarget(e,t){return Ce.resolve(null)}getIndexType(e,t){return Ce.resolve(0)}getFieldIndexes(e,t){return Ce.resolve([])}getNextCollectionGroupToUpdate(e){return Ce.resolve(null)}getMinOffset(e,t){return Ce.resolve(Ee.min())}getMinOffsetFromCollectionGroup(e,t){return Ce.resolve(Ee.min())}updateCollectionGroup(e,t,n){return Ce.resolve()}updateIndexEntries(e,t){return Ce.resolve()}}class gs{constructor(){this.index={}}add(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new xt(de.comparator),i=!r.has(n);return this.index[t]=r.add(n),i}has(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}getEntries(e){return(this.index[e]||new xt(de.comparator)).toArray()}}const ms=new Uint8Array(0);class ps{constructor(e,t){this.databaseId=t,this.an=new gs,this.un=new Xn((e=>kn(e)),((e,t)=>Rn(e,t))),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(this.an.has(t))return Ce.resolve();var n=t.lastSegment(),r=t.popLast();return e.addOnCommittedListener((()=>{this.an.add(t)})),r={collectionId:n,parent:Ke(r)},ys(e).put(r)}getCollectionParents(e,t){const n=[],r=IDBKeyRange.bound([t,""],[ue(t),""],!1,!0);return ys(e).U(r).next((e=>{for(const r of e){if(r.collectionId!==t)break;n.push(Qe(r.parent))}return n}))}addFieldIndex(e,t){const n=ws(e),r={indexId:t.indexId,collectionGroup:t.collectionGroup,fields:t.fields.map((e=>[e.fieldPath.canonicalString(),e.kind]))};delete r.indexId;const i=n.add(r);if(t.indexState){const n=_s(e);return i.next((e=>{n.put(Ki(e,this.uid,t.indexState.sequenceNumber,t.indexState.offset))}))}return i.next()}deleteFieldIndex(e,t){const n=ws(e),r=_s(e),i=vs(e);return n.delete(t.indexId).next((()=>r.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))).next((()=>i.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))))}deleteAllFieldIndexes(e){const t=ws(e),n=vs(e),r=_s(e);return t.j().next((()=>n.j())).next((()=>r.j()))}createTargetIndexes(e,t){return Ce.forEach(this.cn(t),(t=>this.getIndexType(e,t).next((n=>{if(0===n||1===n){const n=new as(t).on();if(null!=n)return this.addFieldIndex(e,n)}}))))}getDocumentsMatchingTarget(e,t){const n=vs(e);let r=!0;const i=new Map;return Ce.forEach(this.cn(t),(t=>this.ln(e,t).next((e=>{r=r&&!!e,i.set(t,e)})))).next((()=>{if(r){let e=ar();const r=[];return Ce.forEach(i,((i,s)=>{var a;j("IndexedDbIndexManager",`Using index ${a=i,`id=${a.indexId}|cg=${a.collectionGroup}|f=${a.fields.map((e=>`${e.fieldPath}:${e.kind}`)).join(",")}`} to execute ${kn(t)}`);var o=function(e,t){var n=ye(t);if(void 0===n)return null;for(const t of Ln(e,n.fieldPath))switch(t.op){case"array-contains-any":return t.value.arrayValue.values||[];case"array-contains":return[t.value]}return null}(s,i),u=function(e,t){const n=new Map;for(const r of ve(t))for(const t of Ln(e,r.fieldPath))switch(t.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),t.value),Array.from(n.values())}return null}(s,i),c=function(e,t){const n=[];let r=!0;for(const i of ve(t)){const t=(0===i.kind?On:Fn)(e,i.fieldPath,e.startAt);n.push(t.value),r=r&&t.inclusive}return new un(n,r)}(s,i),h=function(e,t){const n=[];let r=!0;for(const i of ve(t)){const t=(0===i.kind?Fn:On)(e,i.fieldPath,e.endAt);n.push(t.value),r=r&&t.inclusive}return new un(n,r)}(s,i),l=this.hn(i,s,c),d=this.hn(i,s,h);return u=this.Pn(i,s,u),u=this.In(i.indexId,o,l,c.inclusive,d,h.inclusive,u),Ce.forEach(u,(i=>n.G(i,t.limit).next((t=>{t.forEach((t=>{var n=me.fromSegments(t.documentKey);e.has(n)||(e=e.add(n),r.push(n))}))}))))})).next((()=>r))}return Ce.resolve(null)}))}cn(e){let t=this.un.get(e);return t||(t=0===e.filters.length?[e]:function(e){if(0===e.getFilters().length)return[];const t=function e(t){if(Q(t instanceof fn||t instanceof gn),t instanceof fn)return t;if(1===t.filters.length)return e(t.filters[0]);const n=t.filters.map((t=>e(t)));let r=gn.create(n,t.op);return r=ds(r),cs(r)?r:(Q(r instanceof gn),Q(mn(r)),Q(1<r.filters.length),r.filters.reduce(((e,t)=>hs(e,t))))}(function e(t){var n;if(Q(t instanceof fn||t instanceof gn),t instanceof fn){if(t instanceof xn){const e=(null===(n=null===(n=t.value.arrayValue)||void 0===n?void 0:n.values)||void 0===n?void 0:n.map((e=>fn.create(t.field,"==",e))))||[];return gn.create(e,"or")}return t}const r=t.filters.map((t=>e(t)));return gn.create(r,t.op)}(e));return Q(cs(t)),os(t)||us(t)?[t]:t.getFilters()}(gn.create(e.filters,"and")).map((t=>Nn(e.path,e.collectionGroup,e.orderBy,t.getFilters(),e.limit,e.startAt,e.endAt))),this.un.set(e,t),t)}In(e,t,n,r,i,s,a){const o=(null!=t?t.length:1)*Math.max(n.length,i.length),u=o/(null!=t?t.length:1),c=[];for(let h=0;h<o;++h){const o=t?this.Tn(t[h/u]):ms,l=this.En(e,o,n[h%u],r),d=this.dn(e,o,i[h%u],s),f=a.map((t=>this.En(e,o,t,!0)));c.push(...this.createRange(l,d,f))}return c}En(e,t,n,r){const i=new rs(e,me.empty(),t,n);return r?i:i.Jt()}dn(e,t,n,r){const i=new rs(e,me.empty(),t,n);return r?i.Jt():i}ln(e,t){const n=new as(t),r=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,r).next((e=>{let t=null;for(const r of e)n.tn(r)&&(!t||r.fields.length>t.fields.length)&&(t=r);return t}))}getIndexType(e,t){let n=2;const r=this.cn(t);return Ce.forEach(r,(t=>this.ln(e,t).next((e=>{e?0!==n&&e.fields.length<function(e){let t=new xt(ge.comparator),n=!1;for(const r of e.filters)for(const e of r.getFlattenedFilters())e.field.isKeyField()||("array-contains"===e.op||"array-contains-any"===e.op?n=!0:t=t.add(e.field));for(const n of e.orderBy)n.field.isKeyField()||(t=t.add(n.field));return t.size+(n?1:0)}(t)&&(n=1):n=0})))).next((()=>function(e){return null!==e.limit}(t)&&1<r.length&&2===n?1:n))}An(e,t){const n=new ns;for(const i of ve(e)){const e=t.data.field(i.fieldPath);if(null==e)return null;var r=n.Ht(i.kind);Ji.bt.Pt(e,r)}return n.Wt()}Tn(e){const t=new ns;return Ji.bt.Pt(e,t.Ht(0)),t.Wt()}Rn(e,t){const n=new ns;return Ji.bt.Pt(Wt(this.databaseId,t),n.Ht(0===(r=ve(e)).length?0:r[r.length-1].kind)),n.Wt();var r}Pn(e,t,n){if(null===n)return[];let r=[];r.push(new ns);let i=0;for(const s of ve(e)){const e=n[i++];for(const n of r)if(this.Vn(t,s.fieldPath)&&Jt(e))r=this.mn(r,s,e);else{const t=n.Ht(s.kind);Ji.bt.Pt(e,t)}}return this.fn(r)}hn(e,t,n){return this.Pn(e,t,n.position)}fn(e){const t=[];for(let n=0;n<e.length;++n)t[n]=e[n].Wt();return t}mn(e,t,n){const r=[...e],i=[];for(const e of n.arrayValue.values||[])for(const n of r){const r=new ns;r.seed(n.Wt()),Ji.bt.Pt(e,r.Ht(t.kind)),i.push(r)}return i}Vn(e,t){return!!e.filters.find((e=>e instanceof fn&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op)))}getFieldIndexes(e,t){const n=ws(e),r=_s(e);return(t?n.U("collectionGroupIndex",IDBKeyRange.bound(t,t)):n.U()).next((e=>{const t=[];return Ce.forEach(e,(e=>r.get([e.indexId,this.uid]).next((n=>{var r,i,s;t.push((r=e,i=n?new _e(n.sequenceNumber,new Ee(Vi(n.readTime),new me(Qe(n.documentKey)),n.largestBatchId)):_e.empty(),s=r.fields.map((([e,t])=>new we(ge.fromServerFormat(e),t))),new pe(r.indexId,r.collectionGroup,s,i)))})))).next((()=>t))}))}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next((e=>0===e.length?null:(e.sort(((e,t)=>{var n=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!=n?n:ae(e.collectionGroup,t.collectionGroup)})),e[0].collectionGroup)))}updateCollectionGroup(e,t,n){const r=ws(e),i=_s(e);return this.gn(e).next((e=>r.U("collectionGroupIndex",IDBKeyRange.bound(t,t)).next((t=>Ce.forEach(t,(t=>i.put(Ki(t.indexId,this.uid,e,n))))))))}updateIndexEntries(e,t){const n=new Map;return Ce.forEach(t,((t,r)=>{var i=n.get(t.collectionGroup);return(i?Ce.resolve(i):this.getFieldIndexes(e,t.collectionGroup)).next((i=>(n.set(t.collectionGroup,i),Ce.forEach(i,(n=>this.pn(e,t,n).next((t=>{var i=this.yn(r,n);return t.isEqual(i)?Ce.resolve():this.wn(e,r,n,t,i)})))))))}))}Sn(e,t,n,r){return vs(e).put({indexId:r.indexId,uid:this.uid,arrayValue:r.arrayValue,directionalValue:r.directionalValue,orderedDocumentKey:this.Rn(n,t.key),documentKey:t.key.path.toArray()})}bn(e,t,n,r){return vs(e).delete([r.indexId,this.uid,r.arrayValue,r.directionalValue,this.Rn(n,t.key),t.key.path.toArray()])}pn(e,t,n){const r=vs(e);let i=new xt(is);return r.J({index:"documentKeyIndex",range:IDBKeyRange.only([n.indexId,this.uid,this.Rn(n,t)])},((e,r)=>{i=i.add(new rs(n.indexId,t,r.arrayValue,r.directionalValue))})).next((()=>i))}yn(e,t){let n=new xt(is);var r=this.An(t,e);if(null==r)return n;const i=ye(t);if(null!=i){var s=e.data.field(i.fieldPath);if(Jt(s))for(const i of s.arrayValue.values||[])n=n.add(new rs(t.indexId,e.key,this.Tn(i),r))}else n=n.add(new rs(t.indexId,e.key,ms,r));return n}wn(e,t,n,r,i){j("IndexedDbIndexManager","Updating index entries for document '%s'",t.key);const s=[];return function(e,t,n,r,i){var s=e.getIterator(),a=t.getIterator();let o=Ct(s),u=Ct(a);for(;o||u;){let e=!1,t=!1;if(o&&u){const r=n(o,u);r<0?t=!0:0<r&&(e=!0)}else null!=o?t=!0:e=!0;e?(r(u),u=Ct(a)):t?(i(o),o=Ct(s)):(o=Ct(s),u=Ct(a))}}(r,i,is,(r=>{s.push(this.Sn(e,t,n,r))}),(r=>{s.push(this.bn(e,t,n,r))})),Ce.waitFor(s)}gn(e){let t=1;return _s(e).J({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},((e,n,r)=>{r.done(),t=n.sequenceNumber+1})).next((()=>t))}createRange(e,t,n){n=n.sort(((e,t)=>is(e,t))).filter(((e,t,n)=>!t||0!==is(e,n[t-1])));const r=[];r.push(e);for(const i of n){const n=is(i,e),s=is(i,t);if(0===n)r[0]=e.Jt();else if(0<n&&s<0)r.push(i),r.push(i.Jt());else if(0<s)break}r.push(t);const i=[];for(let e=0;e<r.length;e+=2){if(this.Dn(r[e],r[e+1]))return[];const t=[r[e].indexId,this.uid,r[e].arrayValue,r[e].directionalValue,ms,[]],n=[r[e+1].indexId,this.uid,r[e+1].arrayValue,r[e+1].directionalValue,ms,[]];i.push(IDBKeyRange.bound(t,n))}return i}Dn(e,t){return 0<is(e,t)}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(bs)}getMinOffset(e,t){return Ce.mapArray(this.cn(t),(t=>this.ln(e,t).next((e=>e||$())))).next(bs)}}function ys(e){return wt(e,"collectionParents")}function vs(e){return wt(e,"indexEntries")}function ws(e){return wt(e,"indexConfiguration")}function _s(e){return wt(e,"indexState")}function bs(e){Q(0!==e.length);let t=e[0].indexState.offset,n=t.largestBatchId;for(let i=1;i<e.length;i++){var r=e[i].indexState.offset;Te(r,t)<0&&(t=r),n<r.largestBatchId&&(n=r.largestBatchId)}return new Ee(t.readTime,t.documentKey,n)}const Is={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class Es{constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}static withCacheSize(e){return new Es(e,Es.DEFAULT_COLLECTION_PERCENTILE,Es.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function Ts(e,t,n){const r=e.store("mutations"),i=e.store("documentMutations"),s=[],a=IDBKeyRange.only(n.batchId);let o=0;const u=r.J({range:a},((e,t,n)=>(o++,n.delete())));s.push(u.next((()=>{Q(1===o)})));const c=[];for(const e of n.mutations){const r=Ye(t,e.key.path,n.batchId);s.push(i.delete(r)),c.push(e.key)}return Ce.waitFor(s).next((()=>c))}function Ss(e){if(!e)return 0;let t;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw $();t=e.noDocument}return JSON.stringify(t).length}Es.DEFAULT_COLLECTION_PERCENTILE=10,Es.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,Es.DEFAULT=new Es(41943040,Es.DEFAULT_COLLECTION_PERCENTILE,Es.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),Es.DISABLED=new Es(-1,0,0);class xs{constructor(e,t,n,r){this.userId=e,this.serializer=t,this.indexManager=n,this.referenceDelegate=r,this.Cn={}}static lt(e,t,n,r){Q(""!==e.uid);var i=e.isAuthenticated()?e.uid:"";return new xs(i,t,n,r)}checkEmpty(e){let t=!0;var n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return Cs(e).J({index:"userMutationsIndex",range:n},((e,n,r)=>{t=!1,r.done()})).next((()=>t))}addMutationBatch(e,t,n,r){const i=As(e),s=Cs(e);return s.add({}).next((a=>{Q("number"==typeof a);const o=new Pr(a,t,n,r),u=(h=this.serializer,l=this.userId,f=(d=o).baseMutations.map((e=>Ei(h.ct,e))),g=d.mutations.map((e=>Ei(h.ct,e))),{userId:l,batchId:d.batchId,localWriteTimeMs:d.localWriteTime.toMillis(),baseMutations:f,mutations:g}),c=[];var h,l,d,f,g;let m=new xt(((e,t)=>ae(e.canonicalString(),t.canonicalString())));for(const e of r){const t=Ye(this.userId,e.key.path,a);m=m.add(e.key.path.popLast()),c.push(s.put(u)),c.push(i.put(t,Je))}return m.forEach((t=>{c.push(this.indexManager.addToCollectionParentIndex(e,t))})),e.addOnCommittedListener((()=>{this.Cn[a]=o.keys()})),Ce.waitFor(c).next((()=>o))}))}lookupMutationBatch(e,t){return Cs(e).get(t).next((e=>e?(Q(e.userId===this.userId),Ui(this.serializer,e)):null))}vn(e,t){return this.Cn[t]?Ce.resolve(this.Cn[t]):this.lookupMutationBatch(e,t).next((e=>{if(e){var n=e.keys();return this.Cn[t]=n}return null}))}getNextMutationBatchAfterBatchId(e,t){const n=t+1,r=IDBKeyRange.lowerBound([this.userId,n]);let i=null;return Cs(e).J({index:"userMutationsIndex",range:r},((e,t,r)=>{t.userId===this.userId&&(Q(t.batchId>=n),i=Ui(this.serializer,t)),r.done()})).next((()=>i))}getHighestUnacknowledgedBatchId(e){var t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let n=-1;return Cs(e).J({index:"userMutationsIndex",range:t,reverse:!0},((e,t,r)=>{n=t.batchId,r.done()})).next((()=>n))}getAllMutationBatches(e){var t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return Cs(e).U("userMutationsIndex",t).next((e=>e.map((e=>Ui(this.serializer,e)))))}getAllMutationBatchesAffectingDocumentKey(e,t){const n=We(this.userId,t.path),r=IDBKeyRange.lowerBound(n),i=[];return As(e).J({range:r},((n,r,s)=>{var[a,o,u]=n,o=Qe(o);if(a===this.userId&&t.path.isEqual(o))return Cs(e).get(u).next((e=>{if(!e)throw $();Q(e.userId===this.userId),i.push(Ui(this.serializer,e))}));s.done()})).next((()=>i))}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new xt(ae);const r=[];return t.forEach((t=>{var i=We(this.userId,t.path);i=IDBKeyRange.lowerBound(i),i=As(e).J({range:i},((e,r,i)=>{var[s,a,o]=e,a=Qe(a);s===this.userId&&t.path.isEqual(a)?n=n.add(o):i.done()})),r.push(i)})),Ce.waitFor(r).next((()=>this.Fn(e,n)))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1,i=We(this.userId,n),s=IDBKeyRange.lowerBound(i);let a=new xt(ae);return As(e).J({range:s},((e,t,i)=>{var[s,o,u]=e,o=Qe(o);s===this.userId&&n.isPrefixOf(o)?o.length===r&&(a=a.add(u)):i.done()})).next((()=>this.Fn(e,a)))}Fn(e,t){const n=[],r=[];return t.forEach((t=>{r.push(Cs(e).get(t).next((e=>{if(null===e)throw $();Q(e.userId===this.userId),n.push(Ui(this.serializer,e))})))})),Ce.waitFor(r).next((()=>n))}removeMutationBatch(e,t){return Ts(e._e,this.userId,t).next((n=>(e.addOnCommittedListener((()=>{this.Mn(t.batchId)})),Ce.forEach(n,(t=>this.referenceDelegate.markPotentiallyOrphaned(e,t))))))}Mn(e){delete this.Cn[e]}performConsistencyCheck(e){return this.checkEmpty(e).next((t=>{if(!t)return Ce.resolve();const n=IDBKeyRange.lowerBound([this.userId]),r=[];return As(e).J({range:n},((e,t,n)=>{if(e[0]===this.userId){const t=Qe(e[1]);r.push(t)}else n.done()})).next((()=>{Q(0===r.length)}))}))}containsKey(e,t){return Ds(e,this.userId,t)}xn(e){return Ns(e).get(this.userId).next((e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""}))}}function Ds(e,t,n){const r=We(t,n.path),i=r[1],s=IDBKeyRange.lowerBound(r);let a=!1;return As(e).J({range:s,H:!0},((e,n,r)=>{var[s,o]=e;s===t&&o===i&&(a=!0),r.done()})).next((()=>a))}function Cs(e){return wt(e,"mutations")}function As(e){return wt(e,"documentMutations")}function Ns(e){return wt(e,"mutationQueues")}class ks{constructor(e){this.On=e}next(){return this.On+=2,this.On}static Nn(){return new ks(0)}static Ln(){return new ks(-1)}}class Rs{constructor(e,t){this.referenceDelegate=e,this.serializer=t}allocateTargetId(e){return this.Bn(e).next((t=>{const n=new ks(t.highestTargetId);return t.highestTargetId=n.next(),this.kn(e,t).next((()=>t.highestTargetId))}))}getLastRemoteSnapshotVersion(e){return this.Bn(e).next((e=>he.fromTimestamp(new ce(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds))))}getHighestSequenceNumber(e){return this.Bn(e).next((e=>e.highestListenSequenceNumber))}setTargetsMetadata(e,t,n){return this.Bn(e).next((r=>(r.highestListenSequenceNumber=t,n&&(r.lastRemoteSnapshotVersion=n.toTimestamp()),t>r.highestListenSequenceNumber&&(r.highestListenSequenceNumber=t),this.kn(e,r))))}addTargetData(e,t){return this.qn(e,t).next((()=>this.Bn(e).next((n=>(n.targetCount+=1,this.Qn(t,n),this.kn(e,n))))))}updateTargetData(e,t){return this.qn(e,t)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next((()=>Ms(e).delete(t.targetId))).next((()=>this.Bn(e))).next((t=>(Q(0<t.targetCount),--t.targetCount,this.kn(e,t))))}removeTargets(e,t,n){let r=0;const i=[];return Ms(e).J(((s,a)=>{var o=Bi(a);o.sequenceNumber<=t&&null===n.get(o.targetId)&&(r++,i.push(this.removeTargetData(e,o)))})).next((()=>Ce.waitFor(i))).next((()=>r))}forEachTarget(e,t){return Ms(e).J(((e,n)=>{var r=Bi(n);t(r)}))}Bn(e){return Ls(e).get("targetGlobalKey").next((e=>(Q(null!==e),e)))}kn(e,t){return Ls(e).put("targetGlobalKey",t)}qn(e,t){return Ms(e).put(qi(this.serializer,t))}Qn(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.Bn(e).next((e=>e.targetCount))}getTargetData(e,t){var n=kn(t);n=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]);let r=null;return Ms(e).J({range:n,index:"queryTargetsIndex"},((e,n,i)=>{var s=Bi(n);Rn(t,s.target)&&(r=s,i.done())})).next((()=>r))}addMatchingKeys(e,t,n){const r=[],i=Os(e);return t.forEach((t=>{var s=Ke(t.path);r.push(i.put({targetId:n,path:s})),r.push(this.referenceDelegate.addReference(e,n,t))})),Ce.waitFor(r)}removeMatchingKeys(e,t,n){const r=Os(e);return Ce.forEach(t,(t=>{var i=Ke(t.path);return Ce.waitFor([r.delete([n,i]),this.referenceDelegate.removeReference(e,n,t)])}))}removeMatchingKeysForTargetId(e,t){const n=Os(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(e,t){const n=IDBKeyRange.bound([t],[t+1],!1,!0),r=Os(e);let i=ar();return r.J({range:n,H:!0},((e,t,n)=>{var r=Qe(e[1]);r=new me(r),i=i.add(r)})).next((()=>i))}containsKey(e,t){var n=Ke(t.path);n=IDBKeyRange.bound([n],[ue(n)],!1,!0);let r=0;return Os(e).J({index:"documentTargetsIndex",H:!0,range:n},(([e],t,n)=>{0!==e&&(r++,n.done())})).next((()=>0<r))}ot(e,t){return Ms(e).get(t).next((e=>e?Bi(e):null))}}function Ms(e){return wt(e,"targets")}function Ls(e){return wt(e,"targetGlobal")}function Os(e){return wt(e,"targetDocuments")}function Fs([e,t],[n,r]){var i=ae(e,n);return 0===i?ae(t,r):i}class Ps{constructor(e){this.Kn=e,this.buffer=new xt(Fs),this.$n=0}Un(){return++this.$n}Wn(e){var t=[e,this.Un()];if(this.buffer.size<this.Kn)this.buffer=this.buffer.add(t);else{const e=this.buffer.last();Fs(t,e)<0&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class Vs{constructor(e,t,n){this.garbageCollector=e,this.asyncQueue=t,this.localStore=n,this.Gn=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.zn(6e4)}stop(){this.Gn&&(this.Gn.cancel(),this.Gn=null)}get started(){return null!==this.Gn}zn(e){j("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.Gn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,(async()=>{this.Gn=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){Le(e)?j("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",e):await De(e)}await this.zn(3e5)}))}}class Us{constructor(e,t){this.jn=e,this.params=t}calculateTargetCount(e,t){return this.jn.Hn(e).next((e=>Math.floor(t/100*e)))}nthSequenceNumber(e,t){if(0===t)return Ce.resolve(qe.oe);const n=new Ps(t);return this.jn.forEachTarget(e,(e=>n.Wn(e.sequenceNumber))).next((()=>this.jn.Jn(e,(e=>n.Wn(e))))).next((()=>n.maxValue))}removeTargets(e,t,n){return this.jn.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.jn.removeOrphanedDocuments(e,t)}collect(e,t){return-1===this.params.cacheSizeCollectionThreshold?(j("LruGarbageCollector","Garbage collection skipped; disabled"),Ce.resolve(Is)):this.getCacheSize(e).next((n=>n<this.params.cacheSizeCollectionThreshold?(j("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),Is):this.Yn(e,t)))}getCacheSize(e){return this.jn.getCacheSize(e)}Yn(e,t){let r,i,s,a,o,u,c;const h=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next((t=>(i=t>this.params.maximumSequenceNumbersToCollect?(j("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${t}`),this.params.maximumSequenceNumbersToCollect):t,a=Date.now(),this.nthSequenceNumber(e,i)))).next((n=>(r=n,o=Date.now(),this.removeTargets(e,r,t)))).next((t=>(s=t,u=Date.now(),this.removeOrphanedDocuments(e,r)))).next((e=>(c=Date.now(),q()<=n.DEBUG&&j("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${a-h}ms\n\tDetermined least recently used ${i} in `+(o-a)+"ms\n"+`\tRemoved ${s} targets in `+(u-o)+"ms\n"+`\tRemoved ${e} documents in `+(c-u)+"ms\n"+`Total Duration: ${c-h}ms`),Ce.resolve({didRun:!0,sequenceNumbersCollected:i,targetsRemoved:s,documentsRemoved:e}))))}}class Bs{constructor(e,t){this.db=e,this.garbageCollector=new Us(e=this,t)}Hn(e){const t=this.Zn(e);return this.db.getTargetCache().getTargetCount(e).next((e=>t.next((t=>e+t))))}Zn(e){let t=0;return this.Jn(e,(e=>{t++})).next((()=>t))}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}Jn(e,t){return this.Xn(e,((e,n)=>t(n)))}addReference(e,t,n){return qs(e,n)}removeReference(e,t,n){return qs(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return qs(e,t)}er(e,t){let n=!1;return Ns(e).Y((r=>Ds(e,r,t).next((e=>(e&&(n=!0),Ce.resolve(!e)))))).next((()=>n))}removeOrphanedDocuments(e,t){const n=this.db.getRemoteDocumentCache().newChangeBuffer(),r=[];let i=0;return this.Xn(e,((s,a)=>{if(a<=t){const t=this.er(e,s).next((t=>{if(!t)return i++,n.getEntry(e,s).next((()=>(n.removeEntry(s,he.min()),Os(e).delete(function(e){return[0,Ke(e.path)]}(s)))))}));r.push(t)}})).next((()=>Ce.waitFor(r))).next((()=>n.apply(e))).next((()=>i))}removeTarget(e,t){var n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)}updateLimboDocument(e,t){return qs(e,t)}Xn(e,t){const n=Os(e);let r,i=qe.oe;return n.J({index:"documentTargetsIndex"},(([e],{path:n,sequenceNumber:s})=>{0===e?(i!==qe.oe&&t(new me(Qe(r)),i),i=s,r=n):i=qe.oe})).next((()=>{i!==qe.oe&&t(new me(Qe(r)),i)}))}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function qs(e,t){return Os(e).put((e=e.currentSequenceNumber,{targetId:0,path:Ke(t.path),sequenceNumber:e}))}class js{constructor(){this.changes=new Xn((e=>e.toString()),((e,t)=>e.isEqual(t))),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,on.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();var n=this.changes.get(t);return void 0!==n?Ce.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class Gs{constructor(e){this.serializer=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return Qs(e).put(n)}removeEntry(e,t,n){return Qs(e).delete(function(e,t){const n=e.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],Fi(t),n[n.length-1]]}(t,n))}updateMetadata(e,t){return this.getMetadata(e).next((n=>(n.byteSize+=t,this.tr(e,n))))}getEntry(e,t){let n=on.newInvalidDocument(t);return Qs(e).J({index:"documentKeyIndex",range:IDBKeyRange.only(Hs(t))},((e,r)=>{n=this.nr(t,r)})).next((()=>n))}rr(e,t){let n={size:0,document:on.newInvalidDocument(t)};return Qs(e).J({index:"documentKeyIndex",range:IDBKeyRange.only(Hs(t))},((e,r)=>{n={document:this.nr(t,r),size:Ss(r)}})).next((()=>n))}getEntries(e,t){let n=Zn;return this.ir(e,t,((e,t)=>{var r=this.nr(e,t);n=n.insert(e,r)})).next((()=>n))}sr(e,t){let n=Zn,r=new Et(me.comparator);return this.ir(e,t,((e,t)=>{var i=this.nr(e,t);n=n.insert(e,i),r=r.insert(e,Ss(t))})).next((()=>({documents:n,_r:r})))}ir(e,t,n){if(t.isEmpty())return Ce.resolve();let r=new xt(Ys);t.forEach((e=>r=r.add(e)));const i=IDBKeyRange.bound(Hs(r.first()),Hs(r.last())),s=r.getIterator();let a=s.getNext();return Qs(e).J({index:"documentKeyIndex",range:i},((e,t,r)=>{for(var i=me.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);a&&Ys(a,i)<0;)n(a,null),a=s.getNext();a&&a.isEqual(i)&&(n(a,t),a=s.hasNext()?s.getNext():null),a?r.$(Hs(a)):r.done()})).next((()=>{for(;a;)n(a,null),a=s.hasNext()?s.getNext():null}))}getDocumentsMatchingQuery(e,t,n,r,i){const s=t.path,a=[s.popLast().toArray(),s.lastSegment(),Fi(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],o=[s.popLast().toArray(),s.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return Qs(e).U(IDBKeyRange.bound(a,o,!0)).next((e=>{null==i||i.incrementDocumentReadCount(e.length);let n=Zn;for(const i of e){const e=this.nr(me.fromSegments(i.prefixPath.concat(i.collectionGroup,i.documentId)),i);e.isFoundDocument()&&(Wn(t,e)||r.has(e.key))&&(n=n.insert(e.key,e))}return n}))}getAllFromCollectionGroup(e,t,n,r){let i=Zn;var s=Ws(t,n),a=Ws(t,Ee.max());return Qs(e).J({index:"collectionGroupIndex",range:IDBKeyRange.bound(s,a,!0)},((e,t,n)=>{var s=this.nr(me.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);i=i.insert(s.key,s),i.size===r&&n.done()})).next((()=>i))}newChangeBuffer(e){return new Ks(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next((e=>e.byteSize))}getMetadata(e){return $s(e).get("remoteDocumentGlobalKey").next((e=>(Q(!!e),e)))}tr(e,t){return $s(e).put("remoteDocumentGlobalKey",t)}nr(e,t){if(t){const e=function(e,t){let n;if(t.document)n=Ii(e.ct,t.document,!!t.hasCommittedMutations);else if(t.noDocument){const e=me.fromSegments(t.noDocument.path),r=Vi(t.noDocument.readTime);n=on.newNoDocument(e,r),t.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!t.unknownDocument)return $();{const e=me.fromSegments(t.unknownDocument.path),r=Vi(t.unknownDocument.version);n=on.newUnknownDocument(e,r)}}return t.readTime&&n.setReadTime((t=t.readTime,r=new ce(t[0],t[1]),he.fromTimestamp(r))),n;var r}(this.serializer,t);if(!e.isNoDocument()||!e.version.isEqual(he.min()))return e}return on.newInvalidDocument(e)}}function zs(e){return new Gs(e)}class Ks extends js{constructor(e,t){super(),this.ar=e,this.trackRemovals=t,this.ur=new Xn((e=>e.toString()),((e,t)=>e.isEqual(t)))}applyChanges(e){const t=[];let n=0,r=new xt(((e,t)=>ae(e.canonicalString(),t.canonicalString())));return this.changes.forEach(((i,s)=>{var a=this.ur.get(i);if(t.push(this.ar.removeEntry(e,i,a.readTime)),s.isValidDocument()){var o=Oi(this.ar.serializer,s);r=r.add(i.path.popLast());var u=Ss(o);n+=u-a.size,t.push(this.ar.addEntry(e,i,o))}else if(n-=a.size,this.trackRemovals){const n=Oi(this.ar.serializer,s.convertToNoDocument(he.min()));t.push(this.ar.addEntry(e,i,n))}})),r.forEach((n=>{t.push(this.ar.indexManager.addToCollectionParentIndex(e,n))})),t.push(this.ar.updateMetadata(e,n)),Ce.waitFor(t)}getFromCache(e,t){return this.ar.rr(e,t).next((e=>(this.ur.set(t,{size:e.size,readTime:e.document.readTime}),e.document)))}getAllFromCache(e,t){return this.ar.sr(e,t).next((({documents:e,_r:t})=>(t.forEach(((t,n)=>{this.ur.set(t,{size:n,readTime:e.get(t).readTime})})),e)))}}function $s(e){return wt(e,"remoteDocumentGlobal")}function Qs(e){return wt(e,"remoteDocumentsV14")}function Hs(e){const t=e.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function Ws(e,t){const n=t.documentKey.path.toArray();return[e,Fi(t.readTime),n.slice(0,n.length-2),0<n.length?n[n.length-1]:""]}function Ys(e,t){var n=e.path.toArray(),r=t.path.toArray();let i=0;for(let e=0;e<n.length-2&&e<r.length-2;++e)if(i=ae(n[e],r[e]),i)return i;return i=ae(n.length,r.length),i||(i=ae(n[n.length-2],r[r.length-2]),i||ae(n[n.length-1],r[r.length-1]))}class Js{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class Xs{constructor(e,t,n,r){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=r}getDocument(e,t){let n=null;return this.documentOverlayCache.getOverlay(e,t).next((r=>(n=r,this.remoteDocumentCache.getEntry(e,t)))).next((e=>(null!==n&&Cr(n.mutation,e,At.empty(),ce.now()),e)))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next((t=>this.getLocalViewOfDocuments(e,t,ar()).next((()=>t))))}getLocalViewOfDocuments(e,t,n=ar()){const r=rr();return this.populateOverlays(e,r,t).next((()=>this.computeViews(e,t,r,n).next((e=>{let t=tr();return e.forEach(((e,n)=>{t=t.insert(e,n.overlayedDocument)})),t}))))}getOverlayedDocuments(e,t){const n=rr();return this.populateOverlays(e,n,t).next((()=>this.computeViews(e,t,n,ar())))}populateOverlays(e,t,n){const r=[];return n.forEach((e=>{t.has(e)||r.push(e)})),this.documentOverlayCache.getOverlays(e,r).next((e=>{e.forEach(((e,n)=>{t.set(e,n)}))}))}computeViews(e,t,n,r){let i=Zn;const s=rr(),a=rr();return t.forEach(((e,t)=>{const a=n.get(t.key);r.has(t.key)&&(void 0===a||a.mutation instanceof kr)?i=i.insert(t.key,t):void 0!==a?(s.set(t.key,a.mutation.getFieldMask()),Cr(a.mutation,t,a.mutation.getFieldMask(),ce.now())):s.set(t.key,At.empty())})),this.recalculateAndSaveOverlays(e,i).next((e=>(e.forEach(((e,t)=>s.set(e,t))),t.forEach(((e,t)=>{var n;return a.set(e,new Js(t,null!==(n=s.get(e))&&void 0!==n?n:null))})),a)))}recalculateAndSaveOverlays(e,t){const n=rr();let r=new Et(((e,t)=>e-t)),i=ar();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next((e=>{for(const i of e)i.keys().forEach((e=>{var s,a=t.get(e);null!==a&&(s=n.get(e)||At.empty(),s=i.applyToLocalView(a,s),n.set(e,s),s=(r.get(i.batchId)||ar()).add(e),r=r.insert(i.batchId,s))}))})).next((()=>{const s=[],a=r.getReverseIterator();for(;a.hasNext();){const r=a.getNext(),o=r.key,u=r.value,c=rr();u.forEach((e=>{var r;i.has(e)||(null!==(r=xr(t.get(e),n.get(e)))&&c.set(e,r),i=i.add(e))})),s.push(this.documentOverlayCache.saveOverlays(e,o,c))}return Ce.waitFor(s)})).next((()=>n))}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next((t=>this.recalculateAndSaveOverlays(e,t)))}getDocumentsMatchingQuery(e,t,n,r){return i=t,me.isDocumentKey(i.path)&&null===i.collectionGroup&&0===i.filters.length?this.getDocumentsMatchingDocumentQuery(e,t.path):qn(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n,r):this.getDocumentsMatchingCollectionQuery(e,t,n,r);var i}getNextDocuments(e,t,n,r){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,n,r).next((i=>{const s=0<r-i.size?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,n.largestBatchId,r-i.size):Ce.resolve(rr());let a=-1,o=i;return s.next((t=>Ce.forEach(t,((t,n)=>(a<n.largestBatchId&&(a=n.largestBatchId),i.get(t)?Ce.resolve():this.remoteDocumentCache.getEntry(e,t).next((e=>{o=o.insert(t,e)}))))).next((()=>this.populateOverlays(e,t,i))).next((()=>this.computeViews(e,o,t,ar()))).next((e=>({batchId:a,changes:nr(e)})))))}))}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new me(t)).next((e=>{let t=tr();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t}))}getDocumentsMatchingCollectionGroupQuery(e,t,n,r){const i=t.collectionGroup;let s=tr();return this.indexManager.getCollectionParents(e,i).next((a=>Ce.forEach(a,(a=>{var o,u=(o=t,a=a.child(i),new Pn(a,null,o.explicitOrderBy.slice(),o.filters.slice(),o.limit,o.limitType,o.startAt,o.endAt));return this.getDocumentsMatchingCollectionQuery(e,u,n,r).next((e=>{e.forEach(((e,t)=>{s=s.insert(e,t)}))}))})).next((()=>s))))}getDocumentsMatchingCollectionQuery(e,t,n,r){let i;return this.documentOverlayCache.getOverlaysForCollection(e,t.path,n.largestBatchId).next((s=>(i=s,this.remoteDocumentCache.getDocumentsMatchingQuery(e,t,n,i,r)))).next((e=>{i.forEach(((t,n)=>{var r=n.getKey();null===e.get(r)&&(e=e.insert(r,on.newInvalidDocument(r)))}));let n=tr();return e.forEach(((e,r)=>{var s=i.get(e);void 0!==s&&Cr(s.mutation,r,At.empty(),ce.now()),Wn(t,r)&&(n=n.insert(e,r))})),n}))}}class Zs{constructor(e){this.serializer=e,this.cr=new Map,this.lr=new Map}getBundleMetadata(e,t){return Ce.resolve(this.cr.get(t))}saveBundleMetadata(e,t){return this.cr.set(t.id,{id:t.id,version:t.version,createTime:li(t.createTime)}),Ce.resolve()}getNamedQuery(e,t){return Ce.resolve(this.lr.get(t))}saveNamedQuery(e,t){return this.lr.set(t.name,{name:t.name,query:ji(t.bundledQuery),readTime:li(t.readTime)}),Ce.resolve()}}class ea{constructor(){this.overlays=new Et(me.comparator),this.hr=new Map}getOverlay(e,t){return Ce.resolve(this.overlays.get(t))}getOverlays(e,t){const n=rr();return Ce.forEach(t,(t=>this.getOverlay(e,t).next((e=>{null!==e&&n.set(t,e)})))).next((()=>n))}saveOverlays(e,t,n){return n.forEach(((n,r)=>{this.ht(e,t,r)})),Ce.resolve()}removeOverlaysForBatchId(e,t,n){const r=this.hr.get(n);return void 0!==r&&(r.forEach((e=>this.overlays=this.overlays.remove(e))),this.hr.delete(n)),Ce.resolve()}getOverlaysForCollection(e,t,n){const r=rr(),i=t.length+1,s=new me(t.child("")),a=this.overlays.getIteratorFrom(s);for(;a.hasNext();){const e=a.getNext().value,s=e.getKey();if(!t.isPrefixOf(s.path))break;s.path.length===i&&e.largestBatchId>n&&r.set(e.getKey(),e)}return Ce.resolve(r)}getOverlaysForCollectionGroup(e,t,n,r){let i=new Et(((e,t)=>e-t));const s=this.overlays.getIterator();for(;s.hasNext();){const e=s.getNext().value;if(e.getKey().getCollectionGroup()===t&&e.largestBatchId>n){let t=i.get(e.largestBatchId);null===t&&(t=rr(),i=i.insert(e.largestBatchId,t)),t.set(e.getKey(),e)}}const a=rr(),o=i.getIterator();for(;o.hasNext()&&(o.getNext().value.forEach(((e,t)=>a.set(e,t))),!(a.size()>=r)););return Ce.resolve(a)}ht(e,t,n){var r=this.overlays.get(n.key);if(null!==r){const e=this.hr.get(r.largestBatchId).delete(n.key);this.hr.set(r.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new Ur(t,n));let i=this.hr.get(t);void 0===i&&(i=ar(),this.hr.set(t,i)),this.hr.set(t,i.add(n.key))}}class ta{constructor(){this.Pr=new xt(na.Ir),this.Tr=new xt(na.Er)}isEmpty(){return this.Pr.isEmpty()}addReference(e,t){var n=new na(e,t);this.Pr=this.Pr.add(n),this.Tr=this.Tr.add(n)}dr(e,t){e.forEach((e=>this.addReference(e,t)))}removeReference(e,t){this.Ar(new na(e,t))}Rr(e,t){e.forEach((e=>this.removeReference(e,t)))}Vr(e){const t=new me(new de([])),n=new na(t,e),r=new na(t,e+1),i=[];return this.Tr.forEachInRange([n,r],(e=>{this.Ar(e),i.push(e.key)})),i}mr(){this.Pr.forEach((e=>this.Ar(e)))}Ar(e){this.Pr=this.Pr.delete(e),this.Tr=this.Tr.delete(e)}gr(e){var t=new me(new de([])),n=new na(t,e);t=new na(t,e+1);let r=ar();return this.Tr.forEachInRange([n,t],(e=>{r=r.add(e.key)})),r}containsKey(e){var t=new na(e,0);return null!==(t=this.Pr.firstAfterOrEqual(t))&&e.isEqual(t.key)}}class na{constructor(e,t){this.key=e,this.pr=t}static Ir(e,t){return me.comparator(e.key,t.key)||ae(e.pr,t.pr)}static Er(e,t){return ae(e.pr,t.pr)||me.comparator(e.key,t.key)}}class ra{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.yr=1,this.wr=new xt(na.Ir)}checkEmpty(e){return Ce.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,r){var i=this.yr;this.yr++,0<this.mutationQueue.length&&this.mutationQueue[this.mutationQueue.length-1];var s=new Pr(i,t,n,r);this.mutationQueue.push(s);for(const t of r)this.wr=this.wr.add(new na(t.key,i)),this.indexManager.addToCollectionParentIndex(e,t.key.path.popLast());return Ce.resolve(s)}lookupMutationBatch(e,t){return Ce.resolve(this.Sr(t))}getNextMutationBatchAfterBatchId(e,t){var n=(n=this.br(t+1))<0?0:n;return Ce.resolve(this.mutationQueue.length>n?this.mutationQueue[n]:null)}getHighestUnacknowledgedBatchId(){return Ce.resolve(0===this.mutationQueue.length?-1:this.yr-1)}getAllMutationBatches(e){return Ce.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const n=new na(t,0),r=new na(t,Number.POSITIVE_INFINITY),i=[];return this.wr.forEachInRange([n,r],(e=>{var t=this.Sr(e.pr);i.push(t)})),Ce.resolve(i)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new xt(ae);return t.forEach((e=>{var t=new na(e,0),r=new na(e,Number.POSITIVE_INFINITY);this.wr.forEachInRange([t,r],(e=>{n=n.add(e.pr)}))})),Ce.resolve(this.Dr(n))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1;let i=n;me.isDocumentKey(i)||(i=i.child(""));var s=new na(new me(i),0);let a=new xt(ae);return this.wr.forEachWhile((e=>{var t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(a=a.add(e.pr)),!0)}),s),Ce.resolve(this.Dr(a))}Dr(e){const t=[];return e.forEach((e=>{var n=this.Sr(e);null!==n&&t.push(n)})),t}removeMutationBatch(e,t){Q(0===this.Cr(t.batchId,"removed")),this.mutationQueue.shift();let n=this.wr;return Ce.forEach(t.mutations,(r=>{var i=new na(r.key,t.batchId);return n=n.delete(i),this.referenceDelegate.markPotentiallyOrphaned(e,r.key)})).next((()=>{this.wr=n}))}Mn(e){}containsKey(e,t){var n=new na(t,0);return n=this.wr.firstAfterOrEqual(n),Ce.resolve(t.isEqual(n&&n.key))}performConsistencyCheck(e){return this.mutationQueue.length,Ce.resolve()}Cr(e,t){return this.br(e)}br(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}Sr(e){var t=this.br(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class ia{constructor(e){this.vr=e,this.docs=new Et(me.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){const n=t.key,r=this.docs.get(n),i=r?r.size:0,s=this.vr(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:s}),this.size+=s-i,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){var t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){const n=this.docs.get(t);return Ce.resolve(n?n.document.mutableCopy():on.newInvalidDocument(t))}getEntries(e,t){let n=Zn;return t.forEach((e=>{const t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():on.newInvalidDocument(e))})),Ce.resolve(n)}getDocumentsMatchingQuery(e,t,n,r){let i=Zn;const s=t.path,a=new me(s.child("")),o=this.docs.getIteratorFrom(a);for(;o.hasNext();){const{key:e,value:{document:a}}=o.getNext();if(!s.isPrefixOf(e.path))break;e.path.length>s.length+1||Te(Ie(a),n)<=0||(r.has(a.key)||Wn(t,a))&&(i=i.insert(a.key,a.mutableCopy()))}return Ce.resolve(i)}getAllFromCollectionGroup(e,t,n,r){$()}Fr(e,t){return Ce.forEach(this.docs,(e=>t(e)))}newChangeBuffer(e){return new sa(this)}getSize(e){return Ce.resolve(this.size)}}class sa extends js{constructor(e){super(),this.ar=e}applyChanges(e){const t=[];return this.changes.forEach(((n,r)=>{r.isValidDocument()?t.push(this.ar.addEntry(e,r)):this.ar.removeEntry(n)})),Ce.waitFor(t)}getFromCache(e,t){return this.ar.getEntry(e,t)}getAllFromCache(e,t){return this.ar.getEntries(e,t)}}class aa{constructor(e){this.persistence=e,this.Mr=new Xn((e=>kn(e)),Rn),this.lastRemoteSnapshotVersion=he.min(),this.highestTargetId=0,this.Or=0,this.Nr=new ta,this.targetCount=0,this.Lr=ks.Nn()}forEachTarget(e,t){return this.Mr.forEach(((e,n)=>t(n))),Ce.resolve()}getLastRemoteSnapshotVersion(e){return Ce.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return Ce.resolve(this.Or)}allocateTargetId(e){return this.highestTargetId=this.Lr.next(),Ce.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.Or&&(this.Or=t),Ce.resolve()}qn(e){this.Mr.set(e.target,e);var t=e.targetId;t>this.highestTargetId&&(this.Lr=new ks(t),this.highestTargetId=t),e.sequenceNumber>this.Or&&(this.Or=e.sequenceNumber)}addTargetData(e,t){return this.qn(t),this.targetCount+=1,Ce.resolve()}updateTargetData(e,t){return this.qn(t),Ce.resolve()}removeTargetData(e,t){return this.Mr.delete(t.target),this.Nr.Vr(t.targetId),--this.targetCount,Ce.resolve()}removeTargets(e,t,n){let r=0;const i=[];return this.Mr.forEach(((s,a)=>{a.sequenceNumber<=t&&null===n.get(a.targetId)&&(this.Mr.delete(s),i.push(this.removeMatchingKeysForTargetId(e,a.targetId)),r++)})),Ce.waitFor(i).next((()=>r))}getTargetCount(e){return Ce.resolve(this.targetCount)}getTargetData(e,t){var n=this.Mr.get(t)||null;return Ce.resolve(n)}addMatchingKeys(e,t,n){return this.Nr.dr(t,n),Ce.resolve()}removeMatchingKeys(e,t,n){this.Nr.Rr(t,n);const r=this.persistence.referenceDelegate,i=[];return r&&t.forEach((t=>{i.push(r.markPotentiallyOrphaned(e,t))})),Ce.waitFor(i)}removeMatchingKeysForTargetId(e,t){return this.Nr.Vr(t),Ce.resolve()}getMatchingKeysForTargetId(e,t){var n=this.Nr.gr(t);return Ce.resolve(n)}containsKey(e,t){return Ce.resolve(this.Nr.containsKey(t))}}class oa{constructor(e,t){this.Br={},this.overlays={},this.kr=new qe(0),this.qr=!1,this.qr=!0,this.referenceDelegate=e(this),this.Qr=new aa(this),this.indexManager=new fs,this.remoteDocumentCache=new ia(e=e=>this.referenceDelegate.Kr(e)),this.serializer=new Li(t),this.$r=new Zs(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.qr=!1,Promise.resolve()}get started(){return this.qr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new ea,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.Br[e.toKey()];return n||(n=new ra(t,this.referenceDelegate),this.Br[e.toKey()]=n),n}getTargetCache(){return this.Qr}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.$r}runTransaction(e,t,n){j("MemoryPersistence","Starting transaction:",e);const r=new ua(this.kr.next());return this.referenceDelegate.Ur(),n(r).next((e=>this.referenceDelegate.Wr(r).next((()=>e)))).toPromise().then((e=>(r.raiseOnCommittedEvent(),e)))}Gr(e,t){return Ce.or(Object.values(this.Br).map((n=>()=>n.containsKey(e,t))))}}class ua extends xe{constructor(e){super(),this.currentSequenceNumber=e}}class ca{constructor(e){this.persistence=e,this.zr=new ta,this.jr=null}static Hr(e){return new ca(e)}get Jr(){if(this.jr)return this.jr;throw $()}addReference(e,t,n){return this.zr.addReference(n,t),this.Jr.delete(n.toString()),Ce.resolve()}removeReference(e,t,n){return this.zr.removeReference(n,t),this.Jr.add(n.toString()),Ce.resolve()}markPotentiallyOrphaned(e,t){return this.Jr.add(t.toString()),Ce.resolve()}removeTarget(e,t){this.zr.Vr(t.targetId).forEach((e=>this.Jr.add(e.toString())));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next((e=>{e.forEach((e=>this.Jr.add(e.toString())))})).next((()=>n.removeTargetData(e,t)))}Ur(){this.jr=new Set}Wr(e){const t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return Ce.forEach(this.Jr,(n=>{const r=me.fromPath(n);return this.Yr(e,r).next((e=>{e||t.removeEntry(r,he.min())}))})).next((()=>(this.jr=null,t.apply(e))))}updateLimboDocument(e,t){return this.Yr(e,t).next((e=>{e?this.Jr.delete(t.toString()):this.Jr.add(t.toString())}))}Kr(e){return 0}Yr(e,t){return Ce.or([()=>Ce.resolve(this.zr.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Gr(e,t)])}}class ha{constructor(e){this.serializer=e}O(e,t,n,r){const i=new Ae("createOrUpgrade",t);var s;n<1&&1<=r&&(e.createObjectStore("owner"),(s=e).createObjectStore("mutationQueues",{keyPath:"userId"}),s.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",He,{unique:!0}),s.createObjectStore("documentMutations"),la(e),e.createObjectStore("remoteDocuments"));let a=Ce.resolve();return n<3&&3<=r&&(0!==n&&((s=e).deleteObjectStore("targetDocuments"),s.deleteObjectStore("targets"),s.deleteObjectStore("targetGlobal"),la(e)),a=a.next((()=>function(e){const t=e.store("targetGlobal"),n={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:he.min().toTimestamp(),targetCount:0};return t.put("targetGlobalKey",n)}(i)))),n<4&&4<=r&&(0!==n&&(a=a.next((()=>function(e,t){return t.store("mutations").U().next((n=>{e.deleteObjectStore("mutations"),e.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",He,{unique:!0});const r=t.store("mutations"),i=n.map((e=>r.put(e)));return Ce.waitFor(i)}))}(e,i)))),a=a.next((()=>{e.createObjectStore("clientMetadata",{keyPath:"clientId"})}))),n<5&&5<=r&&(a=a.next((()=>this.Xr(i)))),n<6&&6<=r&&(a=a.next((()=>(function(e){e.createObjectStore("remoteDocumentGlobal")}(e),this.ei(i))))),n<7&&7<=r&&(a=a.next((()=>this.ti(i)))),n<8&&8<=r&&(a=a.next((()=>this.ni(e,i)))),n<9&&9<=r&&(a=a.next((()=>{var t;(t=e).objectStoreNames.contains("remoteDocumentChanges")&&t.deleteObjectStore("remoteDocumentChanges")}))),n<10&&10<=r&&(a=a.next((()=>this.ri(i)))),n<11&&11<=r&&(a=a.next((()=>{e.createObjectStore("bundles",{keyPath:"bundleId"}),e.createObjectStore("namedQueries",{keyPath:"name"})}))),n<12&&12<=r&&(a=a.next((()=>{!function(e){const t=e.createObjectStore("documentOverlays",{keyPath:ct});t.createIndex("collectionPathOverlayIndex",ht,{unique:!1}),t.createIndex("collectionGroupOverlayIndex",lt,{unique:!1})}(e)}))),n<13&&13<=r&&(a=a.next((()=>function(e){const t=e.createObjectStore("remoteDocumentsV14",{keyPath:Xe});t.createIndex("documentKeyIndex",Ze),t.createIndex("collectionGroupIndex",et)}(e))).next((()=>this.ii(e,i))).next((()=>e.deleteObjectStore("remoteDocuments")))),n<14&&14<=r&&(a=a.next((()=>this.si(e,i)))),n<15&&15<=r&&(a=a.next((()=>function(e){e.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),e.createObjectStore("indexState",{keyPath:st}).createIndex("sequenceNumberIndex",at,{unique:!1}),e.createObjectStore("indexEntries",{keyPath:ot}).createIndex("documentKeyIndex",ut,{unique:!1})}(e)))),n<16&&16<=r&&(a=a.next((()=>{t.objectStore("indexState").clear()})).next((()=>{t.objectStore("indexEntries").clear()}))),a}ei(e){let t=0;return e.store("remoteDocuments").J(((e,n)=>{t+=Ss(n)})).next((()=>{var n={byteSize:t};return e.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",n)}))}Xr(e){const t=e.store("mutationQueues"),n=e.store("mutations");return t.U().next((t=>Ce.forEach(t,(t=>{var r=IDBKeyRange.bound([t.userId,-1],[t.userId,t.lastAcknowledgedBatchId]);return n.U("userMutationsIndex",r).next((n=>Ce.forEach(n,(n=>{Q(n.userId===t.userId);var r=Ui(this.serializer,n);return Ts(e,t.userId,r).next((()=>{}))}))))}))))}ti(e){const t=e.store("targetDocuments"),n=e.store("remoteDocuments");return e.store("targetGlobal").get("targetGlobalKey").next((e=>{const r=[];return n.J(((n,i)=>{const s=new de(n),a=[0,Ke(s)];r.push(t.get(a).next((n=>n?Ce.resolve():(n=>t.put({targetId:0,path:Ke(n),sequenceNumber:e.highestListenSequenceNumber}))(s))))})).next((()=>Ce.waitFor(r)))}))}ni(e,t){e.createObjectStore("collectionParents",{keyPath:it});const n=t.store("collectionParents"),r=new gs,i=e=>{if(r.add(e)){const t=e.lastSegment(),r=e.popLast();return n.put({collectionId:t,parent:Ke(r)})}};return t.store("remoteDocuments").J({H:!0},((e,t)=>{const n=new de(e);return i(n.popLast())})).next((()=>t.store("documentMutations").J({H:!0},(([,e],t)=>{const n=Qe(e);return i(n.popLast())}))))}ri(e){const t=e.store("targets");return t.J(((e,n)=>{var r=Bi(n);return r=qi(this.serializer,r),t.put(r)}))}ii(e,t){const n=t.store("remoteDocuments"),r=[];return n.J(((e,n)=>{const i=t.store("remoteDocumentsV14"),s=((o=n).document?new me(de.fromString(o.document.name).popFirst(5)):o.noDocument?me.fromSegments(o.noDocument.path):o.unknownDocument?me.fromSegments(o.unknownDocument.path):$()).path.toArray(),a={prefixPath:s.slice(0,s.length-2),collectionGroup:s[s.length-2],documentId:s[s.length-1],readTime:n.readTime||[0,0],unknownDocument:n.unknownDocument,noDocument:n.noDocument,document:n.document,hasCommittedMutations:!!n.hasCommittedMutations};var o;r.push(i.put(a))})).next((()=>Ce.waitFor(r)))}si(e,t){const n=t.store("mutations"),r=zs(this.serializer),i=new oa(ca.Hr,this.serializer.ct);return n.U().next((e=>{const n=new Map;return e.forEach((e=>{var t;let r=null!==(t=n.get(e.userId))&&void 0!==t?t:ar();Ui(this.serializer,e).keys().forEach((e=>r=r.add(e))),n.set(e.userId,r)})),Ce.forEach(n,((e,n)=>{var s=new V(n),a=Wi.lt(this.serializer,s),o=i.getIndexManager(s);return s=xs.lt(s,this.serializer,o,i.referenceDelegate),new Xs(r,s,a,o).recalculateAndSaveOverlaysForDocumentKeys(new vt(t,qe.oe),e).next()}))}))}}function la(e){e.createObjectStore("targetDocuments",{keyPath:nt}).createIndex("documentTargetsIndex",rt,{unique:!0}),e.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",tt,{unique:!0}),e.createObjectStore("targetGlobal")}const da="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class fa{constructor(e,t,n,r,i,s,a,o,u,c,h=16){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.oi=i,this.window=s,this.document=a,this._i=u,this.ai=c,this.ui=h,this.kr=null,this.qr=!1,this.isPrimary=!1,this.networkEnabled=!0,this.ci=null,this.inForeground=!1,this.li=null,this.hi=null,this.Pi=Number.NEGATIVE_INFINITY,this.Ii=e=>Promise.resolve(),!fa.D())throw new W(H.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new Bs(this,r),this.Ti=t+"main",this.serializer=new Li(o),this.Ei=new Ne(this.Ti,this.ui,new ha(this.serializer)),this.Qr=new Rs(this.referenceDelegate,this.serializer),this.remoteDocumentCache=zs(this.serializer),this.$r=new $i,this.window&&this.window.localStorage?this.di=this.window.localStorage:(this.di=null,!1===c&&G("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.Ai().then((()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new W(H.FAILED_PRECONDITION,da);return this.Ri(),this.Vi(),this.mi(),this.runTransaction("getHighestListenSequenceNumber","readonly",(e=>this.Qr.getHighestSequenceNumber(e)))})).then((e=>{this.kr=new qe(e,this._i)})).then((()=>{this.qr=!0})).catch((e=>(this.Ei&&this.Ei.close(),Promise.reject(e))))}fi(e){return this.Ii=async t=>{if(this.started)return e(t)},e(this.isPrimary)}setDatabaseDeletedListener(e){this.Ei.L((async t=>{null===t.newVersion&&await e()}))}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.oi.enqueueAndForget((async()=>{this.started&&await this.Ai()})))}Ai(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",(e=>ma(e).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next((()=>{if(this.isPrimary)return this.gi(e).next((e=>{e||(this.isPrimary=!1,this.oi.enqueueRetryable((()=>this.Ii(!1))))}))})).next((()=>this.pi(e))).next((t=>this.isPrimary&&!t?this.yi(e).next((()=>!1)):!!t&&this.wi(e).next((()=>!0)))))).catch((e=>{if(Le(e))return j("IndexedDbPersistence","Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return j("IndexedDbPersistence","Releasing owner lease after error during lease refresh",e),!1})).then((e=>{this.isPrimary!==e&&this.oi.enqueueRetryable((()=>this.Ii(e))),this.isPrimary=e}))}gi(e){return ga(e).get("owner").next((e=>Ce.resolve(this.Si(e))))}bi(e){return ma(e).delete(this.clientId)}async Di(){if(this.isPrimary&&!this.Ci(this.Pi,18e5)){this.Pi=Date.now();var e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",(e=>{const t=wt(e,"clientMetadata");return t.U().next((e=>{const n=this.vi(e,18e5),r=e.filter((e=>-1===n.indexOf(e)));return Ce.forEach(r,(e=>t.delete(e.clientId))).next((()=>r))}))})).catch((()=>[]));if(this.di)for(const t of e)this.di.removeItem(this.Fi(t.clientId))}}mi(){this.hi=this.oi.enqueueAfterDelay("client_metadata_refresh",4e3,(()=>this.Ai().then((()=>this.Di())).then((()=>this.mi()))))}Si(e){return!!e&&e.ownerId===this.clientId}pi(e){return this.ai?Ce.resolve(!0):ga(e).get("owner").next((t=>{if(null!==t&&this.Ci(t.leaseTimestampMs,5e3)&&!this.Mi(t.ownerId)){if(this.Si(t)&&this.networkEnabled)return!0;if(!this.Si(t)){if(!t.allowTabSynchronization)throw new W(H.FAILED_PRECONDITION,da);return!1}}return!(!this.networkEnabled||!this.inForeground)||ma(e).U().next((e=>void 0===this.vi(e,5e3).find((e=>{if(this.clientId!==e.clientId){var t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,r=this.networkEnabled===e.networkEnabled;if(t||n&&r)return!0}return!1}))))})).next((e=>(this.isPrimary!==e&&j("IndexedDbPersistence",`Client ${e?"is":"is not"} eligible for a primary lease.`),e)))}async shutdown(){this.qr=!1,this.xi(),this.hi&&(this.hi.cancel(),this.hi=null),this.Oi(),this.Ni(),await this.Ei.runTransaction("shutdown","readwrite",["owner","clientMetadata"],(e=>{const t=new vt(e,qe.oe);return this.yi(t).next((()=>this.bi(t)))})),this.Ei.close(),this.Li()}vi(e,t){return e.filter((e=>this.Ci(e.updateTimeMs,t)&&!this.Mi(e.clientId)))}Bi(){return this.runTransaction("getActiveClients","readonly",(e=>ma(e).U().next((e=>this.vi(e,18e5).map((e=>e.clientId))))))}get started(){return this.qr}getMutationQueue(e,t){return xs.lt(e,this.serializer,t,this.referenceDelegate)}getTargetCache(){return this.Qr}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new ps(e,this.serializer.ct.databaseId)}getDocumentOverlayCache(e){return Wi.lt(this.serializer,e)}getBundleCache(){return this.$r}runTransaction(e,t,n){j("IndexedDbPersistence","Starting transaction:",e);var r,i="readonly"===t?"readonly":"readwrite",s=16===(r=this.ui)?yt:15===r?pt:14===r?mt:13===r?gt:12===r?ft:11===r?dt:void $();let a;return this.Ei.runTransaction(e,i,s,(r=>(a=new vt(r,this.kr?this.kr.next():qe.oe),"readwrite-primary"===t?this.gi(a).next((e=>!!e||this.pi(a))).next((t=>{if(!t)throw G(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.oi.enqueueRetryable((()=>this.Ii(!1))),new W(H.FAILED_PRECONDITION,Se);return n(a)})).next((e=>this.wi(a).next((()=>e)))):this.ki(a).next((()=>n(a)))))).then((e=>(a.raiseOnCommittedEvent(),e)))}ki(e){return ga(e).get("owner").next((e=>{if(null!==e&&this.Ci(e.leaseTimestampMs,5e3)&&!this.Mi(e.ownerId)&&!this.Si(e)&&!(this.ai||this.allowTabSynchronization&&e.allowTabSynchronization))throw new W(H.FAILED_PRECONDITION,da)}))}wi(e){var t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return ga(e).put("owner",t)}static D(){return Ne.D()}yi(e){const t=ga(e);return t.get("owner").next((e=>this.Si(e)?(j("IndexedDbPersistence","Releasing primary lease."),t.delete("owner")):Ce.resolve()))}Ci(e,t){var n=Date.now();return!(e<n-t||n<e&&(G(`Detected an update time that is in the future: ${e} > ${n}`),1))}Ri(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.li=()=>{this.oi.enqueueAndForget((()=>(this.inForeground="visible"===this.document.visibilityState,this.Ai())))},this.document.addEventListener("visibilitychange",this.li),this.inForeground="visible"===this.document.visibilityState)}Oi(){this.li&&(this.document.removeEventListener("visibilitychange",this.li),this.li=null)}Vi(){var e;"function"==typeof(null===(e=this.window)||void 0===e?void 0:e.addEventListener)&&(this.ci=()=>{this.xi();var e=/(?:Version|Mobile)\/1[456]/;h()&&(navigator.appVersion.match(e)||navigator.userAgent.match(e))&&this.oi.enterRestrictedMode(!0),this.oi.enqueueAndForget((()=>this.shutdown()))},this.window.addEventListener("pagehide",this.ci))}Ni(){this.ci&&(this.window.removeEventListener("pagehide",this.ci),this.ci=null)}Mi(e){var t;try{var n=null!==(null===(t=this.di)||void 0===t?void 0:t.getItem(this.Fi(e)));return j("IndexedDbPersistence",`Client '${e}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(e){return G("IndexedDbPersistence","Failed to get zombied client id.",e),!1}}xi(){if(this.di)try{this.di.setItem(this.Fi(this.clientId),String(Date.now()))}catch(e){G("Failed to set zombie client id.",e)}}Li(){if(this.di)try{this.di.removeItem(this.Fi(this.clientId))}catch(e){}}Fi(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function ga(e){return wt(e,"owner")}function ma(e){return wt(e,"clientMetadata")}function pa(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}class ya{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.qi=n,this.Qi=r}static Ki(e,t){let n=ar(),r=ar();for(const e of t.docChanges)switch(e.type){case 0:n=n.add(e.doc.key);break;case 1:r=r.add(e.doc.key)}return new ya(e,t.fromCache,n,r)}}class va{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(e){this._documentReadCount+=e}}class wa{constructor(){this.$i=!1,this.Ui=!1,this.Wi=100,this.Gi=h()?8:0<ke(c())?6:4}initialize(e,t){this.zi=e,this.indexManager=t,this.$i=!0}getDocumentsMatchingQuery(e,t,n,r){const i={result:null};return this.ji(e,t).next((e=>{i.result=e})).next((()=>{if(!i.result)return this.Hi(e,t,r,n).next((e=>{i.result=e}))})).next((()=>{if(!i.result){const n=new va;return this.Ji(e,t,n).next((r=>{if(i.result=r,this.Ui)return this.Yi(e,t,n,r.size)}))}})).next((()=>i.result))}Yi(e,t,r,i){return r.documentReadCount<this.Wi?(q()<=n.DEBUG&&j("QueryEngine","SDK will not create cache indexes for query:",Hn(t),"since it only creates cache indexes for collection contains","more than or equal to",this.Wi,"documents"),Ce.resolve()):(q()<=n.DEBUG&&j("QueryEngine","Query:",Hn(t),"scans",r.documentReadCount,"local documents and returns",i,"documents as results."),r.documentReadCount>this.Gi*i?(q()<=n.DEBUG&&j("QueryEngine","The SDK decides to create cache indexes for query:",Hn(t),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(e,Gn(t))):Ce.resolve())}ji(e,t){if(Bn(t))return Ce.resolve(null);let n=Gn(t);return this.indexManager.getIndexType(e,n).next((r=>0===r?null:(null!==t.limit&&1===r&&(t=Kn(t,null,"F"),n=Gn(t)),this.indexManager.getDocumentsMatchingTarget(e,n).next((r=>{const i=ar(...r);return this.zi.getDocuments(e,i).next((r=>this.indexManager.getMinOffset(e,n).next((n=>{var s=this.Zi(t,r);return this.Xi(t,s,i,n.readTime)?this.ji(e,Kn(t,null,"F")):this.es(e,s,t,n)}))))})))))}Hi(e,t,r,i){return Bn(t)||i.isEqual(he.min())?Ce.resolve(null):this.zi.getDocuments(e,r).next((s=>{var a=this.Zi(t,s);return this.Xi(t,a,r,i)?Ce.resolve(null):(q()<=n.DEBUG&&j("QueryEngine","Re-using previous result from %s to execute query: %s",i.toString(),Hn(t)),this.es(e,a,t,be(i,-1)).next((e=>e)))}))}Zi(e,t){let n=new xt(Jn(e));return t.forEach(((t,r)=>{Wn(e,r)&&(n=n.add(r))})),n}Xi(e,t,n,r){if(null===e.limit)return!1;if(n.size!==t.size)return!0;const i="F"===e.limitType?t.last():t.first();return!!i&&(i.hasPendingWrites||0<i.version.compareTo(r))}Ji(e,t,r){return q()<=n.DEBUG&&j("QueryEngine","Using full collection scan to execute query:",Hn(t)),this.zi.getDocumentsMatchingQuery(e,t,Ee.min(),r)}es(e,t,n,r){return this.zi.getDocumentsMatchingQuery(e,n,r).next((e=>(t.forEach((t=>{e=e.insert(t.key,t)})),e)))}}class _a{constructor(e,t,n,r){this.persistence=e,this.ts=t,this.serializer=r,this.ns=new Et(ae),this.rs=new Xn((e=>kn(e)),Rn),this.ss=new Map,this.os=e.getRemoteDocumentCache(),this.Qr=e.getTargetCache(),this.$r=e.getBundleCache(),this._s(n)}_s(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new Xs(this.os,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.os.setIndexManager(this.indexManager),this.ts.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",(t=>e.collect(t,this.ns)))}}function ba(e,t,n,r){return new _a(e,t,n,r)}async function Ia(e,t){const n=e;return n.persistence.runTransaction("Handle user change","readonly",(e=>{let r;return n.mutationQueue.getAllMutationBatches(e).next((i=>(r=i,n._s(t),n.mutationQueue.getAllMutationBatches(e)))).next((t=>{const i=[],s=[];let a=ar();for(const e of r){i.push(e.batchId);for(const t of e.mutations)a=a.add(t.key)}for(const e of t){s.push(e.batchId);for(const t of e.mutations)a=a.add(t.key)}return n.localDocuments.getDocuments(e,a).next((e=>({us:e,removedBatchIds:i,addedBatchIds:s})))}))}))}function Ea(e){const t=e;return t.persistence.runTransaction("Get last remote snapshot version","readonly",(e=>t.Qr.getLastRemoteSnapshotVersion(e)))}function Ta(e,t,n){let r=ar(),i=ar();return n.forEach((e=>r=r.add(e))),t.getEntries(e,r).next((e=>{let r=Zn;return n.forEach(((n,s)=>{const a=e.get(n);s.isFoundDocument()!==a.isFoundDocument()&&(i=i.add(n)),s.isNoDocument()&&s.version.isEqual(he.min())?(t.removeEntry(n,s.readTime),r=r.insert(n,s)):!a.isValidDocument()||0<s.version.compareTo(a.version)||0===s.version.compareTo(a.version)&&a.hasPendingWrites?(t.addEntry(s),r=r.insert(n,s)):j("LocalStore","Ignoring outdated watch update for ",n,". Current version:",a.version," Watch version:",s.version)})),{cs:r,ls:i}}))}function Sa(e,t){const n=e;return n.persistence.runTransaction("Allocate target","readwrite",(e=>{let r;return n.Qr.getTargetData(e,t).next((i=>i?(r=i,Ce.resolve(r)):n.Qr.allocateTargetId(e).next((i=>(r=new Mi(t,i,"TargetPurposeListen",e.currentSequenceNumber),n.Qr.addTargetData(e,r).next((()=>r)))))))})).then((e=>{var r=n.ns.get(e.targetId);return(null===r||0<e.snapshotVersion.compareTo(r.snapshotVersion))&&(n.ns=n.ns.insert(e.targetId,e),n.rs.set(t,e.targetId)),e}))}async function xa(e,t,n){const r=e,i=r.ns.get(t),s=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",s,(e=>r.persistence.referenceDelegate.removeTarget(e,i)))}catch(e){if(!Le(e))throw e;j("LocalStore",`Failed to update sequence numbers for target ${t}: ${e}`)}r.ns=r.ns.remove(t),r.rs.delete(i.target)}function Da(e,t,n){const r=e;let i=he.min(),s=ar();return r.persistence.runTransaction("Execute query","readwrite",(e=>function(e,t,n){const r=e,i=r.rs.get(n);return void 0!==i?Ce.resolve(r.ns.get(i)):r.Qr.getTargetData(t,n)}(r,e,Gn(t)).next((t=>{if(t)return i=t.lastLimboFreeSnapshotVersion,r.Qr.getMatchingKeysForTargetId(e,t.targetId).next((e=>{s=e}))})).next((()=>r.ts.getDocumentsMatchingQuery(e,t,n?i:he.min(),n?s:ar()))).next((e=>(Na(r,Yn(t),e),{documents:e,hs:s})))))}function Ca(e,t){const n=e,r=n.Qr,i=n.ns.get(t);return i?Promise.resolve(i.target):n.persistence.runTransaction("Get target data","readonly",(e=>r.ot(e,t).next((e=>e?e.target:null))))}function Aa(e,t){const n=e,r=n.ss.get(t)||he.min();return n.persistence.runTransaction("Get new document changes","readonly",(e=>n.os.getAllFromCollectionGroup(e,t,be(r,-1),Number.MAX_SAFE_INTEGER))).then((e=>(Na(n,t,e),e)))}function Na(e,t,n){let r=e.ss.get(t)||he.min();n.forEach(((e,t)=>{0<t.readTime.compareTo(r)&&(r=t.readTime)})),e.ss.set(t,r)}function ka(e,t){return`firestore_clients_${e}_${t}`}function Ra(e,t,n){let r=`firestore_mutations_${e}_${n}`;return t.isAuthenticated()&&(r+=`_${t.uid}`),r}function Ma(e,t){return`firestore_targets_${e}_${t}`}class La{constructor(e,t,n,r){this.user=e,this.batchId=t,this.state=n,this.error=r}static Es(e,t,n){var r=JSON.parse(n);let i,s="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return s&&r.error&&(s="string"==typeof r.error.message&&"string"==typeof r.error.code,s&&(i=new W(r.error.code,r.error.message))),s?new La(e,t,r.state,i):(G("SharedClientState",`Failed to parse mutation state for ID '${t}': ${n}`),null)}ds(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class Oa{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static Es(e,t){var n=JSON.parse(t);let r,i="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return i&&n.error&&(i="string"==typeof n.error.message&&"string"==typeof n.error.code,i&&(r=new W(n.error.code,n.error.message))),i?new Oa(e,n.state,r):(G("SharedClientState",`Failed to parse target state for ID '${e}': ${t}`),null)}ds(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class Fa{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Es(e,t){var n=JSON.parse(t);let r="object"==typeof n&&n.activeTargetIds instanceof Array,i=or;for(let e=0;r&&e<n.activeTargetIds.length;++e)r=ze(n.activeTargetIds[e]),i=i.add(n.activeTargetIds[e]);return r?new Fa(e,i):(G("SharedClientState",`Failed to parse client data for instance '${e}': ${t}`),null)}}class Pa{constructor(e,t){this.clientId=e,this.onlineState=t}static Es(e){var t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new Pa(t.clientId,t.onlineState):(G("SharedClientState",`Failed to parse online state: ${e}`),null)}}class Va{constructor(){this.activeTargetIds=or}As(e){this.activeTargetIds=this.activeTargetIds.add(e)}Rs(e){this.activeTargetIds=this.activeTargetIds.delete(e)}ds(){var e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class Ua{constructor(e,t,n,r,i){this.window=e,this.oi=t,this.persistenceKey=n,this.Vs=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.fs=this.gs.bind(this),this.ps=new Et(ae),this.started=!1,this.ys=[];var s=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=i,this.ws=ka(this.persistenceKey,this.Vs),this.Ss=`firestore_sequence_number_${this.persistenceKey}`,this.ps=this.ps.insert(this.Vs,new Va),this.bs=new RegExp(`^firestore_clients_${s}_([^_]*)$`),this.Ds=new RegExp(`^firestore_mutations_${s}_(\\d+)(?:_(.*))?$`),this.Cs=new RegExp(`^firestore_targets_${s}_(\\d+)$`),this.vs=`firestore_online_state_${this.persistenceKey}`,this.Fs=`firestore_bundle_loaded_v2_${this.persistenceKey}`,this.window.addEventListener("storage",this.fs)}static D(e){return!(!e||!e.localStorage)}async start(){const e=await this.syncEngine.Bi();for(const n of e)if(n!==this.Vs){const e=this.getItem(ka(this.persistenceKey,n));var t;!e||(t=Fa.Es(n,e))&&(this.ps=this.ps.insert(t.clientId,t))}this.Ms();const n=this.storage.getItem(this.vs);if(n){const e=this.xs(n);e&&this.Os(e)}for(const e of this.ys)this.gs(e);this.ys=[],this.window.addEventListener("pagehide",(()=>this.shutdown())),this.started=!0}writeSequenceNumber(e){this.setItem(this.Ss,JSON.stringify(e))}getAllActiveQueryTargets(){return this.Ns(this.ps)}isActiveQueryTarget(e){let t=!1;return this.ps.forEach(((n,r)=>{r.activeTargetIds.has(e)&&(t=!0)})),t}addPendingMutation(e){this.Ls(e,"pending")}updateMutationState(e,t,n){this.Ls(e,t,n),this.Bs(e)}addLocalQueryTarget(e){let t="not-current";var n;return this.isActiveQueryTarget(e)&&(!(n=this.storage.getItem(Ma(this.persistenceKey,e)))||(n=Oa.Es(e,n))&&(t=n.state)),this.ks.As(e),this.Ms(),t}removeLocalQueryTarget(e){this.ks.Rs(e),this.Ms()}isLocalQueryTarget(e){return this.ks.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(Ma(this.persistenceKey,e))}updateQueryState(e,t,n){this.qs(e,t,n)}handleUserChange(e,t,n){t.forEach((e=>{this.Bs(e)})),this.currentUser=e,n.forEach((e=>{this.addPendingMutation(e)}))}setOnlineState(e){this.Qs(e)}notifyBundleLoaded(e){this.Ks(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.fs),this.removeItem(this.ws),this.started=!1)}getItem(e){var t=this.storage.getItem(e);return j("SharedClientState","READ",e,t),t}setItem(e,t){j("SharedClientState","SET",e,t),this.storage.setItem(e,t)}removeItem(e){j("SharedClientState","REMOVE",e),this.storage.removeItem(e)}gs(e){const t=e;t.storageArea===this.storage&&(j("SharedClientState","EVENT",t.key,t.newValue),t.key!==this.ws?this.oi.enqueueRetryable((async()=>{if(this.started){if(null!==t.key)if(this.bs.test(t.key)){if(null==t.newValue){var e=this.$s(t.key);return this.Us(e,null)}if(e=this.Ws(t.key,t.newValue))return this.Us(e.clientId,e)}else if(this.Ds.test(t.key)){if(null!==t.newValue){var n=this.Gs(t.key,t.newValue);if(n)return this.zs(n)}}else if(this.Cs.test(t.key)){if(null!==t.newValue&&(n=this.js(t.key,t.newValue)))return this.Hs(n)}else if(t.key===this.vs){if(null!==t.newValue){var r=this.xs(t.newValue);if(r)return this.Os(r)}}else if(t.key===this.Ss)r=function(e){let t=qe.oe;if(null!=e)try{var n=JSON.parse(e);Q("number"==typeof n),t=n}catch(e){G("SharedClientState","Failed to read sequence number from WebStorage",e)}return t}(t.newValue),r!==qe.oe&&this.sequenceNumberHandler(r);else if(t.key===this.Fs){const e=this.Js(t.newValue);await Promise.all(e.map((e=>this.syncEngine.Ys(e))))}}else this.ys.push(t)})):G("Received WebStorage notification for local change. Another client might have garbage-collected our state"))}get ks(){return this.ps.get(this.Vs)}Ms(){this.setItem(this.ws,this.ks.ds())}Ls(e,t,n){const r=new La(this.currentUser,e,t,n),i=Ra(this.persistenceKey,this.currentUser,e);this.setItem(i,r.ds())}Bs(e){var t=Ra(this.persistenceKey,this.currentUser,e);this.removeItem(t)}Qs(e){var t={clientId:this.Vs,onlineState:e};this.storage.setItem(this.vs,JSON.stringify(t))}qs(e,t,n){const r=Ma(this.persistenceKey,e),i=new Oa(e,t,n);this.setItem(r,i.ds())}Ks(e){var t=JSON.stringify(Array.from(e));this.setItem(this.Fs,t)}$s(e){var t=this.bs.exec(e);return t?t[1]:null}Ws(e,t){var n=this.$s(e);return Fa.Es(n,t)}Gs(e,t){var n=this.Ds.exec(e),r=Number(n[1]);return n=void 0!==n[2]?n[2]:null,La.Es(new V(n),r,t)}js(e,t){var n=this.Cs.exec(e);return n=Number(n[1]),Oa.Es(n,t)}xs(e){return Pa.Es(e)}Js(e){return JSON.parse(e)}async zs(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.Zs(e.batchId,e.state,e.error);j("SharedClientState",`Ignoring mutation for non-active user ${e.user.uid}`)}Hs(e){return this.syncEngine.Xs(e.targetId,e.state,e.error)}Us(e,t){const n=t?this.ps.insert(e,t):this.ps.remove(e),r=this.Ns(this.ps),i=this.Ns(n),s=[],a=[];return i.forEach((e=>{r.has(e)||s.push(e)})),r.forEach((e=>{i.has(e)||a.push(e)})),this.syncEngine.eo(s,a).then((()=>{this.ps=n}))}Os(e){this.ps.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}Ns(e){let t=or;return e.forEach(((e,n)=>{t=t.unionWith(n.activeTargetIds)})),t}}class Ba{constructor(){this.no=new Va,this.ro={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e){return this.no.As(e),this.ro[e]||"not-current"}updateQueryState(e,t,n){this.ro[e]=t}removeLocalQueryTarget(e){this.no.Rs(e)}isLocalQueryTarget(e){return this.no.activeTargetIds.has(e)}clearQueryState(e){delete this.ro[e]}getAllActiveQueryTargets(){return this.no.activeTargetIds}isActiveQueryTarget(e){return this.no.activeTargetIds.has(e)}start(){return this.no=new Va,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class qa{io(e){}shutdown(){}}class ja{constructor(){this.so=()=>this.oo(),this._o=()=>this.ao(),this.uo=[],this.co()}io(e){this.uo.push(e)}shutdown(){window.removeEventListener("online",this.so),window.removeEventListener("offline",this._o)}co(){window.addEventListener("online",this.so),window.addEventListener("offline",this._o)}oo(){j("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const e of this.uo)e(0)}ao(){j("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const e of this.uo)e(1)}static D(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let Ga=null;function za(){return null===Ga?Ga=268435456+Math.round(2147483648*Math.random()):Ga++,"0x"+Ga.toString(16)}const Ka={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class $a{constructor(e){this.lo=e.lo,this.ho=e.ho}Po(e){this.Io=e}To(e){this.Eo=e}Ao(e){this.Ro=e}onMessage(e){this.Vo=e}close(){this.ho()}send(e){this.lo(e)}mo(){this.Io()}fo(){this.Eo()}po(e){this.Ro(e)}yo(e){this.Vo(e)}}const Qa="WebChannelConnection";class Ha extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;var t=e.ssl?"https":"http",n=encodeURIComponent(this.databaseId.projectId),r=encodeURIComponent(this.databaseId.database);this.wo=t+"://"+e.host,this.So=`projects/${n}/databases/${r}`,this.bo="(default)"===this.databaseId.database?`project_id=${n}`:`project_id=${n}&database_id=${r}`}get Do(){return!1}Co(e,t,n,r,i){const s=za(),a=this.vo(e,t.toUriEncodedString());j("RestConnection",`Sending RPC '${e}' ${s}:`,a,n);var o={"google-cloud-resource-prefix":this.So,"x-goog-request-params":this.bo};return this.Fo(o,r,i),this.Mo(e,a,o,n).then((t=>(j("RestConnection",`Received RPC '${e}' ${s}: `,t),t)),(t=>{throw z("RestConnection",`RPC '${e}' ${s} failed with error: `,t,"url: ",a,"request:",n),t}))}xo(e,t,n,r,i,s){return this.Co(e,t,n,r,i)}Fo(e,t,n){e["X-Goog-Api-Client"]="gl-js/ fire/"+U,e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),t&&t.headers.forEach(((t,n)=>e[n]=t)),n&&n.headers.forEach(((t,n)=>e[n]=t))}vo(e,t){var n=Ka[e];return`${this.wo}/v1/${t}:${n}`}terminate(){}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}Mo(e,t,n,r){const i=za();return new Promise(((s,a)=>{const o=new S;o.setWithCredentials(!0),o.listenOnce(C.COMPLETE,(()=>{try{switch(o.getLastErrorCode()){case A.NO_ERROR:var t=o.getResponseJson();j(Qa,`XHR for RPC '${e}' ${i} received:`,JSON.stringify(t)),s(t);break;case A.TIMEOUT:j(Qa,`RPC '${e}' ${i} timed out`),a(new W(H.DEADLINE_EXCEEDED,"Request time out"));break;case A.HTTP_ERROR:var n=o.getStatus();if(j(Qa,`RPC '${e}' ${i} failed with status:`,n,"response text:",o.getResponseText()),0<n){let e=o.getResponseJson();Array.isArray(e)&&(e=e[0]);var r=null==e?void 0:e.error;if(r&&r.status&&r.message){const e=(u=r.status.toLowerCase().replace(/_/g,"-"),0<=Object.values(H).indexOf(u)?u:H.UNKNOWN);a(new W(e,r.message))}else a(new W(H.UNKNOWN,"Server responded with status "+o.getStatus()))}else a(new W(H.UNAVAILABLE,"Connection failed."));break;default:$()}}finally{j(Qa,`RPC '${e}' ${i} completed.`)}var u}));var u=JSON.stringify(r);j(Qa,`RPC '${e}' ${i} sending request:`,r),o.send(t,"POST",u,n,15)}))}Oo(e,t,n){const r=za(),i=[this.wo,"/","google.firestore.v1.Firestore","/",e,"/channel"],s=M(),a=R(),o={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},u=this.longPollingOptions.timeoutSeconds;void 0!==u&&(o.longPollingTimeout=Math.round(1e3*u)),this.useFetchStreams&&(o.xmlHttpFactory=new x({})),this.Fo(o.initMessageHeaders,t,n),o.encodeInitMessageHeaders=!0;var c=i.join("");j(Qa,`Creating RPC '${e}' stream ${r}: ${c}`,o);const h=s.createWebChannel(c,o);let l=!1,d=!1;const f=new $a({lo:t=>{d?j(Qa,`Not sending because RPC '${e}' stream ${r} is closed:`,t):(l||(j(Qa,`Opening RPC '${e}' stream ${r} transport.`),h.open(),l=!0),j(Qa,`RPC '${e}' stream ${r} sending:`,t),h.send(t))},ho:()=>h.close()}),g=(e,t,n)=>{e.listen(t,(e=>{try{n(e)}catch(e){setTimeout((()=>{throw e}),0)}}))};return g(h,D.EventType.OPEN,(()=>{d||(j(Qa,`RPC '${e}' stream ${r} transport opened.`),f.mo())})),g(h,D.EventType.CLOSE,(()=>{d||(d=!0,j(Qa,`RPC '${e}' stream ${r} transport closed`),f.po())})),g(h,D.EventType.ERROR,(t=>{d||(d=!0,z(Qa,`RPC '${e}' stream ${r} transport errored:`,t),f.po(new W(H.UNAVAILABLE,"The operation could not be completed")))})),g(h,D.EventType.MESSAGE,(t=>{if(!d){var n=t.data[0];Q(!!n);var i=n.error||(null===(i=n[0])||void 0===i?void 0:i.error);if(i){j(Qa,`RPC '${e}' stream ${r} received error:`,i);const t=i.status;let n=function(e){var t=L[e];if(void 0!==t)return jr(t)}(t),s=i.message;void 0===n&&(n=H.INTERNAL,s="Unknown error status: "+t+" with message "+i.message),d=!0,f.po(new W(n,s)),h.close()}else j(Qa,`RPC '${e}' stream ${r} received:`,n),f.yo(n)}})),g(a,k.STAT_EVENT,(t=>{t.stat===N.PROXY?j(Qa,`RPC '${e}' stream ${r} detected buffering proxy`):t.stat===N.NOPROXY&&j(Qa,`RPC '${e}' stream ${r} detected no buffering proxy`)})),setTimeout((()=>{f.fo()}),0),f}}function Wa(){return"undefined"!=typeof window?window:null}function Ya(){return"undefined"!=typeof document?document:null}function Ja(e){return new oi(e,!0)}class Xa{constructor(e,t,n=1e3,r=1.5,i=6e4){this.oi=e,this.timerId=t,this.No=n,this.Lo=r,this.Bo=i,this.ko=0,this.qo=null,this.Qo=Date.now(),this.reset()}reset(){this.ko=0}Ko(){this.ko=this.Bo}$o(e){this.cancel();var t=Math.floor(this.ko+this.Uo()),n=Math.max(0,Date.now()-this.Qo),r=Math.max(0,t-n);0<r&&j("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.ko} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.qo=this.oi.enqueueAfterDelay(this.timerId,r,(()=>(this.Qo=Date.now(),e()))),this.ko*=this.Lo,this.ko<this.No&&(this.ko=this.No),this.ko>this.Bo&&(this.ko=this.Bo)}Wo(){null!==this.qo&&(this.qo.skipDelay(),this.qo=null)}cancel(){null!==this.qo&&(this.qo.cancel(),this.qo=null)}Uo(){return(Math.random()-.5)*this.ko}}class Za{constructor(e,t,n,r,i,s,a,o){this.oi=e,this.Go=n,this.zo=r,this.connection=i,this.authCredentialsProvider=s,this.appCheckCredentialsProvider=a,this.listener=o,this.state=0,this.jo=0,this.Ho=null,this.Jo=null,this.stream=null,this.Yo=new Xa(e,t)}Zo(){return 1===this.state||5===this.state||this.Xo()}Xo(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.e_()}async stop(){this.Zo()&&await this.close(0)}t_(){this.state=0,this.Yo.reset()}n_(){this.Xo()&&null===this.Ho&&(this.Ho=this.oi.enqueueAfterDelay(this.Go,6e4,(()=>this.r_())))}i_(e){this.s_(),this.stream.send(e)}async r_(){if(this.Xo())return this.close(0)}s_(){this.Ho&&(this.Ho.cancel(),this.Ho=null)}o_(){this.Jo&&(this.Jo.cancel(),this.Jo=null)}async close(e,t){this.s_(),this.o_(),this.Yo.cancel(),this.jo++,4!==e?this.Yo.reset():t&&t.code===H.RESOURCE_EXHAUSTED?(G(t.toString()),G("Using maximum backoff delay to prevent overloading the backend."),this.Yo.Ko()):t&&t.code===H.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.__(),this.stream.close(),this.stream=null),this.state=e,await this.listener.Ao(t)}__(){}auth(){this.state=1;const e=this.a_(this.jo),t=this.jo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then((([e,n])=>{this.jo===t&&this.u_(e,n)}),(t=>{e((()=>{var e=new W(H.UNKNOWN,"Fetching auth token failed: "+t.message);return this.c_(e)}))}))}u_(e,t){const n=this.a_(this.jo);this.stream=this.l_(e,t),this.stream.Po((()=>{n((()=>this.listener.Po()))})),this.stream.To((()=>{n((()=>(this.state=2,this.Jo=this.oi.enqueueAfterDelay(this.zo,1e4,(()=>(this.Xo()&&(this.state=3),Promise.resolve()))),this.listener.To())))})),this.stream.Ao((e=>{n((()=>this.c_(e)))})),this.stream.onMessage((e=>{n((()=>this.onMessage(e)))}))}e_(){this.state=5,this.Yo.$o((async()=>{this.state=0,this.start()}))}c_(e){return j("PersistentStream",`close with error: ${e}`),this.stream=null,this.close(4,e)}a_(e){return t=>{this.oi.enqueueAndForget((()=>this.jo===e?t():(j("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())))}}}class eo extends Za{constructor(e,t,n,r,i,s){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,s),this.serializer=i}l_(e,t){return this.connection.Oo("Listen",e,t)}onMessage(e){this.Yo.reset();var t=function(e,t){let n;if("targetChange"in t){t.targetChange;var r="NO_CHANGE"===(f=t.targetChange.targetChangeType||"NO_CHANGE")?0:"ADD"===f?1:"REMOVE"===f?2:"CURRENT"===f?3:"RESET"===f?4:$(),i=t.targetChange.targetIds||[],s=(f=t.targetChange.resumeToken,e.useProto3Json?(Q(void 0===f||"string"==typeof f),kt.fromBase64String(f||"")):(Q(void 0===f||f instanceof Buffer||f instanceof Uint8Array),kt.fromUint8Array(f||new Uint8Array))),a=t.targetChange.cause,o=a&&(o=void 0===(f=a).code?H.UNKNOWN:jr(f.code),new W(o,f.message||""));n=new Zr(r,i,s,o||null)}else if("documentChange"in t){t.documentChange,(h=t.documentChange).document,h.document.name,h.document.updateTime,s=pi(e,h.document.name),o=li(h.document.updateTime);var u=h.document.createTime?li(h.document.createTime):he.min(),c=new an({mapValue:{fields:h.document.fields}}),h=(u=on.newFoundDocument(s,o,u,c),c=h.targetIds||[],h.removedTargetIds||[]);n=new Jr(c,h,u.key,u)}else if("documentDelete"in t)t.documentDelete,(c=t.documentDelete).document,h=pi(e,c.document),u=c.readTime?li(c.readTime):he.min(),u=on.newNoDocument(h,u),c=c.removedTargetIds||[],n=new Jr([],c,u.key,u);else if("documentRemove"in t){t.documentRemove,(d=t.documentRemove).document;var l=pi(e,d.document),d=d.removedTargetIds||[];n=new Jr([],d,l,null)}else{if(!("filter"in t))return $();{t.filter;const e=t.filter;e.targetId;var{count:d=0,unchangedNames:l}=e;d=new Br(d,l),l=e.targetId,n=new Xr(l,d)}}var f;return n}(this.serializer,e),n=function(e){if(!("targetChange"in e))return he.min();var t=e.targetChange;return t.targetIds&&t.targetIds.length||!t.readTime?he.min():li(t.readTime)}(e);return this.listener.h_(t,n)}P_(e){const t={};t.database=wi(this.serializer),t.addTarget=function(e,t){let n;const r=t.target;if(n=Mn(r)?{documents:Si(e,r)}:{query:xi(e,r)._t},n.targetId=t.targetId,0<t.resumeToken.approximateByteSize()){n.resumeToken=hi(e,t.resumeToken);const r=ui(e,t.expectedCount);null!==r&&(n.expectedCount=r)}else if(0<t.snapshotVersion.compareTo(he.min())){n.readTime=ci(e,t.snapshotVersion.toTimestamp());const r=ui(e,t.expectedCount);null!==r&&(n.expectedCount=r)}return n}(this.serializer,e);var n=(this.serializer,null==(n=function(e){switch(e){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return $()}}(e.purpose))?null:{"goog-listen-tags":n});n&&(t.labels=n),this.i_(t)}I_(e){const t={};t.database=wi(this.serializer),t.removeTarget=e,this.i_(t)}}class to extends Za{constructor(e,t,n,r,i,s){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,s),this.serializer=i,this.T_=!1}get E_(){return this.T_}start(){this.T_=!1,this.lastStreamToken=void 0,super.start()}__(){this.T_&&this.d_([])}l_(e,t){return this.connection.Oo("Write",e,t)}onMessage(e){if(Q(!!e.streamToken),this.lastStreamToken=e.streamToken,this.T_){this.Yo.reset();var t=(r=e.writeResults,i=e.commitTime,r&&0<r.length?(Q(void 0!==i),r.map((e=>function(e,t){let n=e.updateTime?li(e.updateTime):li(t);return n.isEqual(he.min())&&(n=li(t)),new Ir(n,e.transformResults||[])}(e,i)))):[]),n=li(e.commitTime);return this.listener.A_(n,t)}var r,i;return Q(!e.writeResults||0===e.writeResults.length),this.T_=!0,this.listener.R_()}V_(){const e={};e.database=wi(this.serializer),this.i_(e)}d_(e){var t={streamToken:this.lastStreamToken,writes:e.map((e=>Ei(this.serializer,e)))};this.i_(t)}}class no extends class{}{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=n,this.serializer=r,this.m_=!1}f_(){if(this.m_)throw new W(H.FAILED_PRECONDITION,"The client has already been terminated.")}Co(e,t,n,r){return this.f_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([i,s])=>this.connection.Co(e,fi(t,n),r,i,s))).catch((e=>{throw"FirebaseError"===e.name?(e.code===H.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new W(H.UNKNOWN,e.toString())}))}xo(e,t,n,r,i){return this.f_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([s,a])=>this.connection.xo(e,fi(t,n),r,s,a,i))).catch((e=>{throw"FirebaseError"===e.name?(e.code===H.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new W(H.UNKNOWN,e.toString())}))}terminate(){this.m_=!0,this.connection.terminate()}}class ro{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.g_=0,this.p_=null,this.y_=!0}w_(){0===this.g_&&(this.S_("Unknown"),this.p_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,(()=>(this.p_=null,this.b_("Backend didn't respond within 10 seconds."),this.S_("Offline"),Promise.resolve()))))}D_(e){"Online"===this.state?this.S_("Unknown"):(this.g_++,1<=this.g_&&(this.C_(),this.b_(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.S_("Offline")))}set(e){this.C_(),this.g_=0,"Online"===e&&(this.y_=!1),this.S_(e)}S_(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}b_(e){var t=`Could not reach Cloud Firestore backend. ${e}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.y_?(G(t),this.y_=!1):j("OnlineStateTracker",t)}C_(){null!==this.p_&&(this.p_.cancel(),this.p_=null)}}class io{constructor(e,t,n,r,i){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.v_=[],this.F_=new Map,this.M_=new Set,this.x_=[],this.O_=i,this.O_.io((e=>{n.enqueueAndForget((async()=>{go(this)&&(j("RemoteStore","Restarting streams for network reachability change."),await async function(e){const t=e;t.M_.add(4),await ao(t),t.N_.set("Unknown"),t.M_.delete(4),await so(t)}(this))}))})),this.N_=new ro(n,r)}}async function so(e){if(go(e))for(const t of e.x_)await t(!0)}async function ao(e){for(const t of e.x_)await t(!1)}function oo(e,t){const n=e;n.F_.has(t.targetId)||(n.F_.set(t.targetId,t),fo(n)?lo(n):To(n).Xo()&&co(n,t))}function uo(e,t){const n=e,r=To(n);n.F_.delete(t),r.Xo()&&ho(n,t),0===n.F_.size&&(r.Xo()?r.n_():go(n)&&n.N_.set("Unknown"))}function co(e,t){var n;e.L_.xe(t.targetId),(0<t.resumeToken.approximateByteSize()||0<t.snapshotVersion.compareTo(he.min()))&&(n=e.remoteSyncer.getRemoteKeysForTarget(t.targetId).size,t=t.withExpectedCount(n)),To(e).P_(t)}function ho(e,t){e.L_.xe(t),To(e).I_(t)}function lo(e){e.L_=new ti({getRemoteKeysForTarget:t=>e.remoteSyncer.getRemoteKeysForTarget(t),ot:t=>e.F_.get(t)||null,tt:()=>e.datastore.serializer.databaseId}),To(e).start(),e.N_.w_()}function fo(e){return go(e)&&!To(e).Zo()&&0<e.F_.size}function go(e){return 0===e.M_.size}function mo(e){e.L_=void 0}async function po(e,t,n){if(!Le(t))throw t;e.M_.add(1),await ao(e),e.N_.set("Offline"),n=n||(()=>Ea(e.localStore)),e.asyncQueue.enqueueRetryable((async()=>{j("RemoteStore","Retrying IndexedDB access"),await n(),e.M_.delete(1),await so(e)}))}function yo(e,t){return t().catch((n=>po(e,n,t)))}async function vo(e){const t=e,n=So(t);let r=0<t.v_.length?t.v_[t.v_.length-1].batchId:-1;for(;go(i=t)&&i.v_.length<10;)try{const e=await function(e,t){const n=e;return n.persistence.runTransaction("Get next mutation batch","readonly",(e=>(void 0===t&&(t=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(e,t))))}(t.localStore,r);if(null===e){0===t.v_.length&&n.n_();break}r=e.batchId,function(e,t){e.v_.push(t);const n=So(e);n.Xo()&&n.E_&&n.d_(t.mutations)}(t,e)}catch(e){await po(t,e)}var i;wo(t)&&_o(t)}function wo(e){return go(e)&&!So(e).Zo()&&0<e.v_.length}function _o(e){So(e).start()}async function bo(e,t){t&&So(e).E_&&await async function(e,t){if(qr(n=t.code)&&n!==H.ABORTED){const n=e.v_.shift();So(e).t_(),await yo(e,(()=>e.remoteSyncer.rejectFailedWrite(n.batchId,t))),await vo(e)}var n}(e,t),wo(e)&&_o(e)}async function Io(e,t){const n=e;n.asyncQueue.verifyOperationInProgress(),j("RemoteStore","RemoteStore received new credentials");var r=go(n);n.M_.add(3),await ao(n),r&&n.N_.set("Unknown"),await n.remoteSyncer.handleCredentialChange(t),n.M_.delete(3),await so(n)}async function Eo(e,t){const n=e;t?(n.M_.delete(2),await so(n)):(n.M_.add(2),await ao(n),n.N_.set("Unknown"))}function To(e){return e.B_||(e.B_=function(e,t,n){const r=e;return r.f_(),new eo(t,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(e.datastore,e.asyncQueue,{Po:async function(e){e.N_.set("Online")}.bind(null,e),To:async function(e){e.F_.forEach(((t,n)=>{co(e,t)}))}.bind(null,e),Ao:async function(e,t){mo(e),fo(e)?(e.N_.D_(t),lo(e)):e.N_.set("Unknown")}.bind(null,e),h_:async function(e,t,n){if(e.N_.set("Online"),t instanceof Zr&&2===t.state&&t.cause)try{await async function(e,t){var n=t.cause;for(const r of t.targetIds)e.F_.has(r)&&(await e.remoteSyncer.rejectListen(r,n),e.F_.delete(r),e.L_.removeTarget(r))}(e,t)}catch(n){j("RemoteStore","Failed to remove targets %s: %s ",t.targetIds.join(","),n),await po(e,n)}else if(t instanceof Jr?e.L_.Ke(t):t instanceof Xr?e.L_.He(t):e.L_.We(t),!n.isEqual(he.min()))try{const t=await Ea(e.localStore);0<=n.compareTo(t)&&await function(e,t){const n=e.L_.rt(t);return n.targetChanges.forEach(((n,r)=>{if(0<n.resumeToken.approximateByteSize()){const i=e.F_.get(r);i&&e.F_.set(r,i.withResumeToken(n.resumeToken,t))}})),n.targetMismatches.forEach(((t,n)=>{const r=e.F_.get(t);var i;r&&(e.F_.set(t,r.withResumeToken(kt.EMPTY_BYTE_STRING,r.snapshotVersion)),ho(e,t),i=new Mi(r.target,t,n,r.sequenceNumber),co(e,i))})),e.remoteSyncer.applyRemoteEvent(n)}(e,n)}catch(t){j("RemoteStore","Failed to raise snapshot:",t),await po(e,t)}}.bind(null,e)}),e.x_.push((async t=>{t?(e.B_.t_(),fo(e)?lo(e):e.N_.set("Unknown")):(await e.B_.stop(),mo(e))}))),e.B_}function So(e){return e.k_||(e.k_=function(e,t,n){const r=e;return r.f_(),new to(t,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(e.datastore,e.asyncQueue,{Po:()=>Promise.resolve(),To:async function(e){So(e).V_()}.bind(null,e),Ao:bo.bind(null,e),R_:async function(e){const t=So(e);for(const n of e.v_)t.d_(n.mutations)}.bind(null,e),A_:async function(e,t,n){const r=e.v_.shift(),i=Vr.from(r,t,n);await yo(e,(()=>e.remoteSyncer.applySuccessfulWrite(i))),await vo(e)}.bind(null,e)}),e.x_.push((async t=>{t?(e.k_.t_(),await vo(e)):(await e.k_.stop(),0<e.v_.length&&(j("RemoteStore",`Stopping write stream with ${e.v_.length} pending writes`),e.v_=[]))}))),e.k_}class xo{constructor(e,t,n,r,i){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=i,this.deferred=new Y,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch((e=>{}))}get promise(){return this.deferred.promise}static createAndSchedule(e,t,n,r,i){const s=Date.now()+n,a=new xo(e,t,s,r,i);return a.start(n),a}start(e){this.timerHandle=setTimeout((()=>this.handleDelayElapsed()),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new W(H.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget((()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then((e=>this.deferred.resolve(e)))):Promise.resolve()))}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function Do(e,t){if(G("AsyncQueue",`${t}: ${e}`),Le(e))return new W(H.UNAVAILABLE,`${t}: ${e}`);throw e}class Co{constructor(e){this.comparator=e?(t,n)=>e(t,n)||me.comparator(t.key,n.key):(e,t)=>me.comparator(e.key,t.key),this.keyedMap=tr(),this.sortedSet=new Et(this.comparator)}static emptySet(e){return new Co(e.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){var t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal(((t,n)=>(e(t),!1)))}add(e){const t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){var t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof Co))return!1;if(this.size!==e.size)return!1;const t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){const e=[];return this.forEach((t=>{e.push(t.toString())})),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(e,t){const n=new Co;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class Ao{constructor(){this.q_=new Et(me.comparator)}track(e){var t=e.doc.key,n=this.q_.get(t);!n||0!==e.type&&3===n.type?this.q_=this.q_.insert(t,e):3===e.type&&1!==n.type?this.q_=this.q_.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.q_=this.q_.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.q_=this.q_.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.q_=this.q_.remove(t):1===e.type&&2===n.type?this.q_=this.q_.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.q_=this.q_.insert(t,{type:2,doc:e.doc}):$()}Q_(){const e=[];return this.q_.inorderTraversal(((t,n)=>{e.push(n)})),e}}class No{constructor(e,t,n,r,i,s,a,o,u){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=i,this.fromCache=s,this.syncStateChanged=a,this.excludesMetadataChanges=o,this.hasCachedResults=u}static fromInitialDocuments(e,t,n,r,i){const s=[];return t.forEach((e=>{s.push({type:0,doc:e})})),new No(e,t,Co.emptySet(t),s,n,r,!0,!1,i)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&$n(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;const t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let e=0;e<t.length;e++)if(t[e].type!==n[e].type||!t[e].doc.isEqual(n[e].doc))return!1;return!0}}class ko{constructor(){this.K_=void 0,this.U_=[]}W_(){return this.U_.some((e=>e.G_()))}}class Ro{constructor(){this.queries=new Xn((e=>Qn(e)),$n),this.onlineState="Unknown",this.z_=new Set}}async function Mo(e,t){const n=e;let r=3;var i=t.query;let s=n.queries.get(i);s?!s.W_()&&t.G_()&&(r=2):(s=new ko,r=t.G_()?0:1);try{switch(r){case 0:s.K_=await n.onListen(i,!0);break;case 1:s.K_=await n.onListen(i,!1);break;case 2:await n.onFirstRemoteStoreListen(i)}}catch(e){const n=Do(e,`Initialization of query '${Hn(t.query)}' failed`);return void t.onError(n)}n.queries.set(i,s),s.U_.push(t),t.j_(n.onlineState),!s.K_||t.H_(s.K_)&&Oo(n)}async function Lo(e,t){const n=e,r=t.query;let i=3;const s=n.queries.get(r);if(s){const e=s.U_.indexOf(t);0<=e&&(s.U_.splice(e,1),0===s.U_.length?i=t.G_()?0:1:!s.W_()&&t.G_()&&(i=2))}switch(i){case 0:return n.queries.delete(r),n.onUnlisten(r,!0);case 1:return n.queries.delete(r),n.onUnlisten(r,!1);case 2:return n.onLastRemoteStoreUnlisten(r);default:return}}function Oo(e){e.z_.forEach((e=>{e.next()}))}(O=O||{}).J_="default",O.Cache="cache";class Fo{constructor(e,t,n){this.query=e,this.Y_=t,this.Z_=!1,this.X_=null,this.onlineState="Unknown",this.options=n||{}}H_(e){if(!this.options.includeMetadataChanges){const t=[];for(const n of e.docChanges)3!==n.type&&t.push(n);e=new No(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.Z_?this.ea(e)&&(this.Y_.next(e),t=!0):this.ta(e,this.onlineState)&&(this.na(e),t=!0),this.X_=e,t}onError(e){this.Y_.error(e)}j_(e){this.onlineState=e;let t=!1;return this.X_&&!this.Z_&&this.ta(this.X_,e)&&(this.na(this.X_),t=!0),t}ta(e,t){return!e.fromCache||!this.G_()||(!this.options.ra||!("Offline"!==t))&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}ea(e){if(0<e.docChanges.length)return!0;var t=this.X_&&this.X_.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}na(e){e=No.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.Z_=!0,this.Y_.next(e)}G_(){return this.options.source!==O.Cache}}class Po{constructor(e,t){this.ia=e,this.byteLength=t}sa(){return"metadata"in this.ia}}class Vo{constructor(e){this.serializer=e}Ps(e){return pi(this.serializer,e)}Is(e){return e.metadata.exists?Ii(this.serializer,e.document,!1):on.newNoDocument(this.Ps(e.metadata.name),this.Ts(e.metadata.readTime))}Ts(e){return li(e)}}class Uo{constructor(e,t,n){this.oa=e,this.localStore=t,this.serializer=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=Bo(e)}_a(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;if(e.ia.namedQuery)this.queries.push(e.ia.namedQuery);else if(e.ia.documentMetadata){this.documents.push({metadata:e.ia.documentMetadata}),e.ia.documentMetadata.exists||++t;const n=de.fromString(e.ia.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else e.ia.document&&(this.documents[this.documents.length-1].document=e.ia.document,++t);return t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}aa(e){const t=new Map,n=new Vo(this.serializer);for(const i of e)if(i.metadata.queries){const e=n.Ps(i.metadata.name);for(const n of i.metadata.queries){var r=(t.get(n)||ar()).add(e);t.set(n,r)}}return t}async complete(){const e=await async function(e,t,n,r){const i=e;let s=ar(),a=Zn;for(const e of n){const n=t.Ps(e.metadata.name);e.document&&(s=s.add(n));const r=t.Is(e);r.setReadTime(t.Ts(e.metadata.readTime)),a=a.insert(n,r)}const o=i.os.newChangeBuffer({trackRemovals:!0}),u=await Sa(i,Gn(Un(de.fromString(`__bundle__/docs/${r}`))));return i.persistence.runTransaction("Apply bundle documents","readwrite",(e=>Ta(e,o,a).next((t=>(o.apply(e),t))).next((t=>i.Qr.removeMatchingKeysForTargetId(e,u.targetId).next((()=>i.Qr.addMatchingKeys(e,s,u.targetId))).next((()=>i.localDocuments.getLocalViewOfDocuments(e,t.cs,t.ls))).next((()=>t.cs))))))}(this.localStore,new Vo(this.serializer),this.documents,this.oa.id),t=this.aa(this.documents);for(const e of this.queries)await async function(e,t,n=ar()){const r=await Sa(e,Gn(ji(t.bundledQuery))),i=e;return i.persistence.runTransaction("Save named query","readwrite",(e=>{var s=li(t.readTime);return 0<=r.snapshotVersion.compareTo(s)?i.$r.saveNamedQuery(e,t):(s=r.withResumeToken(kt.EMPTY_BYTE_STRING,s),i.ns=i.ns.insert(s.targetId,s),i.Qr.updateTargetData(e,s).next((()=>i.Qr.removeMatchingKeysForTargetId(e,r.targetId))).next((()=>i.Qr.addMatchingKeys(e,n,r.targetId))).next((()=>i.$r.saveNamedQuery(e,t))))}))}(this.localStore,e,t.get(e.name));return this.progress.taskState="Success",{progress:this.progress,ua:this.collectionGroups,ca:e}}}function Bo(e){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}class qo{constructor(e){this.key=e}}class jo{constructor(e){this.key=e}}class Go{constructor(e,t){this.query=e,this.la=t,this.ha=null,this.hasCachedResults=!1,this.current=!1,this.Pa=ar(),this.mutatedKeys=ar(),this.Ia=Jn(e),this.Ta=new Co(this.Ia)}get Ea(){return this.la}da(e,t){const n=t?t.Aa:new Ao,r=(t||this).Ta;let i=(t||this).mutatedKeys,s=r,a=!1;const o="F"===this.query.limitType&&r.size===this.query.limit?r.last():null,u="L"===this.query.limitType&&r.size===this.query.limit?r.first():null;if(e.inorderTraversal(((e,t)=>{const c=r.get(e),h=Wn(this.query,t)?t:null,l=!!c&&this.mutatedKeys.has(c.key),d=!!h&&(h.hasLocalMutations||this.mutatedKeys.has(h.key)&&h.hasCommittedMutations);let f=!1;c&&h?c.data.isEqual(h.data)?l!==d&&(n.track({type:3,doc:h}),f=!0):this.Ra(c,h)||(n.track({type:2,doc:h}),f=!0,(o&&0<this.Ia(h,o)||u&&this.Ia(h,u)<0)&&(a=!0)):!c&&h?(n.track({type:0,doc:h}),f=!0):c&&!h&&(n.track({type:1,doc:c}),f=!0,(o||u)&&(a=!0)),f&&(i=h?(s=s.add(h),d?i.add(e):i.delete(e)):(s=s.delete(e),i.delete(e)))})),null!==this.query.limit)for(;s.size>this.query.limit;){const e="F"===this.query.limitType?s.last():s.first();s=s.delete(e.key),i=i.delete(e.key),n.track({type:1,doc:e})}return{Ta:s,Aa:n,Xi:a,mutatedKeys:i}}Ra(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n,r){var i=this.Ta;this.Ta=e.Ta,this.mutatedKeys=e.mutatedKeys;const s=e.Aa.Q_();s.sort(((e,t)=>function(e,t){var n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return $()}};return n(e)-n(t)}(e.type,t.type)||this.Ia(e.doc,t.doc))),this.Va(n),r=null!=r&&r;var a=t&&!r?this.ma():[],o=0===this.Pa.size&&this.current&&!r?1:0,u=o!==this.ha;return this.ha=o,0!==s.length||u?{snapshot:new No(this.query,e.Ta,i,s,e.mutatedKeys,0==o,u,!1,!!n&&0<n.resumeToken.approximateByteSize()),fa:a}:{fa:a}}j_(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({Ta:this.Ta,Aa:new Ao,mutatedKeys:this.mutatedKeys,Xi:!1},!1)):{fa:[]}}ga(e){return!this.la.has(e)&&!!this.Ta.has(e)&&!this.Ta.get(e).hasLocalMutations}Va(e){e&&(e.addedDocuments.forEach((e=>this.la=this.la.add(e))),e.modifiedDocuments.forEach((e=>{})),e.removedDocuments.forEach((e=>this.la=this.la.delete(e))),this.current=e.current)}ma(){if(!this.current)return[];const e=this.Pa;this.Pa=ar(),this.Ta.forEach((e=>{this.ga(e.key)&&(this.Pa=this.Pa.add(e.key))}));const t=[];return e.forEach((e=>{this.Pa.has(e)||t.push(new jo(e))})),this.Pa.forEach((n=>{e.has(n)||t.push(new qo(n))})),t}pa(e){this.la=e.hs,this.Pa=ar();var t=this.da(e.documents);return this.applyChanges(t,!0)}ya(){return No.fromInitialDocuments(this.query,this.Ta,this.mutatedKeys,0===this.ha,this.hasCachedResults)}}class zo{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class Ko{constructor(e){this.key=e,this.wa=!1}}class $o{constructor(e,t,n,r,i,s){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=i,this.maxConcurrentLimboResolutions=s,this.Sa={},this.ba=new Xn((e=>Qn(e)),$n),this.Da=new Map,this.Ca=new Set,this.va=new Et(me.comparator),this.Fa=new Map,this.Ma=new ta,this.xa={},this.Oa=new Map,this.Na=ks.Ln(),this.onlineState="Unknown",this.La=void 0}get isPrimaryClient(){return!0===this.La}}async function Qo(e,t,n,r){var i=await Sa(e.localStore,Gn(t)),s=i.targetId,a=n?e.sharedClientState.addLocalQueryTarget(s):"not-current";let o;return r&&(o=await Ho(e,t,s,"current"===a,i.resumeToken)),e.isPrimaryClient&&n&&oo(e.remoteStore,i),o}async function Ho(e,t,n,r,i){e.Ba=(t,n,r)=>async function(e,t,n,r){let i=t.view.da(n);i.Xi&&(i=await Da(e.localStore,t.query,!1).then((({documents:e})=>t.view.da(e,i))));var s=r&&r.targetChanges.get(t.targetId),a=r&&null!=r.targetMismatches.get(t.targetId);return a=t.view.applyChanges(i,e.isPrimaryClient,s,a),nu(e,t.targetId,a.fa),a.snapshot}(e,t,n,r);const s=await Da(e.localStore,t,!0),a=new Go(t,s.hs),o=a.da(s.documents),u=Yr.createSynthesizedTargetChangeForCurrentChange(n,r&&"Offline"!==e.onlineState,i),c=a.applyChanges(o,e.isPrimaryClient,u);nu(e,n,c.fa);var h=new zo(t,n,a);return e.ba.set(t,h),e.Da.has(n)?e.Da.get(n).push(t):e.Da.set(n,[t]),c.snapshot}async function Wo(e,t){const n=e;try{const e=await function(e,t){const n=e,r=t.snapshotVersion;let i=n.ns;return n.persistence.runTransaction("Apply remote event","readwrite-primary",(e=>{const s=n.os.newChangeBuffer({trackRemovals:!0});i=n.ns;const a=[];t.targetChanges.forEach(((s,o)=>{const u=i.get(o);if(u){a.push(n.Qr.removeMatchingKeys(e,s.removedDocuments,o).next((()=>n.Qr.addMatchingKeys(e,s.addedDocuments,o))));let d=u.withSequenceNumber(e.currentSequenceNumber);var c,h,l;null!==t.targetMismatches.get(o)?d=d.withResumeToken(kt.EMPTY_BYTE_STRING,he.min()).withLastLimboFreeSnapshotVersion(he.min()):0<s.resumeToken.approximateByteSize()&&(d=d.withResumeToken(s.resumeToken,r)),i=i.insert(o,d),h=d,l=s,0!==(c=u).resumeToken.approximateByteSize()&&!(3e8<=h.snapshotVersion.toMicroseconds()-c.snapshotVersion.toMicroseconds()||0<l.addedDocuments.size+l.modifiedDocuments.size+l.removedDocuments.size)||a.push(n.Qr.updateTargetData(e,d))}}));let o=Zn,u=ar();if(t.documentUpdates.forEach((r=>{t.resolvedLimboDocuments.has(r)&&a.push(n.persistence.referenceDelegate.updateLimboDocument(e,r))})),a.push(Ta(e,s,t.documentUpdates).next((e=>{o=e.cs,u=e.ls}))),!r.isEqual(he.min())){const t=n.Qr.getLastRemoteSnapshotVersion(e).next((t=>n.Qr.setTargetsMetadata(e,e.currentSequenceNumber,r)));a.push(t)}return Ce.waitFor(a).next((()=>s.apply(e))).next((()=>n.localDocuments.getLocalViewOfDocuments(e,o,u))).next((()=>o))})).then((e=>(n.ns=i,e)))}(n.localStore,t);t.targetChanges.forEach(((e,t)=>{const r=n.Fa.get(t);r&&(Q(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1),0<e.addedDocuments.size?r.wa=!0:0<e.modifiedDocuments.size?Q(r.wa):0<e.removedDocuments.size&&(Q(r.wa),r.wa=!1))})),await iu(n,e,t)}catch(e){await De(e)}}function Yo(e,t,n){const r=e;if(r.isPrimaryClient&&0===n||!r.isPrimaryClient&&1===n){const e=[];r.ba.forEach(((n,r)=>{var i=r.view.j_(t);i.snapshot&&e.push(i.snapshot)})),function(e,t){const n=e;n.onlineState=t;let r=!1;n.queries.forEach(((e,n)=>{for(const e of n.U_)e.j_(t)&&(r=!0)})),r&&Oo(n)}(r.eventManager,t),e.length&&r.Sa.h_(e),r.onlineState=t,r.isPrimaryClient&&r.sharedClientState.setOnlineState(t)}}async function Jo(e,t){const n=e,r=t.batch.batchId;try{const e=await function(e,t){const n=e;return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",(e=>{const r=t.batch.keys(),i=n.os.newChangeBuffer({trackRemovals:!0});return function(e,t,n,r){const i=n.batch,s=i.keys();let a=Ce.resolve();return s.forEach((e=>{a=a.next((()=>r.getEntry(t,e))).next((t=>{var s=n.docVersions.get(e);Q(null!==s),t.version.compareTo(s)<0&&(i.applyToRemoteDocument(t,n),t.isValidDocument()&&(t.setReadTime(n.commitVersion),r.addEntry(t)))}))})),a.next((()=>e.mutationQueue.removeMutationBatch(t,i)))}(n,e,t,i).next((()=>i.apply(e))).next((()=>n.mutationQueue.performConsistencyCheck(e))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t.batch.batchId))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(e){let t=ar();for(let n=0;n<e.mutationResults.length;++n)0<e.mutationResults[n].transformResults.length&&(t=t.add(e.batch.mutations[n].key));return t}(t)))).next((()=>n.localDocuments.getDocuments(e,r)))}))}(n.localStore,t);Zo(n,r,null),Xo(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await iu(n,e)}catch(e){await De(e)}}function Xo(e,t){(e.Oa.get(t)||[]).forEach((e=>{e.resolve()})),e.Oa.delete(t)}function Zo(e,t,n){const r=e;let i=r.xa[r.currentUser.toKey()];if(i){const e=i.get(t);e&&(n?e.reject(n):e.resolve(),i=i.remove(t)),r.xa[r.currentUser.toKey()]=i}}function eu(e,t,n=null){e.sharedClientState.removeLocalQueryTarget(t);for(const r of e.Da.get(t))e.ba.delete(r),n&&e.Sa.ka(r,n);e.Da.delete(t),e.isPrimaryClient&&e.Ma.Vr(t).forEach((t=>{e.Ma.containsKey(t)||tu(e,t)}))}function tu(e,t){e.Ca.delete(t.path.canonicalString());var n=e.va.get(t);null!==n&&(uo(e.remoteStore,n),e.va=e.va.remove(t),e.Fa.delete(n),ru(e))}function nu(e,t,n){for(const r of n)r instanceof qo?(e.Ma.addReference(r.key,t),function(e,t){const n=t.key,r=n.path.canonicalString();e.va.get(n)||e.Ca.has(r)||(j("SyncEngine","New document in limbo: "+n),e.Ca.add(r),ru(e))}(e,r)):r instanceof jo?(j("SyncEngine","Document no longer in limbo: "+r.key),e.Ma.removeReference(r.key,t),e.Ma.containsKey(r.key)||tu(e,r.key)):$()}function ru(e){for(;0<e.Ca.size&&e.va.size<e.maxConcurrentLimboResolutions;){var t=e.Ca.values().next().value;e.Ca.delete(t);var n=new me(de.fromString(t));t=e.Na.next(),e.Fa.set(t,new Ko(n)),e.va=e.va.insert(n,t),oo(e.remoteStore,new Mi(Gn(Un(n.path)),t,"TargetPurposeLimboResolution",qe.oe))}}async function iu(e,t,n){const r=e,i=[],s=[],a=[];r.ba.isEmpty()||(r.ba.forEach(((e,o)=>{a.push(r.Ba(o,t,n).then((e=>{var t;(e||n)&&r.isPrimaryClient&&(t=e&&!e.fromCache,r.sharedClientState.updateQueryState(o.targetId,t?"current":"not-current")),e&&(i.push(e),t=ya.Ki(o.targetId,e),s.push(t))})))})),await Promise.all(a),r.Sa.h_(i),await async function(e,t){const n=e;try{await n.persistence.runTransaction("notifyLocalViewChanges","readwrite",(e=>Ce.forEach(t,(t=>Ce.forEach(t.qi,(r=>n.persistence.referenceDelegate.addReference(e,t.targetId,r))).next((()=>Ce.forEach(t.Qi,(r=>n.persistence.referenceDelegate.removeReference(e,t.targetId,r)))))))))}catch(e){if(!Le(e))throw e;j("LocalStore","Failed to update sequence numbers: "+e)}for(const e of t){const t=e.targetId;if(!e.fromCache){const e=n.ns.get(t),r=e.snapshotVersion,i=e.withLastLimboFreeSnapshotVersion(r);n.ns=n.ns.insert(t,i)}}}(r.localStore,s))}async function su(e,t){const n=e,r=[],i=[];for(const e of t){let t;const c=n.Da.get(e);if(c&&0!==c.length){t=await Sa(n.localStore,Gn(c[0]));for(const e of c){const t=n.ba.get(e),r=(s=n,a=t,u=void 0,u=await Da((o=s).localStore,a.query,!0),u=a.view.pa(u),o.isPrimaryClient&&nu(o,a.targetId,u.fa),await u);r.snapshot&&i.push(r.snapshot)}}else{const r=await Ca(n.localStore,e);t=await Sa(n.localStore,r),await Ho(n,au(r),e,!1,t.resumeToken)}r.push(t)}var s,a,o,u;return n.Sa.h_(i),r}function au(e){return Vn(e.path,e.collectionGroup,e.orderBy,e.filters,e.limit,"F",e.startAt,e.endAt)}function ou(e){const t=e;return t.remoteStore.remoteSyncer.applyRemoteEvent=Wo.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=function(e,t){const n=e,r=n.Fa.get(t);if(r&&r.wa)return ar().add(r.key);{let e=ar();const r=n.Da.get(t);if(!r)return e;for(const t of r){const r=n.ba.get(t);e=e.unionWith(r.view.Ea)}return e}}.bind(null,t),t.remoteStore.remoteSyncer.rejectListen=async function(e,t,n){const r=e;r.sharedClientState.updateQueryState(t,"rejected",n);const i=r.Fa.get(t),s=i&&i.key;if(s){let e=new Et(me.comparator);e=e.insert(s,on.newNoDocument(s,he.min()));const n=ar().add(s),i=new Wr(he.min(),new Map,new Et(ae),e,n);await Wo(r,i),r.va=r.va.remove(s),r.Fa.delete(t),ru(r)}else await xa(r.localStore,t,!1).then((()=>eu(r,t,n))).catch(De)}.bind(null,t),t.Sa.h_=function(e,t){const n=e;let r=!1;for(const e of t){const t=e.query,i=n.queries.get(t);if(i){for(const t of i.U_)t.H_(e)&&(r=!0);i.K_=e}}r&&Oo(n)}.bind(null,t.eventManager),t.Sa.ka=function(e,t,n){const r=e,i=r.queries.get(t);if(i)for(const e of i.U_)e.onError(n);r.queries.delete(t)}.bind(null,t.eventManager),t}function uu(e){const t=e;return t.remoteStore.remoteSyncer.applySuccessfulWrite=Jo.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=async function(e,t,n){const r=e;try{const e=await function(e,t){const n=e;return n.persistence.runTransaction("Reject batch","readwrite-primary",(e=>{let r;return n.mutationQueue.lookupMutationBatch(e,t).next((t=>(Q(null!==t),r=t.keys(),n.mutationQueue.removeMutationBatch(e,t)))).next((()=>n.mutationQueue.performConsistencyCheck(e))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,r))).next((()=>n.localDocuments.getDocuments(e,r)))}))}(r.localStore,t);Zo(r,t,n),Xo(r,t),r.sharedClientState.updateMutationState(t,"rejected",n),await iu(r,e)}catch(n){await De(n)}}.bind(null,t),t}class cu{constructor(){this.synchronizeTabs=!1}async initialize(e){this.serializer=Ja(e.databaseInfo.databaseId),this.sharedClientState=this.createSharedClientState(e),this.persistence=this.createPersistence(e),await this.persistence.start(),this.localStore=this.createLocalStore(e),this.gcScheduler=this.createGarbageCollectionScheduler(e,this.localStore),this.indexBackfillerScheduler=this.createIndexBackfillerScheduler(e,this.localStore)}createGarbageCollectionScheduler(e,t){return null}createIndexBackfillerScheduler(e,t){return null}createLocalStore(e){return ba(this.persistence,new wa,e.initialUser,this.serializer)}createPersistence(e){return new oa(ca.Hr,this.serializer)}createSharedClientState(e){return new Ba}async terminate(){var e;null===(e=this.gcScheduler)||void 0===e||e.stop(),null===(e=this.indexBackfillerScheduler)||void 0===e||e.stop(),this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class hu extends cu{constructor(e,t,n){super(),this.Qa=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await this.Qa.initialize(this,e),await uu(this.Qa.syncEngine),await vo(this.Qa.remoteStore),await this.persistence.fi((()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve())))}createLocalStore(e){return ba(this.persistence,new wa,e.initialUser,this.serializer)}createGarbageCollectionScheduler(e,t){var n=this.persistence.referenceDelegate.garbageCollector;return new Vs(n,e.asyncQueue,t)}createIndexBackfillerScheduler(e,t){var n=new Be(t,this.persistence);return new Ue(e.asyncQueue,n)}createPersistence(e){var t=pa(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?Es.withCacheSize(this.cacheSizeBytes):Es.DEFAULT;return new fa(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,Wa(),Ya(),this.serializer,this.sharedClientState,!!this.forceOwnership)}createSharedClientState(e){return new Ba}}class lu extends hu{constructor(e,t){super(e,t,!1),this.Qa=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}async initialize(e){await super.initialize(e);var t=this.Qa.syncEngine;this.sharedClientState instanceof Ua&&(this.sharedClientState.syncEngine={Zs:async function(e,t,n,r){var i=e,s=await function(e,t){const n=e,r=n.mutationQueue;return n.persistence.runTransaction("Lookup mutation documents","readonly",(e=>r.vn(e,t).next((t=>t?n.localDocuments.getDocuments(e,t):Ce.resolve(null)))))}(i.localStore,t);null!==s?("pending"===n?await vo(i.remoteStore):"acknowledged"===n||"rejected"===n?(Zo(i,t,r||null),Xo(i,t),i.localStore.mutationQueue.Mn(t)):$(),await iu(i,s)):j("SyncEngine","Cannot apply mutation batch with id: "+t)}.bind(null,t),Xs:async function(e,t,n,r){const i=e;if(i.La)j("SyncEngine","Ignoring unexpected query state notification.");else{var s=i.Da.get(t);if(s&&0<s.length)switch(n){case"current":case"not-current":{const e=await Aa(i.localStore,Yn(s[0])),r=Wr.createSynthesizedRemoteEventForCurrentChange(t,"current"===n,kt.EMPTY_BYTE_STRING);await iu(i,e,r);break}case"rejected":await xa(i.localStore,t,!0),eu(i,t,r);break;default:$()}}}.bind(null,t),eo:async function(e,t,n){const r=ou(e);if(r.La){for(const e of t)if(r.Da.has(e)&&r.sharedClientState.isActiveQueryTarget(e))j("SyncEngine","Adding an already active target "+e);else{const t=await Ca(r.localStore,e),n=await Sa(r.localStore,t);await Ho(r,au(t),n.targetId,!1,n.resumeToken),oo(r.remoteStore,n)}for(const e of n)r.Da.has(e)&&await xa(r.localStore,e,!1).then((()=>{uo(r.remoteStore,e),eu(r,e)})).catch(De)}}.bind(null,t),Bi:function(e){return e.localStore.persistence.Bi()}.bind(null,t),Ys:async function(e,t){const n=e;return Aa(n.localStore,t).then((e=>iu(n,e)))}.bind(null,t)},await this.sharedClientState.start()),await this.persistence.fi((async e=>{await async function(e,t){const n=e;if(ou(n),uu(n),!0===t&&!0!==n.La){const e=n.sharedClientState.getAllActiveQueryTargets(),t=await su(n,e.toArray());n.La=!0,await Eo(n.remoteStore,!0);for(const e of t)oo(n.remoteStore,e)}else if(!1===t&&!1!==n.La){const e=[];let t=Promise.resolve();n.Da.forEach(((r,i)=>{n.sharedClientState.isLocalQueryTarget(i)?e.push(i):t=t.then((()=>(eu(n,i),xa(n.localStore,i,!0)))),uo(n.remoteStore,i)})),await t,await su(n,e),function(e){const t=e;t.Fa.forEach(((e,n)=>{uo(t.remoteStore,n)})),t.Ma.mr(),t.Fa=new Map,t.va=new Et(me.comparator)}(n),n.La=!1,await Eo(n.remoteStore,!1)}}(this.Qa.syncEngine,e),this.gcScheduler&&(e&&!this.gcScheduler.started?this.gcScheduler.start():e||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(e&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():e||this.indexBackfillerScheduler.stop())}))}createSharedClientState(e){var t=Wa();if(!Ua.D(t))throw new W(H.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");var n=pa(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new Ua(t,e.asyncQueue,n,e.clientId,e.initialUser)}}class du{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>Yo(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=async function(e,t){const n=e;if(!n.currentUser.isEqual(t)){j("SyncEngine","User change. New user:",t.toKey());const r=await Ia(n.localStore,t);n.currentUser=t,(e=n).Oa.forEach((e=>{e.forEach((e=>{e.reject(new W(H.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))}))})),e.Oa.clear(),n.sharedClientState.handleUserChange(t,r.removedBatchIds,r.addedBatchIds),await iu(n,r.us)}}.bind(null,this.syncEngine),await Eo(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new Ro}createDatastore(e){var t,n,r,i=Ja(e.databaseInfo.databaseId),s=(r=e.databaseInfo,new Ha(r));return t=e.authCredentials,n=e.appCheckCredentials,new no(t,n,r=s,e=i)}createRemoteStore(e){return t=this.localStore,n=this.datastore,r=e.asyncQueue,i=e=>Yo(this.syncEngine,e,0),e=new(ja.D()?ja:qa),new io(t,n,r,i,e);var t,n,r,i}createSyncEngine(e,t){return function(e,t,n,r,i,s,a){const o=new $o(e,t,n,r,i,s);return a&&(o.La=!0),o}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}async terminate(){var e;await async function(e){const t=e;j("RemoteStore","RemoteStore shutting down."),t.M_.add(5),await ao(t),t.O_.shutdown(),t.N_.set("Unknown")}(this.remoteStore),null===(e=this.datastore)||void 0===e||e.terminate()}}function fu(e,t=10240){let n=0;return{async read(){if(n<e.byteLength){var r={value:e.slice(n,n+t),done:!1};return n+=t,r}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.resolve()}}class gu{constructor(e){this.observer=e,this.muted=!1}next(e){this.observer.next&&this.Ka(this.observer.next,e)}error(e){this.observer.error?this.Ka(this.observer.error,e):G("Uncaught Error in snapshot listener:",e.toString())}$a(){this.muted=!0}Ka(e,t){this.muted||setTimeout((()=>{this.muted||e(t)}),0)}}class mu{constructor(e,t){this.Ua=e,this.serializer=t,this.metadata=new Y,this.buffer=new Uint8Array,this.Wa=new TextDecoder("utf-8"),this.Ga().then((e=>{e&&e.sa()?this.metadata.resolve(e.ia.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==e?void 0:e.ia)}`))}),(e=>this.metadata.reject(e)))}close(){return this.Ua.cancel()}async getMetadata(){return this.metadata.promise}async qa(){return await this.getMetadata(),this.Ga()}async Ga(){var e=await this.za();if(null===e)return null;var t=this.Wa.decode(e),n=Number(t);return isNaN(n)&&this.ja(`length string (${t}) is not valid number`),t=await this.Ha(n),new Po(JSON.parse(t),e.length+n)}Ja(){return this.buffer.findIndex((e=>e==="{".charCodeAt(0)))}async za(){for(;this.Ja()<0&&!await this.Ya(););if(0===this.buffer.length)return null;var e=this.Ja();e<0&&this.ja("Reached the end of bundle when a length string is expected.");var t=this.buffer.slice(0,e);return this.buffer=this.buffer.slice(e),t}async Ha(e){for(;this.buffer.length<e;)await this.Ya()&&this.ja("Reached the end of bundle when more is expected.");var t=this.Wa.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t}ja(e){throw this.Ua.cancel(),new Error(`Invalid bundle format: ${e}`)}async Ya(){var e=await this.Ua.read();if(!e.done){const t=new Uint8Array(this.buffer.length+e.value.length);t.set(this.buffer),t.set(e.value,this.buffer.length),this.buffer=t}return e.done}}class pu{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastTransactionError=null,this.writtenDocs=new Set}async lookup(e){if(this.ensureCommitNotCalled(),0<this.mutations.length)throw this.lastTransactionError=new W(H.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes."),this.lastTransactionError;const t=await async function(e,t){const n=e,r={documents:t.map((e=>mi(n.serializer,e)))},i=await n.xo("BatchGetDocuments",n.serializer.databaseId,de.emptyPath(),r,t.length),s=new Map;i.forEach((e=>{const t=(r=n.serializer,"found"in e?function(e,t){Q(!!t.found),t.found.name,t.found.updateTime;var n=pi(e,t.found.name),r=li(t.found.updateTime),i=t.found.createTime?li(t.found.createTime):he.min(),s=new an({mapValue:{fields:t.found.fields}});return on.newFoundDocument(n,r,i,s)}(r,e):"missing"in e?function(e,t){Q(!!t.missing),Q(!!t.readTime);var n=pi(e,t.missing),r=li(t.readTime);return on.newNoDocument(n,r)}(r,e):$());var r;s.set(t.key.toString(),t)}));const a=[];return t.forEach((e=>{var t=s.get(e.toString());Q(!!t),a.push(t)})),a}(this.datastore,e);return t.forEach((e=>this.recordVersion(e))),t}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastTransactionError=e}this.writtenDocs.add(e.toString())}delete(e){this.write(new Or(e,this.precondition(e))),this.writtenDocs.add(e.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastTransactionError)throw this.lastTransactionError;const e=this.readVersions;this.mutations.forEach((t=>{e.delete(t.key.toString())})),e.forEach(((e,t)=>{var n=me.fromPath(t);this.mutations.push(new Fr(n,this.precondition(n)))})),await async function(e,t){const n=e,r={writes:t.map((e=>Ei(n.serializer,e)))};await n.Co("Commit",n.serializer.databaseId,de.emptyPath(),r)}(this.datastore,this.mutations),this.committed=!0}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw $();t=he.min()}var n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new W(H.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){const t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?t.isEqual(he.min())?Er.exists(!1):Er.updateTime(t):Er.none()}preconditionForUpdate(e){const t=this.readVersions.get(e.toString());if(this.writtenDocs.has(e.toString())||!t)return Er.exists(!0);if(t.isEqual(he.min()))throw new W(H.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return Er.updateTime(t)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}class yu{constructor(e,t,n,r,i){this.asyncQueue=e,this.datastore=t,this.options=n,this.updateFunction=r,this.deferred=i,this.Za=n.maxAttempts,this.Yo=new Xa(this.asyncQueue,"transaction_retry")}Xa(){--this.Za,this.eu()}eu(){this.Yo.$o((async()=>{const e=new pu(this.datastore),t=this.tu(e);t&&t.then((t=>{this.asyncQueue.enqueueAndForget((()=>e.commit().then((()=>{this.deferred.resolve(t)})).catch((e=>{this.nu(e)}))))})).catch((e=>{this.nu(e)}))}))}tu(e){try{var t=this.updateFunction(e);return!je(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}nu(e){0<this.Za&&this.ru(e)?(--this.Za,this.asyncQueue.enqueueAndForget((()=>(this.eu(),Promise.resolve())))):this.deferred.reject(e)}ru(e){if("FirebaseError"!==e.name)return!1;var t=e.code;return"aborted"===t||"failed-precondition"===t||"already-exists"===t||!qr(t)}}class vu{constructor(e,t,n,r){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=r,this.user=V.UNAUTHENTICATED,this.clientId=se.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,(async e=>{j("FirestoreClient","Received user=",e.uid),await this.authCredentialListener(e),this.user=e})),this.appCheckCredentials.start(n,(e=>(j("FirestoreClient","Received new app check token=",e),this.appCheckCredentialListener(e,this.user))))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new W(H.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const e=new Y;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(n){var t=Do(n,"Failed to shutdown persistence");e.reject(t)}})),e.promise}}async function wu(e,t){e.asyncQueue.verifyOperationInProgress(),j("FirestoreClient","Initializing OfflineComponentProvider");var n=e.configuration;await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener((async e=>{r.isEqual(e)||(await Ia(t.localStore,e),r=e)})),t.persistence.setDatabaseDeletedListener((()=>e.terminate())),e._offlineComponents=t}async function _u(e,t){e.asyncQueue.verifyOperationInProgress();var n=await Iu(e);j("FirestoreClient","Initializing OnlineComponentProvider"),await t.initialize(n,e.configuration),e.setCredentialChangeListener((e=>Io(t.remoteStore,e))),e.setAppCheckTokenChangeListener(((e,n)=>Io(t.remoteStore,n))),e._onlineComponents=t}function bu(e){return"FirebaseError"===e.name?e.code===H.FAILED_PRECONDITION||e.code===H.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&e instanceof DOMException)||22===e.code||20===e.code||11===e.code}async function Iu(e){if(!e._offlineComponents)if(e._uninitializedComponentsProvider){j("FirestoreClient","Using user provided OfflineComponentProvider");try{await wu(e,e._uninitializedComponentsProvider._offline)}catch(n){var t=n;if(!bu(t))throw t;z("Error using user provided cache. Falling back to memory cache: "+t),await wu(e,new cu)}}else j("FirestoreClient","Using default OfflineComponentProvider"),await wu(e,new cu);return e._offlineComponents}async function Eu(e){return e._onlineComponents||(e._uninitializedComponentsProvider?(j("FirestoreClient","Using user provided OnlineComponentProvider"),await _u(e,e._uninitializedComponentsProvider._online)):(j("FirestoreClient","Using default OnlineComponentProvider"),await _u(e,new du))),e._onlineComponents}function Tu(e){return Iu(e).then((e=>e.persistence))}function Su(e){return Iu(e).then((e=>e.localStore))}function xu(e){return Eu(e).then((e=>e.remoteStore))}function Du(e){return Eu(e).then((e=>e.syncEngine))}async function Cu(e){const t=await Eu(e),n=t.eventManager;return n.onListen=async function(e,t,n=!0){const r=ou(e);let i;const s=r.ba.get(t);return i=s?(r.sharedClientState.addLocalQueryTarget(s.targetId),s.view.ya()):await Qo(r,t,n,!0),i}.bind(null,t.syncEngine),n.onUnlisten=async function(e,t,n){const r=e,i=r.ba.get(t),s=r.Da.get(i.targetId);if(1<s.length)return r.Da.set(i.targetId,s.filter((e=>!$n(e,t)))),void r.ba.delete(t);r.isPrimaryClient?(r.sharedClientState.removeLocalQueryTarget(i.targetId),r.sharedClientState.isActiveQueryTarget(i.targetId)||await xa(r.localStore,i.targetId,!1).then((()=>{r.sharedClientState.clearQueryState(i.targetId),n&&uo(r.remoteStore,i.targetId),eu(r,i.targetId)})).catch(De)):(eu(r,i.targetId),await xa(r.localStore,i.targetId,!0))}.bind(null,t.syncEngine),n.onFirstRemoteStoreListen=async function(e,t){await Qo(ou(e),t,!0,!1)}.bind(null,t.syncEngine),n.onLastRemoteStoreUnlisten=async function(e,t){const n=e,r=n.ba.get(t),i=n.Da.get(r.targetId);n.isPrimaryClient&&1===i.length&&(n.sharedClientState.removeLocalQueryTarget(r.targetId),uo(n.remoteStore,r.targetId))}.bind(null,t.syncEngine),n}function Au(e,t,n={}){const r=new Y;return e.asyncQueue.enqueueAndForget((async()=>function(e,t,n,r,i){const s=new gu({next:s=>{t.enqueueAndForget((()=>Lo(e,a)));var o=s.docs.has(n);!o&&s.fromCache?i.reject(new W(H.UNAVAILABLE,"Failed to get document because the client is offline.")):o&&s.fromCache&&r&&"server"===r.source?i.reject(new W(H.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):i.resolve(s)},error:e=>i.reject(e)}),a=new Fo(Un(n.path),s,{includeMetadataChanges:!0,ra:!0});return Mo(e,a)}(await Cu(e),e.asyncQueue,t,n,r))),r.promise}function Nu(e,t,n={}){const r=new Y;return e.asyncQueue.enqueueAndForget((async()=>function(e,t,n,r,i){const s=new gu({next:n=>{t.enqueueAndForget((()=>Lo(e,a))),n.fromCache&&"server"===r.source?i.reject(new W(H.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):i.resolve(n)},error:e=>i.reject(e)}),a=new Fo(n,s,{includeMetadataChanges:!0,ra:!0});return Mo(e,a)}(await Cu(e),e.asyncQueue,t,n,r))),r.promise}function ku(e){const t={};return void 0!==e.timeoutSeconds&&(t.timeoutSeconds=e.timeoutSeconds),t}const Ru=new Map;function Mu(e,t,n){if(!n)throw new W(H.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function Lu(e,t,n,r){if(!0===t&&!0===r)throw new W(H.INVALID_ARGUMENT,`${e} and ${n} cannot be used together.`)}function Ou(e){if(!me.isDocumentKey(e))throw new W(H.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function Fu(e){if(me.isDocumentKey(e))throw new W(H.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function Pu(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return 20<e.length&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"!=typeof e)return"function"==typeof e?"a function":$();if(e instanceof Array)return"an array";var t=e.constructor?e.constructor.name:null;return t?`a custom ${t} object`:"an object"}function Vu(e,t){if((e="_delegate"in e?e._delegate:e)instanceof t)return e;if(t.name===e.constructor.name)throw new W(H.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");var n=Pu(e);throw new W(H.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${n}`)}function Uu(e,t){if(t<=0)throw new W(H.INVALID_ARGUMENT,`Function ${e}() requires a positive number, but it was: ${t}.`)}class Bu{constructor(e){var t;if(void 0===e.host){if(void 0!==e.ssl)throw new W(H.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=null===(t=e.ssl)||void 0===t||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.localCache=e.localCache,void 0===e.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new W(H.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}Lu("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:void 0===e.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=ku(null!==(t=e.experimentalLongPollingOptions)&&void 0!==t?t:{}),function(e){if(void 0!==e.timeoutSeconds){if(isNaN(e.timeoutSeconds))throw new W(H.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (must not be NaN)`);if(e.timeoutSeconds<5)throw new W(H.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (minimum allowed value is 5)`);if(30<e.timeoutSeconds)throw new W(H.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&(t=this.experimentalLongPollingOptions,n=e.experimentalLongPollingOptions,t.timeoutSeconds===n.timeoutSeconds)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams;var t,n}}class qu{constructor(e,t,n,r){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new Bu({}),this._settingsFrozen=!1}get app(){if(!this._app)throw new W(H.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new W(H.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new Bu(e),void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new X;switch(e.type){case"firstParty":return new ne(e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new W(H.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){const t=Ru.get(e);t&&(j("ComponentProvider","Removing Datastore"),Ru.delete(e),t.terminate())}(this),Promise.resolve()}}class ju{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new ju(this.firestore,e,this._query)}}class Gu{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new zu(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new Gu(this.firestore,e,this._key)}}class zu extends ju{constructor(e,t,n){super(e,t,Un(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new Gu(this.firestore,null,new me(e))}withConverter(e){return new zu(this.firestore,e,this._path)}}function Ku(e,t,...n){if(e=p(e),Mu("collection","path",t),e instanceof qu){var r=de.fromString(t,...n);return Fu(r),new zu(e,null,r)}if(!(e instanceof Gu||e instanceof zu))throw new W(H.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");return Fu(r=e._path.child(de.fromString(t,...n))),new zu(e.firestore,null,r)}function $u(e,t,...n){if(e=p(e),Mu("doc","path",t=1===arguments.length?se.newId():t),e instanceof qu){var r=de.fromString(t,...n);return Ou(r),new Gu(e,null,new me(r))}if(!(e instanceof Gu||e instanceof zu))throw new W(H.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");return Ou(r=e._path.child(de.fromString(t,...n))),new Gu(e.firestore,e instanceof zu?e.converter:null,new me(r))}function Qu(e,t){return e=p(e),t=p(t),(e instanceof Gu||e instanceof zu)&&(t instanceof Gu||t instanceof zu)&&e.firestore===t.firestore&&e.path===t.path&&e.converter===t.converter}function Hu(e,t){return e=p(e),t=p(t),e instanceof ju&&t instanceof ju&&e.firestore===t.firestore&&$n(e._query,t._query)&&e.converter===t.converter}class Wu{constructor(){this.iu=Promise.resolve(),this.su=[],this.ou=!1,this._u=[],this.au=null,this.uu=!1,this.cu=!1,this.lu=[],this.Yo=new Xa(this,"async_queue_retry"),this.hu=()=>{var e=Ya();e&&j("AsyncQueue","Visibility state changed to "+e.visibilityState),this.Yo.Wo()};const e=Ya();e&&"function"==typeof e.addEventListener&&e.addEventListener("visibilitychange",this.hu)}get isShuttingDown(){return this.ou}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.Pu(),this.Iu(e)}enterRestrictedMode(e){if(!this.ou){this.ou=!0,this.cu=e||!1;const t=Ya();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.hu)}}enqueue(e){if(this.Pu(),this.ou)return new Promise((()=>{}));const t=new Y;return this.Iu((()=>this.ou&&this.cu?Promise.resolve():(e().then(t.resolve,t.reject),t.promise))).then((()=>t.promise))}enqueueRetryable(e){this.enqueueAndForget((()=>(this.su.push(e),this.Tu())))}async Tu(){if(0!==this.su.length){try{await this.su[0](),this.su.shift(),this.Yo.reset()}catch(e){if(!Le(e))throw e;j("AsyncQueue","Operation failed with retryable error: "+e)}0<this.su.length&&this.Yo.$o((()=>this.Tu()))}}Iu(e){var t=this.iu.then((()=>(this.uu=!0,e().catch((e=>{throw this.au=e,this.uu=!1,G("INTERNAL UNHANDLED ERROR: ",function(e){let t=e.message||"";return e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t}(e)),e})).then((e=>(this.uu=!1,e))))));return this.iu=t}enqueueAfterDelay(e,t,n){this.Pu(),-1<this.lu.indexOf(e)&&(t=0);var r=xo.createAndSchedule(this,e,t,n,(e=>this.Eu(e)));return this._u.push(r),r}Pu(){this.au&&$()}verifyOperationInProgress(){}async du(){for(var e;await(e=this.iu),e!==this.iu;);}Au(e){for(const t of this._u)if(t.timerId===e)return!0;return!1}Ru(e){return this.du().then((()=>{this._u.sort(((e,t)=>e.targetTimeMs-t.targetTimeMs));for(const t of this._u)if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.du()}))}Vu(e){this.lu.push(e)}Eu(e){var t=this._u.indexOf(e);this._u.splice(t,1)}}function Yu(e){return function(e,t){if("object"==typeof e&&null!==e){var n=e;for(const e of["next","error","complete"])if(e in n&&"function"==typeof n[e])return 1}}(e)}class Ju{constructor(){this._progressObserver={},this._taskCompletionResolver=new Y,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,n){this._progressObserver={next:e,error:t,complete:n}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}var Xu,Zu,ec;class tc extends qu{constructor(e,t,n,r){super(e,t,n,r),this.type="firestore",this._queue=new Wu,this._persistenceKey=(null==r?void 0:r.name)||"[DEFAULT]"}_terminate(){return this._firestoreClient||rc(this),this._firestoreClient.terminate()}}function nc(e){return e._firestoreClient||rc(e),e._firestoreClient.verifyNotTerminated(),e._firestoreClient}function rc(e){var t,n,r,i,s,a=e._freezeSettings(),o=(n=e._databaseId,r=(null===(o=e._app)||void 0===o?void 0:o.options.appId)||"",i=e._persistenceKey,new Ut(n,r,i,(s=a).host,s.ssl,s.experimentalForceLongPolling,s.experimentalAutoDetectLongPolling,ku(s.experimentalLongPollingOptions),s.useFetchStreams));e._firestoreClient=new vu(e._authCredentials,e._appCheckCredentials,e._queue,o),null!==(o=a.localCache)&&void 0!==o&&o._offlineComponentProvider&&null!==(t=a.localCache)&&void 0!==t&&t._onlineComponentProvider&&(e._firestoreClient._uninitializedComponentsProvider={_offlineKind:a.localCache.kind,_offline:a.localCache._offlineComponentProvider,_online:a.localCache._onlineComponentProvider})}function ic(e,t,n){const r=new Y;return e.asyncQueue.enqueue((async()=>{try{await wu(e,n),await _u(e,t),r.resolve()}catch(e){const t=e;if(!bu(t))throw t;z("Error enabling indexeddb cache. Falling back to memory cache: "+t),r.reject(t)}})).then((()=>r.promise))}function sc(e){if(e._initialized||e._terminated)throw new W(H.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class ac{constructor(e){this._byteString=e}static fromBase64String(e){try{return new ac(kt.fromBase64String(e))}catch(e){throw new W(H.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new ac(kt.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class oc{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new W(H.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new ge(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class uc{constructor(e){this._methodName=e}}class cc{constructor(e,t){if(!isFinite(e)||e<-90||90<e)throw new W(H.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||180<t)throw new W(H.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return ae(this._lat,e._lat)||ae(this._long,e._long)}}const hc=/^__.*__$/;class lc{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new kr(e,this.data,this.fieldMask,t,this.fieldTransforms):new Nr(e,this.data,t,this.fieldTransforms)}}class dc{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new kr(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function fc(e){switch(e){case 0:case 2:case 1:return 1;case 3:case 4:return;default:throw $()}}class gc{constructor(e,t,n,r,i,s){this.settings=e,this.databaseId=t,this.serializer=n,this.ignoreUndefinedProperties=r,void 0===i&&this.mu(),this.fieldTransforms=i||[],this.fieldMask=s||[]}get path(){return this.settings.path}get fu(){return this.settings.fu}gu(e){return new gc(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}pu(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.gu({path:n,yu:!1});return r.wu(e),r}Su(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.gu({path:n,yu:!1});return r.mu(),r}bu(e){return this.gu({path:void 0,yu:!0})}Du(e){return Lc(e,this.settings.methodName,this.settings.Cu||!1,this.path,this.settings.vu)}contains(e){return void 0!==this.fieldMask.find((t=>e.isPrefixOf(t)))||void 0!==this.fieldTransforms.find((t=>e.isPrefixOf(t.field)))}mu(){if(this.path)for(let e=0;e<this.path.length;e++)this.wu(this.path.get(e))}wu(e){if(0===e.length)throw this.Du("Document fields must not be empty");if(fc(this.fu)&&hc.test(e))throw this.Du('Document fields cannot begin and end with "__"')}}class mc{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=n||Ja(e)}Fu(e,t,n,r=!1){return new gc({fu:e,methodName:t,vu:n,path:ge.emptyPath(),yu:!1,Cu:r},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function pc(e){var t=e._freezeSettings(),n=Ja(e._databaseId);return new mc(e._databaseId,!!t.ignoreUndefinedProperties,n)}function yc(e,t,n,r,i,s={}){const a=e.Fu(s.merge||s.mergeFields?2:0,t,n,i);Nc("Data must be an object, but it was:",a,r);var o=Cc(r,a);let u,c;if(s.merge)u=new At(a.fieldMask),c=a.fieldTransforms;else if(s.mergeFields){const e=[];for(const r of s.mergeFields){const i=kc(t,r,n);if(!a.contains(i))throw new W(H.INVALID_ARGUMENT,`Field '${i}' is specified in your field mask but missing from your input data.`);Oc(e,i)||e.push(i)}u=new At(e),c=a.fieldTransforms.filter((e=>u.covers(e.field)))}else u=null,c=a.fieldTransforms;return new lc(new an(o),u,c)}class vc extends uc{_toFieldTransform(e){if(2!==e.fu)throw 1===e.fu?e.Du(`${this._methodName}() can only appear at the top level of your update data`):e.Du(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof vc}}function wc(e,t,n){return new gc({fu:3,vu:t.settings.vu,methodName:e._methodName,yu:n},t.databaseId,t.serializer,t.ignoreUndefinedProperties)}class _c extends uc{_toFieldTransform(e){return new br(e.path,new fr)}isEqual(e){return e instanceof _c}}class bc extends uc{constructor(e,t){super(e),this.Mu=t}_toFieldTransform(e){const t=wc(this,e,!0),n=this.Mu.map((e=>Dc(e,t))),r=new gr(n);return new br(e.path,r)}isEqual(e){return e instanceof bc&&g(this.Mu,e.Mu)}}class Ic extends uc{constructor(e,t){super(e),this.Mu=t}_toFieldTransform(e){const t=wc(this,e,!0),n=this.Mu.map((e=>Dc(e,t))),r=new pr(n);return new br(e.path,r)}isEqual(e){return e instanceof Ic&&g(this.Mu,e.Mu)}}class Ec extends uc{constructor(e,t){super(e),this.xu=t}_toFieldTransform(e){var t=new vr(e.serializer,hr(e.serializer,this.xu));return new br(e.path,t)}isEqual(e){return e instanceof Ec&&this.xu===e.xu}}function Tc(e,t,n,r){const i=e.Fu(1,t,n);Nc("Data must be an object, but it was:",i,r);const s=[],a=an.empty();bt(r,((e,r)=>{var o=Mc(t,e,n);r=p(r);var u=i.Su(o);if(r instanceof vc)s.push(o);else{const e=Dc(r,u);null!=e&&(s.push(o),a.set(o,e))}}));var o=new At(s);return new dc(a,o,i.fieldTransforms)}function Sc(e,t,n,r,i,s){const a=e.Fu(1,t,n),o=[kc(t,r,n)],u=[i];if(s.length%2!=0)throw new W(H.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let e=0;e<s.length;e+=2)o.push(kc(t,s[e])),u.push(s[e+1]);const c=[],h=an.empty();for(let e=o.length-1;0<=e;--e)if(!Oc(c,o[e])){const t=o[e];var l=p(l=u[e]);const n=a.Su(t);if(l instanceof vc)c.push(t);else{const e=Dc(l,n);null!=e&&(c.push(t),h.set(t,e))}}var d=new At(c);return new dc(h,d,a.fieldTransforms)}function xc(e,t,n,r=!1){return Dc(n,e.Fu(r?4:3,t))}function Dc(e,t){if(Ac(e=p(e)))return Nc("Unsupported field value:",t,e),Cc(e,t);if(e instanceof uc)return function(e,t){if(!fc(t.fu))throw t.Du(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t.Du(`${e._methodName}() is not currently supported inside arrays`);var n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(e,t),null;if(void 0===e&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.yu&&4!==t.fu)throw t.Du("Nested arrays are not supported");return function(e,t){const n=[];let r=0;for(const i of e){let e=Dc(i,t.bu(r));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),r++}return{arrayValue:{values:n}}}(e,t)}return function(e,t){if(null===(e=p(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return hr(t.serializer,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){var n=ce.fromDate(e);return{timestampValue:ci(t.serializer,n)}}if(e instanceof ce)return n=new ce(e.seconds,1e3*Math.floor(e.nanoseconds/1e3)),{timestampValue:ci(t.serializer,n)};if(e instanceof cc)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof ac)return{bytesValue:hi(t.serializer,e._byteString)};if(e instanceof Gu){const n=t.databaseId,r=e.firestore._databaseId;if(!r.isEqual(n))throw t.Du(`Document reference is for database ${r.projectId}/${r.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:di(e.firestore._databaseId||t.databaseId,e._key.path)}}throw t.Du(`Unsupported field value: ${Pu(e)}`)}(e,t)}function Cc(e,t){const n={};return It(e)?t.path&&0<t.path.length&&t.fieldMask.push(t.path):bt(e,((e,r)=>{var i=Dc(r,t.pu(e));null!=i&&(n[e]=i)})),{mapValue:{fields:n}}}function Ac(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof ce||e instanceof cc||e instanceof ac||e instanceof Gu||e instanceof uc)}function Nc(e,t,n){if(!Ac(n)||"object"!=typeof(i=n)||null===i||Object.getPrototypeOf(i)!==Object.prototype&&null!==Object.getPrototypeOf(i)){var r=Pu(n);throw"an object"===r?t.Du(e+" a custom object"):t.Du(e+" "+r)}var i}function kc(e,t,n){if((t=p(t))instanceof oc)return t._internalPath;if("string"==typeof t)return Mc(e,t);throw Lc("Field path arguments must be of type string or ",e,!1,void 0,n)}const Rc=new RegExp("[~\\*/\\[\\]]");function Mc(e,t,n){if(0<=t.search(Rc))throw Lc(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,e,!1,void 0,n);try{return new oc(...t.split("."))._internalPath}catch(r){throw Lc(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,e,!1,void 0,n)}}function Lc(e,t,n,r,i){var s=r&&!r.isEmpty(),a=void 0!==i;let o=`Function ${t}() called with invalid data`;n&&(o+=" (via `toFirestore()`)"),o+=". ";let u="";return(s||a)&&(u+=" (found",s&&(u+=` in field ${r}`),a&&(u+=` in document ${i}`),u+=")"),new W(H.INVALID_ARGUMENT,o+e+u)}function Oc(e,t){return e.some((e=>e.isEqual(t)))}class Fc{constructor(e,t,n,r,i){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=i}get id(){return this._key.path.lastSegment()}get ref(){return new Gu(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){var e=new Pc(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){var t=this._document.data.field(Vc("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class Pc extends Fc{data(){return super.data()}}function Vc(e,t){return"string"==typeof t?Mc(e,t):(t instanceof oc?t:t._delegate)._internalPath}function Uc(e){if("L"===e.limitType&&0===e.explicitOrderBy.length)throw new W(H.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class Bc{}class qc extends Bc{}function jc(e,t,...n){let r=[];t instanceof Bc&&r.push(t),r=r.concat(n),function(e){var t=e.filter((e=>e instanceof zc)).length,n=e.filter((e=>e instanceof Gc)).length;if(1<t||0<t&&0<n)throw new W(H.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(r);for(const t of r)e=t._apply(e);return e}class Gc extends qc{constructor(e,t,n){super(),this._field=e,this._op=t,this._value=n,this.type="where"}static _create(e,t,n){return new Gc(e,t,n)}_apply(e){var t=this._parse(e);return Xc(e._query,t),new ju(e.firestore,e.converter,zn(e._query,t))}_parse(e){var t=pc(e.firestore);return function(e,t,n,r,i,s,a){let o;if(i.isKeyField()){if("array-contains"===s||"array-contains-any"===s)throw new W(H.INVALID_ARGUMENT,`Invalid Query. You can't perform '${s}' queries on documentId().`);if("in"===s||"not-in"===s){Jc(a,s);const t=[];for(const n of a)t.push(Yc(r,e,n));o={arrayValue:{values:t}}}else o=Yc(r,e,a)}else"in"!==s&&"not-in"!==s&&"array-contains-any"!==s||Jc(a,s),o=xc(n,"where",a,"in"===s||"not-in"===s);return fn.create(i,s,o)}(e._query,0,t,e.firestore._databaseId,this._field,this._op,this._value)}}class zc extends Bc{constructor(e,t){super(),this.type=e,this._queryConstraints=t}static _create(e,t){return new zc(e,t)}_parse(e){var t=this._queryConstraints.map((t=>t._parse(e))).filter((e=>0<e.getFilters().length));return 1===t.length?t[0]:gn.create(t,this._getOperator())}_apply(e){const t=this._parse(e);return 0===t.getFilters().length?e:(function(e,t){let n=e;for(const e of t.getFlattenedFilters())Xc(n,e),n=zn(n,e)}(e._query,t),new ju(e.firestore,e.converter,zn(e._query,t)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}class Kc extends qc{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new Kc(e,t)}_apply(e){var t=function(e,t,n){if(null!==e.startAt)throw new W(H.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new W(H.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new ln(t,n)}(e._query,this._field,this._direction);return new ju(e.firestore,e.converter,(t=(e=e._query).explicitOrderBy.concat([t]),new Pn(e.path,e.collectionGroup,t,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)))}}class $c extends qc{constructor(e,t,n){super(),this.type=e,this._limit=t,this._limitType=n}static _create(e,t,n){return new $c(e,t,n)}_apply(e){return new ju(e.firestore,e.converter,Kn(e._query,this._limit,this._limitType))}}class Qc extends qc{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new Qc(e,t,n)}_apply(e){var t,n=Wc(e,this.type,this._docOrFields,this._inclusive);return new ju(e.firestore,e.converter,(t=e._query,e=n,new Pn(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,e,t.endAt)))}}class Hc extends qc{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new Hc(e,t,n)}_apply(e){var t,n=Wc(e,this.type,this._docOrFields,this._inclusive);return new ju(e.firestore,e.converter,(t=e._query,e=n,new Pn(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,e)))}}function Wc(e,t,n,r){if(n[0]=p(n[0]),n[0]instanceof Fc)return function(e,t,n,r,i){if(!r)throw new W(H.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const s=[];for(const n of jn(e))if(n.field.isKeyField())s.push(Wt(t,r.key));else{const e=r.data.field(n.field);if(Ft(e))throw new W(H.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===e){const e=n.field.canonicalString();throw new W(H.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${e}' (used as the orderBy) does not exist.`)}s.push(e)}return new un(s,i)}(e._query,e.firestore._databaseId,t,n[0]._document,r);var i=pc(e.firestore);return function(e,t,n,r,i,s){const a=e.explicitOrderBy;if(i.length>a.length)throw new W(H.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const o=[];for(let s=0;s<i.length;s++){const u=i[s];if(a[s].field.isKeyField()){if("string"!=typeof u)throw new W(H.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof u}`);if(!qn(e)&&-1!==u.indexOf("/"))throw new W(H.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${r}() must be a plain document ID, but '${u}' contains a slash.`);const n=e.path.child(de.fromString(u));if(!me.isDocumentKey(n))throw new W(H.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const i=new me(n);o.push(Wt(t,i))}else{const e=xc(n,r,u);o.push(e)}}return new un(o,s)}(e._query,e.firestore._databaseId,i,t,n,r)}function Yc(e,t,n){if("string"==typeof(n=p(n))){if(""===n)throw new W(H.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!qn(t)&&-1!==n.indexOf("/"))throw new W(H.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);var r=t.path.child(de.fromString(n));if(!me.isDocumentKey(r))throw new W(H.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return Wt(e,new me(r))}if(n instanceof Gu)return Wt(e,n._key);throw new W(H.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${Pu(n)}.`)}function Jc(e,t){if(!Array.isArray(e)||0===e.length)throw new W(H.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function Xc(e,t){const n=function(e,t){for(const n of e)for(const e of n.getFlattenedFilters())if(0<=t.indexOf(e.op))return e.op;return null}(e.filters,function(e){switch(e){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(null!==n)throw n===t.op?new W(H.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new W(H.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${n.toString()}' filters.`)}class Zc{convertValue(e,t="none"){switch(Gt(e)){case 0:return null;case 1:return e.booleanValue;case 2:return Lt(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(Ot(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 10:return this.convertObject(e.mapValue,t);default:throw $()}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,t="none"){const n={};return bt(e,((e,r)=>{n[e]=this.convertValue(r,t)})),n}convertGeoPoint(e){return new cc(Lt(e.latitude),Lt(e.longitude))}convertArray(e,t){return(e.values||[]).map((e=>this.convertValue(e,t)))}convertServerTimestamp(e,t){switch(t){case"previous":var n=Pt(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(Vt(e));default:return null}}convertTimestamp(e){var t=Mt(e);return new ce(t.seconds,t.nanos)}convertDocumentKey(e,t){const n=de.fromString(e);Q(Ri(n));const r=new Bt(n.get(1),n.get(3)),i=new me(n.popFirst(5));return r.isEqual(t)||G(`Document ${i} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),i}}function eh(e,t,n){return e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t}class th extends Zc{constructor(e){super(),this.firestore=e}convertBytes(e){return new ac(e)}convertReference(e){var t=this.convertDocumentKey(e,this.firestore._databaseId);return new Gu(this.firestore,null,t)}}class nh{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class rh extends Fc{constructor(e,t,n,r,i,s){super(e,t,n,r,s),this._firestore=e,this._firestoreImpl=e,this.metadata=i}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){var t=new ih(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){var n=this._document.data.field(Vc("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}}class ih extends rh{data(e={}){return super.data(e)}}class sh{constructor(e,t,n,r){this._firestore=e,this._userDataWriter=t,this._snapshot=r,this.metadata=new nh(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const e=[];return this.forEach((t=>e.push(t))),e}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(e,t){this._snapshot.docs.forEach((n=>{e.call(t,new ih(this._firestore,this._userDataWriter,n.key,n,new nh(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))}))}docChanges(e={}){var t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new W(H.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(e,t){if(e._snapshot.oldDocs.isEmpty()){let t=0;return e._snapshot.docChanges.map((n=>{var r=new ih(e._firestore,e._userDataWriter,n.doc.key,n.doc,new nh(e._snapshot.mutatedKeys.has(n.doc.key),e._snapshot.fromCache),e.query.converter);return n.doc,{type:"added",doc:r,oldIndex:-1,newIndex:t++}}))}{let n=e._snapshot.oldDocs;return e._snapshot.docChanges.filter((e=>t||3!==e.type)).map((t=>{var r=new ih(e._firestore,e._userDataWriter,t.doc.key,t.doc,new nh(e._snapshot.mutatedKeys.has(t.doc.key),e._snapshot.fromCache),e.query.converter);let i=-1,s=-1;return 0!==t.type&&(i=n.indexOf(t.doc.key),n=n.delete(t.doc.key)),1!==t.type&&(n=n.add(t.doc),s=n.indexOf(t.doc.key)),{type:function(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return $()}}(t.type),doc:r,oldIndex:i,newIndex:s}}))}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}function ah(e,t){return e instanceof rh&&t instanceof rh?e._firestore===t._firestore&&e._key.isEqual(t._key)&&(null===e._document?null===t._document:e._document.isEqual(t._document))&&e._converter===t._converter:e instanceof sh&&t instanceof sh&&e._firestore===t._firestore&&Hu(e.query,t.query)&&e.metadata.isEqual(t.metadata)&&e._snapshot.isEqual(t._snapshot)}class oh extends Zc{constructor(e){super(),this.firestore=e}convertBytes(e){return new ac(e)}convertReference(e){var t=this.convertDocumentKey(e,this.firestore._databaseId);return new Gu(this.firestore,null,t)}}function uh(e){e=Vu(e,Gu);const t=Vu(e.firestore,tc),n=nc(t),r=new oh(t);return function(e,t){const n=new Y;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){try{const r=await function(e,t){const n=e;return n.persistence.runTransaction("read document","readonly",(e=>n.localDocuments.getDocument(e,t)))}(e,t);r.isFoundDocument()?n.resolve(r):r.isNoDocument()?n.resolve(null):n.reject(new W(H.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(e){var r=Do(e,`Failed to get document '${t} from cache`);n.reject(r)}}(await Su(e),t,n))),n.promise}(n,e._key).then((n=>new rh(t,r,e._key,n,new nh(null!==n&&n.hasLocalMutations,!0),e.converter)))}function ch(e){e=Vu(e,ju);const t=Vu(e.firestore,tc),n=nc(t),r=new oh(t);return function(e,t){const n=new Y;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){try{const r=await Da(e,t,!0),i=new Go(t,r.hs),s=i.da(r.documents),a=i.applyChanges(s,!1);n.resolve(a.snapshot)}catch(e){var r=Do(e,`Failed to execute query '${t} against cache`);n.reject(r)}}(await Su(e),t,n))),n.promise}(n,e._query).then((n=>new sh(t,r,e,n)))}function hh(e,t,n){e=Vu(e,Gu);var r=Vu(e.firestore,tc),i=eh(e.converter,t,n);return fh(r,[yc(pc(r),"setDoc",e._key,i,null!==e.converter,n).toMutation(e._key,Er.none())])}function lh(e,t,n,...r){e=Vu(e,Gu);var i=Vu(e.firestore,tc),s=pc(i);let a;return a="string"==typeof(t=p(t))||t instanceof oc?Sc(s,"updateDoc",e._key,t,n,r):Tc(s,"updateDoc",e._key,t),fh(i,[a.toMutation(e._key,Er.exists(!0))])}function dh(e,...t){var n;e=p(e);let r={includeMetadataChanges:!1,source:"default"},i=0;"object"!=typeof t[i]||Yu(t[i])||(r=t[i],i++);var s={includeMetadataChanges:r.includeMetadataChanges,source:r.source};if(Yu(t[i])){const e=t[i];t[i]=null===(n=e.next)||void 0===n?void 0:n.bind(e),t[i+1]=null===(n=e.error)||void 0===n?void 0:n.bind(e),t[i+2]=null===(n=e.complete)||void 0===n?void 0:n.bind(e)}let a,o,u;if(e instanceof Gu)o=Vu(e.firestore,tc),u=Un(e._key.path),a={next:n=>{t[i]&&t[i](gh(o,e,n))},error:t[i+1],complete:t[i+2]};else{const n=Vu(e,ju);o=Vu(n.firestore,tc),u=n._query;const r=new oh(o);a={next:e=>{t[i]&&t[i](new sh(o,r,n,e))},error:t[i+1],complete:t[i+2]},Uc(e._query)}return function(e,t,n,r){const i=new gu(r),s=new Fo(t,i,n);return e.asyncQueue.enqueueAndForget((async()=>Mo(await Cu(e),s))),()=>{i.$a(),e.asyncQueue.enqueueAndForget((async()=>Lo(await Cu(e),s)))}}(nc(o),u,s,a)}function fh(e,t){return function(e,t){const n=new Y;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){const r=uu(e);try{const e=await function(e,t){const n=e,r=ce.now(),i=t.reduce(((e,t)=>e.add(t.key)),ar());let s,a;return n.persistence.runTransaction("Locally write mutations","readwrite",(e=>{let o=Zn,u=ar();return n.os.getEntries(e,i).next((e=>{o=e,o.forEach(((e,t)=>{t.isValidDocument()||(u=u.add(e))}))})).next((()=>n.localDocuments.getOverlayedDocuments(e,o))).next((i=>{s=i;const a=[];for(const e of t){const t=function(e,t){let n=null;for(const r of e.fieldTransforms){const e=t.data.field(r.field),i=dr(r.transform,e||null);null!=i&&(null===n&&(n=an.empty()),n.set(r.field,i))}return n||null}(e,s.get(e.key).overlayedDocument);null!=t&&a.push(new kr(e.key,t,function e(t){const n=[];return bt(t.fields,((t,r)=>{const i=new ge([t]);if(en(r)){const t=e(r.mapValue).fields;if(0===t.length)n.push(i);else for(const e of t)n.push(i.child(e))}else n.push(i)})),new At(n)}(t.value.mapValue),Er.exists(!0)))}return n.mutationQueue.addMutationBatch(e,r,a,t)})).next((t=>{var r=(a=t).applyToLocalDocumentSet(s,u);return n.documentOverlayCache.saveOverlays(e,t.batchId,r)}))})).then((()=>({batchId:a.batchId,changes:nr(s)})))}(r.localStore,t);r.sharedClientState.addPendingMutation(e.batchId),function(e,t,n){let r=e.xa[e.currentUser.toKey()];r=r||new Et(ae),r=r.insert(t,n),e.xa[e.currentUser.toKey()]=r}(r,e.batchId,n),await iu(r,e.changes),await vo(r.remoteStore)}catch(e){const t=Do(e,"Failed to persist write");n.reject(t)}}(await Du(e),t,n))),n.promise}(nc(e),t)}function gh(e,t,n){var r=n.docs.get(t._key),i=new oh(e);return new rh(e,i,t._key,r,new nh(n.hasPendingWrites,n.fromCache),t.converter)}const mh={maxAttempts:5};class ph{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=pc(e)}set(e,t,n){this._verifyNotCommitted();const r=yh(e,this._firestore),i=eh(r.converter,t,n),s=yc(this._dataReader,"WriteBatch.set",r._key,i,null!==r.converter,n);return this._mutations.push(s.toMutation(r._key,Er.none())),this}update(e,t,n,...r){this._verifyNotCommitted();var i=yh(e,this._firestore);let s;return s="string"==typeof(t=p(t))||t instanceof oc?Sc(this._dataReader,"WriteBatch.update",i._key,t,n,r):Tc(this._dataReader,"WriteBatch.update",i._key,t),this._mutations.push(s.toMutation(i._key,Er.exists(!0))),this}delete(e){this._verifyNotCommitted();var t=yh(e,this._firestore);return this._mutations=this._mutations.concat(new Or(t._key,Er.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,0<this._mutations.length?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new W(H.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function yh(e,t){if((e=p(e)).firestore!==t)throw new W(H.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}class vh extends class{constructor(e,t){this._firestore=e,this._transaction=t,this._dataReader=pc(e)}get(e){const t=yh(e,this._firestore),n=new th(this._firestore);return this._transaction.lookup([t._key]).then((e=>{if(!e||1!==e.length)return $();const r=e[0];if(r.isFoundDocument())return new Fc(this._firestore,n,r.key,r,t.converter);if(r.isNoDocument())return new Fc(this._firestore,n,t._key,null,t.converter);throw $()}))}set(e,t,n){var r=yh(e,this._firestore),i=eh(r.converter,t,n);return i=yc(this._dataReader,"Transaction.set",r._key,i,null!==r.converter,n),this._transaction.set(r._key,i),this}update(e,t,n,...r){var i=yh(e,this._firestore),s="string"==typeof(t=p(t))||t instanceof oc?Sc(this._dataReader,"Transaction.update",i._key,t,n,r):Tc(this._dataReader,"Transaction.update",i._key,t);return this._transaction.update(i._key,s),this}delete(e){var t=yh(e,this._firestore);return this._transaction.delete(t._key),this}}{constructor(e,t){super(e,t),this._firestore=e}get(e){const t=yh(e,this._firestore),n=new oh(this._firestore);return super.get(e).then((e=>new rh(this._firestore,n,t._key,e._document,new nh(!1,!1),t.converter)))}}function wh(e,t){if(void 0===t)return{merge:!1};if(void 0!==t.mergeFields&&void 0!==t.merge)throw new W("invalid-argument",`Invalid options passed to function ${e}(): You cannot specify both "merge" and "mergeFields".`);return t}function _h(){if("undefined"==typeof Uint8Array)throw new W("unimplemented","Uint8Arrays are not available in this environment.")}function bh(){if("undefined"==typeof atob)throw new W("unimplemented","Blobs are unavailable in Firestore in this environment.")}Xu=t.SDK_VERSION,U=Xu,t._registerComponent(new y("firestore",((e,{instanceIdentifier:t,options:n})=>{const r=e.getProvider("app").getImmediate(),i=new tc(new ee(e.getProvider("auth-internal")),new ie(e.getProvider("app-check-internal")),function(e,t){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new W(H.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Bt(e.options.projectId,t)}(r,t),r);return n=Object.assign({useFetchStreams:!0},n),i._setSettings(n),i}),"PUBLIC").setMultipleInstances(!0)),t.registerVersion(P,"4.6.3",void 0),t.registerVersion(P,"4.6.3","esm2017");class Ih{constructor(e){this._delegate=e}static fromBase64String(e){return bh(),new Ih(ac.fromBase64String(e))}static fromUint8Array(e){return _h(),new Ih(ac.fromUint8Array(e))}toBase64(){return bh(),this._delegate.toBase64()}toUint8Array(){return _h(),this._delegate.toUint8Array()}isEqual(e){return this._delegate.isEqual(e._delegate)}toString(){return"Blob(base64: "+this.toBase64()+")"}}function Eh(e){return function(e,t){if("object"==typeof e&&null!==e){var n=e;for(const e of["next","error","complete"])if(e in n&&"function"==typeof n[e])return 1}}(e)}class Th{enableIndexedDbPersistence(e,t){return function(e,t){sc(e=Vu(e,tc));var n=nc(e);if(n._uninitializedComponentsProvider)throw new W(H.FAILED_PRECONDITION,"SDK cache is already specified.");z("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");var r=e._freezeSettings(),i=new du;return ic(n,i,new hu(i,r.cacheSizeBytes,null==t?void 0:t.forceOwnership))}(e._delegate,{forceOwnership:t})}enableMultiTabIndexedDbPersistence(e){return function(e){sc(e=Vu(e,tc));var t=nc(e);if(t._uninitializedComponentsProvider)throw new W(H.FAILED_PRECONDITION,"SDK cache is already specified.");z("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");var n=e._freezeSettings(),r=new du;return ic(t,r,new lu(r,n.cacheSizeBytes))}(e._delegate)}clearIndexedDbPersistence(e){return function(e){if(e._initialized&&!e._terminated)throw new W(H.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const t=new Y;return e._queue.enqueueAndForgetEvenWhileRestricted((async()=>{try{await async function(e){if(!Ne.D())return Promise.resolve();var t=e+"main";await Ne.delete(t)}(pa(e._databaseId,e._persistenceKey)),t.resolve()}catch(e){t.reject(e)}})),t.promise}(e._delegate)}}class Sh{constructor(e,t,n){this._delegate=t,this._persistenceProvider=n,this.INTERNAL={delete:()=>this.terminate()},e instanceof Bt||(this._appCompat=e)}get _databaseId(){return this._delegate._databaseId}settings(e){var t=this._delegate._getSettings();e.merge||t.host===e.host||z("You are overriding the original host. If you did not intend to override your settings, use {merge: true}."),e.merge&&delete(e=Object.assign(Object.assign({},t),e)).merge,this._delegate._setSettings(e)}useEmulator(e,t,n={}){!function(e,t,n,r={}){var i;const s=(e=Vu(e,qu))._getSettings(),a=`${t}:${n}`;if("firestore.googleapis.com"!==s.host&&s.host!==a&&z("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),e._setSettings(Object.assign(Object.assign({},s),{host:a,ssl:!1})),r.mockUserToken){let t,n;if("string"==typeof r.mockUserToken)t=r.mockUserToken,n=V.MOCK_USER;else{t=function(e,t){if(e.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');var n=t||"demo-project",r=e.iat||0,i=e.sub||e.user_id;if(!i)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");return i=Object.assign({iss:`https://securetoken.google.com/${n}`,aud:n,iat:r,exp:r+3600,auth_time:r,sub:i,user_id:i,firebase:{sign_in_provider:"custom",identities:{}}},e),[u(JSON.stringify({alg:"none",type:"JWT"})),u(JSON.stringify(i)),""].join(".")}(r.mockUserToken,null===(i=e._app)||void 0===i?void 0:i.options.projectId);const s=r.mockUserToken.sub||r.mockUserToken.user_id;if(!s)throw new W(H.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new V(s)}e._authCredentials=new Z(new J(t,n))}}(this._delegate,e,t,n)}enableNetwork(){return function(e){return(t=nc(e=Vu(e,tc))).asyncQueue.enqueue((async()=>{const e=await Tu(t),n=await xu(t);return e.setNetworkEnabled(!0),function(e){const t=e;return t.M_.delete(0),so(t)}(n)}));var t}(this._delegate)}disableNetwork(){return function(e){return(t=nc(e=Vu(e,tc))).asyncQueue.enqueue((async()=>{const e=await Tu(t),n=await xu(t);return e.setNetworkEnabled(!1),async function(e){const t=e;t.M_.add(0),await ao(t),t.N_.set("Offline")}(n)}));var t}(this._delegate)}enablePersistence(e){let t=!1,n=!1;return e&&(t=!!e.synchronizeTabs,n=!!e.experimentalForceOwningTab,Lu("synchronizeTabs",t,"experimentalForceOwningTab",n)),t?this._persistenceProvider.enableMultiTabIndexedDbPersistence(this):this._persistenceProvider.enableIndexedDbPersistence(this,n)}clearPersistence(){return this._persistenceProvider.clearIndexedDbPersistence(this)}terminate(){return this._appCompat&&(this._appCompat._removeServiceInstance("firestore-compat"),this._appCompat._removeServiceInstance("firestore")),this._delegate._delete()}waitForPendingWrites(){return function(e){return function(e){const t=new Y;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t){const n=e;go(n.remoteStore)||j("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const e=await function(e){const t=e;return t.persistence.runTransaction("Get highest unacknowledged batch id","readonly",(e=>t.mutationQueue.getHighestUnacknowledgedBatchId(e)))}(n.localStore);if(-1===e)return void t.resolve();const r=n.Oa.get(e)||[];r.push(t),n.Oa.set(e,r)}catch(e){const n=Do(e,"Initialization of waitForPendingWrites() operation failed");t.reject(n)}}(await Du(e),t))),t.promise}(nc(e=Vu(e,tc)))}(this._delegate)}onSnapshotsInSync(e){return function(e,t){return function(e,t){const n=new gu(t);return e.asyncQueue.enqueueAndForget((async()=>function(e,t){e.z_.add(t),t.next()}(await Cu(e),n))),()=>{n.$a(),e.asyncQueue.enqueueAndForget((async()=>function(e,t){e.z_.delete(t)}(await Cu(e),n)))}}(nc(e=Vu(e,tc)),Yu(t)?t:{next:t})}(this._delegate,e)}get app(){if(!this._appCompat)throw new W("failed-precondition","Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._appCompat}collection(e){try{return new Uh(this,Ku(this._delegate,e))}catch(e){throw kh(e,"collection()","Firestore.collection()")}}doc(e){try{return new Nh(this,$u(this._delegate,e))}catch(e){throw kh(e,"doc()","Firestore.doc()")}}collectionGroup(e){try{return new Fh(this,function(e,t){if(e=Vu(e,qu),Mu("collectionGroup","collection id",t),0<=t.indexOf("/"))throw new W(H.INVALID_ARGUMENT,`Invalid collection ID '${t}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new ju(e,null,new Pn(de.emptyPath(),t))}(this._delegate,e))}catch(e){throw kh(e,"collectionGroup()","Firestore.collectionGroup()")}}runTransaction(e){return function(e,t,n){e=Vu(e,tc);var r=Object.assign(Object.assign({},mh),void 0);return function(e){if(e.maxAttempts<1)throw new W(H.INVALID_ARGUMENT,"Max attempts must be at least 1")}(r),function(e,t,n){const r=new Y;return e.asyncQueue.enqueueAndForget((async()=>{var i=await Eu(e).then((e=>e.datastore));new yu(e.asyncQueue,i,n,t,r).Xa()})),r.promise}(nc(e),(n=>t(new vh(e,n))),r)}(this._delegate,(t=>e(new Dh(this,t))))}batch(){return nc(this._delegate),new Ch(new ph(this._delegate,(e=>fh(this._delegate,e))))}loadBundle(e){return n=nc(t=Vu(t=this._delegate,tc)),r=new Ju,function(e,t,n,r){const i=(t=Ja(t),n=function(e,t){if(e instanceof Uint8Array)return fu(e,t);if(e instanceof ArrayBuffer)return fu(new Uint8Array(e),t);if(e instanceof ReadableStream)return e.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}("string"==typeof n?Gr().encode(n):n),new mu(n,t));e.asyncQueue.enqueueAndForget((async()=>{!function(e,t,n){const r=e;(async function(e,t,n){try{var r=await t.getMetadata();if(await function(e,t){const n=e,r=li(t.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",(e=>n.$r.getBundleMetadata(e,t.id))).then((e=>!!e&&0<=e.createTime.compareTo(r)))}(e.localStore,r))return await t.close(),n._completeWith({taskState:"Success",documentsLoaded:r.totalDocuments,bytesLoaded:r.totalBytes,totalDocuments:r.totalDocuments,totalBytes:r.totalBytes}),Promise.resolve(new Set);n._updateProgress(Bo(r));const s=new Uo(r,e.localStore,t.serializer);let a=await t.qa();for(;a;){const e=await s._a(a);e&&n._updateProgress(e),a=await t.qa()}var i=await s.complete();return await iu(e,i.ca,void 0),await function(e,t){const n=e;return n.persistence.runTransaction("Save bundle","readwrite",(e=>n.$r.saveBundleMetadata(e,t)))}(e.localStore,r),n._completeWith(i.progress),Promise.resolve(i.ua)}catch(e){return z("SyncEngine",`Loading bundle failed with ${e}`),n._failWith(e),Promise.resolve(new Set)}})(r,t,n).then((e=>{r.sharedClientState.notifyBundleLoaded(e)}))}(await Du(e),i,r)}))}(n,t._databaseId,e,r),r;var t,n,r}namedQuery(e){return function(e,t){return n=nc(e=Vu(e,tc)),r=t,n.asyncQueue.enqueue((async()=>function(e,t){const n=e;return n.persistence.runTransaction("Get named query","readonly",(e=>n.$r.getNamedQuery(e,t)))}(await Su(n),r))).then((t=>t?new ju(e,null,t.query):null));var n,r}(this._delegate,e).then((e=>e?new Fh(this,e):null))}}class xh extends Zc{constructor(e){super(),this.firestore=e}convertBytes(e){return new Ih(new ac(e))}convertReference(e){var t=this.convertDocumentKey(e,this.firestore._databaseId);return Nh.forKey(t,this.firestore,null)}}class Dh{constructor(e,t){this._firestore=e,this._delegate=t,this._userDataWriter=new xh(e)}get(e){const t=Bh(e);return this._delegate.get(t).then((e=>new Lh(this._firestore,new rh(this._firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,t.converter))))}set(e,t,n){var r=Bh(e);return n?(wh("Transaction.set",n),this._delegate.set(r,t,n)):this._delegate.set(r,t),this}update(e,t,n,...r){var i=Bh(e);return 2===arguments.length?this._delegate.update(i,t):this._delegate.update(i,t,n,...r),this}delete(e){var t=Bh(e);return this._delegate.delete(t),this}}class Ch{constructor(e){this._delegate=e}set(e,t,n){var r=Bh(e);return n?(wh("WriteBatch.set",n),this._delegate.set(r,t,n)):this._delegate.set(r,t),this}update(e,t,n,...r){var i=Bh(e);return 2===arguments.length?this._delegate.update(i,t):this._delegate.update(i,t,n,...r),this}delete(e){var t=Bh(e);return this._delegate.delete(t),this}commit(){return this._delegate.commit()}}class Ah{constructor(e,t,n){this._firestore=e,this._userDataWriter=t,this._delegate=n}fromFirestore(e,t){var n=new ih(this._firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,null);return this._delegate.fromFirestore(new Oh(this._firestore,n),null!=t?t:{})}toFirestore(e,t){return t?this._delegate.toFirestore(e,t):this._delegate.toFirestore(e)}static getInstance(e,t){const n=Ah.INSTANCES;let r=n.get(e);r||(r=new WeakMap,n.set(e,r));let i=r.get(t);return i||(i=new Ah(e,new xh(e),t),r.set(t,i)),i}}Ah.INSTANCES=new WeakMap;class Nh{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new xh(e)}static forPath(e,t,n){if(e.length%2!=0)throw new W("invalid-argument",`Invalid document reference. Document references must have an even number of segments, but ${e.canonicalString()} has ${e.length}`);return new Nh(t,new Gu(t._delegate,n,new me(e)))}static forKey(e,t,n){return new Nh(t,new Gu(t._delegate,n,e))}get id(){return this._delegate.id}get parent(){return new Uh(this.firestore,this._delegate.parent)}get path(){return this._delegate.path}collection(e){try{return new Uh(this.firestore,Ku(this._delegate,e))}catch(e){throw kh(e,"collection()","DocumentReference.collection()")}}isEqual(e){return(e=p(e))instanceof Gu&&Qu(this._delegate,e)}set(e,t){t=wh("DocumentReference.set",t);try{return t?hh(this._delegate,e,t):hh(this._delegate,e)}catch(e){throw kh(e,"setDoc()","DocumentReference.set()")}}update(e,t,...n){try{return 1===arguments.length?lh(this._delegate,e):lh(this._delegate,e,t,...n)}catch(e){throw kh(e,"updateDoc()","DocumentReference.update()")}}delete(){return fh(Vu((e=this._delegate).firestore,tc),[new Or(e._key,Er.none())]);var e}onSnapshot(...e){var t=Rh(e),n=Mh(e,(e=>new Lh(this.firestore,new rh(this.firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,this._delegate.converter))));return dh(this._delegate,t,n)}get(e){let t;return t=("cache"===(null==e?void 0:e.source)?uh:"server"===(null==e?void 0:e.source)?function(e){e=Vu(e,Gu);const t=Vu(e.firestore,tc);return Au(nc(t),e._key,{source:"server"}).then((n=>gh(t,e,n)))}:function(e){e=Vu(e,Gu);const t=Vu(e.firestore,tc);return Au(nc(t),e._key).then((n=>gh(t,e,n)))})(this._delegate),t.then((e=>new Lh(this.firestore,new rh(this.firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,this._delegate.converter))))}withConverter(e){return new Nh(this.firestore,e?this._delegate.withConverter(Ah.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}function kh(e,t,n){return e.message=e.message.replace(t,n),e}function Rh(e){for(const t of e)if("object"==typeof t&&!Eh(t))return t;return{}}function Mh(e,t){var n;let r;return r=Eh(e[0])?e[0]:Eh(e[1])?e[1]:"function"==typeof e[0]?{next:e[0],error:e[1],complete:e[2]}:{next:e[1],error:e[2],complete:e[3]},{next:e=>{r.next&&r.next(t(e))},error:null===(n=r.error)||void 0===n?void 0:n.bind(r),complete:null===(n=r.complete)||void 0===n?void 0:n.bind(r)}}class Lh{constructor(e,t){this._firestore=e,this._delegate=t}get ref(){return new Nh(this._firestore,this._delegate.ref)}get id(){return this._delegate.id}get metadata(){return this._delegate.metadata}get exists(){return this._delegate.exists()}data(e){return this._delegate.data(e)}get(e,t){return this._delegate.get(e,t)}isEqual(e){return ah(this._delegate,e._delegate)}}class Oh extends Lh{data(e){var t=this._delegate.data(e);return this._delegate._converter||void 0!==t||$(),t}}class Fh{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new xh(e)}where(e,t,n){try{return new Fh(this.firestore,jc(this._delegate,(r=n,i=t,s=Vc("where",e),Gc._create(s,i,r))))}catch(e){throw kh(e,/(orderBy|where)\(\)/,"Query.$1()")}var r,i,s}orderBy(e,t){try{return new Fh(this.firestore,jc(this._delegate,([n,r="asc"]=[e,t],i=r,s=Vc("orderBy",n),Kc._create(s,i))))}catch(e){throw kh(e,/(orderBy|where)\(\)/,"Query.$1()")}var n,r,i,s}limit(e){try{return new Fh(this.firestore,jc(this._delegate,(Uu("limit",t=e),$c._create("limit",t,"F"))))}catch(e){throw kh(e,"limit()","Query.limit()")}var t}limitToLast(e){try{return new Fh(this.firestore,jc(this._delegate,(Uu("limitToLast",t=e),$c._create("limitToLast",t,"L"))))}catch(e){throw kh(e,"limitToLast()","Query.limitToLast()")}var t}startAt(...e){try{return new Fh(this.firestore,jc(this._delegate,function(...e){return Qc._create("startAt",e,!0)}(...e)))}catch(e){throw kh(e,"startAt()","Query.startAt()")}}startAfter(...e){try{return new Fh(this.firestore,jc(this._delegate,function(...e){return Qc._create("startAfter",e,!1)}(...e)))}catch(e){throw kh(e,"startAfter()","Query.startAfter()")}}endBefore(...e){try{return new Fh(this.firestore,jc(this._delegate,function(...e){return Hc._create("endBefore",e,!1)}(...e)))}catch(e){throw kh(e,"endBefore()","Query.endBefore()")}}endAt(...e){try{return new Fh(this.firestore,jc(this._delegate,function(...e){return Hc._create("endAt",e,!0)}(...e)))}catch(e){throw kh(e,"endAt()","Query.endAt()")}}isEqual(e){return Hu(this._delegate,e._delegate)}get(e){let t;return t=("cache"===(null==e?void 0:e.source)?ch:"server"===(null==e?void 0:e.source)?function(e){e=Vu(e,ju);const t=Vu(e.firestore,tc),n=nc(t),r=new oh(t);return Nu(n,e._query,{source:"server"}).then((n=>new sh(t,r,e,n)))}:function(e){e=Vu(e,ju);const t=Vu(e.firestore,tc),n=nc(t),r=new oh(t);return Uc(e._query),Nu(n,e._query).then((n=>new sh(t,r,e,n)))})(this._delegate),t.then((e=>new Vh(this.firestore,new sh(this.firestore._delegate,this._userDataWriter,this._delegate,e._snapshot))))}onSnapshot(...e){var t=Rh(e),n=Mh(e,(e=>new Vh(this.firestore,new sh(this.firestore._delegate,this._userDataWriter,this._delegate,e._snapshot))));return dh(this._delegate,t,n)}withConverter(e){return new Fh(this.firestore,e?this._delegate.withConverter(Ah.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}class Ph{constructor(e,t){this._firestore=e,this._delegate=t}get type(){return this._delegate.type}get doc(){return new Oh(this._firestore,this._delegate.doc)}get oldIndex(){return this._delegate.oldIndex}get newIndex(){return this._delegate.newIndex}}class Vh{constructor(e,t){this._firestore=e,this._delegate=t}get query(){return new Fh(this._firestore,this._delegate.query)}get metadata(){return this._delegate.metadata}get size(){return this._delegate.size}get empty(){return this._delegate.empty}get docs(){return this._delegate.docs.map((e=>new Oh(this._firestore,e)))}docChanges(e){return this._delegate.docChanges(e).map((e=>new Ph(this._firestore,e)))}forEach(e,t){this._delegate.forEach((n=>{e.call(t,new Oh(this._firestore,n))}))}isEqual(e){return ah(this._delegate,e._delegate)}}class Uh extends Fh{constructor(e,t){super(e,t),this.firestore=e,this._delegate=t}get id(){return this._delegate.id}get path(){return this._delegate.path}get parent(){var e=this._delegate.parent;return e?new Nh(this.firestore,e):null}doc(e){try{return new Nh(this.firestore,void 0===e?$u(this._delegate):$u(this._delegate,e))}catch(e){throw kh(e,"doc()","CollectionReference.doc()")}}add(e){return function(e,t){const n=Vu(e.firestore,tc),r=$u(e),i=eh(e.converter,t);return fh(n,[yc(pc(e.firestore),"addDoc",r._key,i,null!==e.converter,{}).toMutation(r._key,Er.exists(!1))]).then((()=>r))}(this._delegate,e).then((e=>new Nh(this.firestore,e)))}isEqual(e){return Qu(this._delegate,e._delegate)}withConverter(e){return new Uh(this.firestore,e?this._delegate.withConverter(Ah.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}function Bh(e){return Vu(e,Gu)}const qh={Firestore:Sh,GeoPoint:cc,Timestamp:ce,Blob:Ih,Transaction:Dh,WriteBatch:Ch,DocumentReference:Nh,DocumentSnapshot:Lh,Query:Fh,QueryDocumentSnapshot:Oh,QuerySnapshot:Vh,CollectionReference:Uh,FieldPath:class e{constructor(...e){this._delegate=new oc(...e)}static documentId(){return new e(ge.keyField().canonicalString())}isEqual(e){return(e=p(e))instanceof oc&&this._delegate._internalPath.isEqual(e._internalPath)}},FieldValue:class e{constructor(e){this._delegate=e}static serverTimestamp(){const t=new _c("serverTimestamp");return t._methodName="FieldValue.serverTimestamp",new e(t)}static delete(){const t=new vc("deleteField");return t._methodName="FieldValue.delete",new e(t)}static arrayUnion(...t){const n=function(...e){return new bc("arrayUnion",e)}(...t);return n._methodName="FieldValue.arrayUnion",new e(n)}static arrayRemove(...t){const n=function(...e){return new Ic("arrayRemove",e)}(...t);return n._methodName="FieldValue.arrayRemove",new e(n)}static increment(t){const n=new Ec("increment",t);return n._methodName="FieldValue.increment",new e(n)}isEqual(e){return this._delegate.isEqual(e._delegate)}},setLogLevel:function(e){B.setLogLevel(e)},CACHE_SIZE_UNLIMITED:-1};Zu=i.default,ec=(e,t)=>new Sh(e,t,new Th),Zu.INTERNAL.registerComponent(new y("firestore-compat",(e=>{var t=e.getProvider("app-compat").getImmediate(),n=e.getProvider("firestore").getImmediate();return ec(t,n)}),"PUBLIC").setServiceProps(Object.assign({},qh))),Zu.registerVersion("@firebase/firestore-compat","0.3.32")}).apply(this,arguments)}catch(e){throw console.error(e),new Error("Cannot instantiate firebase-firestore-compat.js - be sure to load firebase-app.js first.")}}));